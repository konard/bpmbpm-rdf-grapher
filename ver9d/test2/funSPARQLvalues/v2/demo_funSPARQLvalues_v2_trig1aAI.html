<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Демо: funSPARQLvalues (исправлено) с TriG</title>
    <!-- Подключаем N3.js -->
    <script src="https://cdn.jsdelivr.net/npm/n3@1.16.2/browser/n3.min.js"></script>
    <!-- Подключаем сам файл с функциями (предполагается, что он лежит рядом) -->
    <script src="vadlib_sparql.js"></script>
</head>
<body>
    <h1>Демонстрация функции funSPARQLvalues (исправленная версия)</h1>
    <p>Синхронное выполнение простого SELECT-запроса. Данные загружены из формата TriG.</p>
    <hr>
    <h2>Исходные данные (TriG с префиксами)</h2>
    <pre id="data"></pre>
    <h2>SPARQL запрос</h2>
    <pre id="query"></pre>
    <h2>Результат</h2>
    <pre id="result"></pre>

    <script>
        (async function() {
            const store = new N3.Store();

            // Данные в формате TriG с префиксами
            const trigData = `
                @prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
                @prefix ex: <http://example.org/> .

                ex:graph1 {
                    ex:Alice rdf:type ex:Person .
                    ex:Alice ex:label22 "Alice" .
                }

                ex:graph2 {
                    ex:Bob rdf:type ex:Person .
                    ex:Bob ex:label22 "Bob" .
                }

                # Default graph
                {
                    ex:Charlie rdf:type ex:Person .
                }
            `;

            // Отображаем исходные данные (саму TriG-строку)
            document.getElementById('data').textContent = trigData;

            // SPARQL запрос (с использованием префиксов)
            const sparqlQuery = `
               prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> 
               prefix ex: <http://example.org/> 

                SELECT ?person ?label WHERE {
                    GRAPH ?g {
                        ?person rdf:type ex:Person .
                        ?person ex:label22 ?label .
                    }
                }
            `;
            document.getElementById('query').textContent = sparqlQuery;

            // Парсинг TriG и наполнение store (асинхронно)
            const parser = new N3.Parser({ format: 'text/trig' });

            // Используем колбэк завершения парсинга, чтобы выполнить запрос после загрузки всех данных
            parser.parse(trigData, (error, quad) => {
                if (error) {
                    document.getElementById('result').textContent = 'Ошибка парсинга: ' + error.message;
                    return;
                }
                if (quad) {
                    // Добавляем каждый квад в хранилище
                    store.addQuad(quad);
                } else {
                    // Парсинг завершён (quad === null) — можно выполнять запрос
                    // Устанавливаем глобальные переменные, необходимые для vadlib_sparql.js
                    window.currentStore = store;
                    window.currentPrefixes = {
                        'rdf': 'http://www.w3.org/1999/02/22-rdf-syntax-ns#',
                        'ex': 'http://example.org/'
                    };

                    try {
                        // Вызываем funSPARQLvalues (синхронно)
                        const results = funSPARQLvalues(sparqlQuery, 'person');
                        document.getElementById('result').textContent = 
                            results.length === 0 ? 'Нет результатов' : JSON.stringify(results, null, 2);
                    } catch (e) {
                        document.getElementById('result').textContent = 'Ошибка при выполнении запроса: ' + e.message;
                    }
                }
            });
        })();
    </script>
    <hr>
    <p><strong>Исправление:</strong> Теперь запрос выполняется только после полной загрузки данных из TriG (в колбэке завершения парсинга). Это гарантирует, что хранилище содержит все квады к моменту вызова <code>funSPARQLvalues</code>.</p>
</body>
</html>