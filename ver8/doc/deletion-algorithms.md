# Алгоритмы удаления (Del Concept\Individ)

## Содержание
1. [Общее описание](#общее-описание)
2. [Типы операций удаления](#типы-операций-удаления)
3. [Алгоритм удаления концепта процесса](#1-алгоритм-удаления-концепта-процесса)
4. [Алгоритм удаления концепта исполнителя](#2-алгоритм-удаления-концепта-исполнителя)
5. [Алгоритм удаления индивида процесса](#3-алгоритм-удаления-индивида-процесса)
6. [Алгоритм удаления индивида исполнителя](#4-алгоритм-удаления-индивида-исполнителя)
7. [Алгоритм удаления схемы процесса (TriG)](#5-алгоритм-удаления-схемы-процесса-trig)
8. [Последовательность удаления](#последовательность-удаления)
9. [Сообщения об ошибках](#сообщения-об-ошибках)
10. [Замечания и предложения](#замечания-и-предложения)

---

## Общее описание

Кнопка **"Del Concept\Individ"** предоставляет интерфейс для удаления существующих концептов и индивидов в системе VAD (Value Added Chain Diagram). Функциональность аналогична кнопке "New Concept", но выполняет обратную операцию.

### Принцип работы
1. Пользователь выбирает тип операции удаления из выпадающего списка
2. Система формирует промежуточные SPARQL-запросы для проверки зависимостей
3. Результат выводится в окно "Result in SPARQL"
4. Пользователь может просмотреть промежуточный SPARQL через кнопку "Промежуточный SPARQL"
5. Выполнение SPARQL-запроса производится отдельно через кнопку "Применить как Simple Triple" или "Применить как Shorthand Triple"

---

## Типы операций удаления

| Тип операции | Описание | Граф |
|--------------|----------|------|
| Удалить концепт процесса | Удаление объекта типа `vad:TypeProcess` | `vad:ptree` |
| Удалить концепт исполнителя | Удаление объекта типа `vad:TypeExecutor` | `vad:rtree` |
| Удалить индивид процесса | Удаление всех триплетов с subject индивида | `vad:VADProcessDia` (любой) |
| Удалить индивид исполнителя | Удаление `vad:includes` для исполнителя | `vad:VADProcessDia` (любой) |
| Удалить схему процесса (TriG) | Удаление `vad:VADProcessDia` и связи `vad:hasTrig` | Целый граф + `vad:ptree` |

---

## 1. Алгоритм удаления концепта процесса

### Входные данные
- ID концепта процесса (например, `vad:Process1`)

### Проверки перед удалением

#### 1.1. Проверка существования концепта
```sparql
ASK {
    GRAPH vad:ptree {
        ?process rdf:type vad:TypeProcess .
        FILTER (?process = <ProcessId>)
    }
}
```

#### 1.2. Проверка наличия индивидов процесса
```sparql
SELECT ?trig ?process WHERE {
    GRAPH ?trig {
        ?process vad:isSubprocessTrig ?trig .
        FILTER (?process = <ProcessId>)
    }
}
```

#### 1.3. Проверка наличия индивидов исполнителя (задействованных в процессе)
```sparql
SELECT ?trig ?executor WHERE {
    GRAPH ?trig {
        ?group vad:includes ?executor .
        ?process vad:hasExecutor ?group .
        FILTER (?process = <ProcessId>)
    }
}
```

#### 1.4. Проверка наличия схемы процесса (TriG)
```sparql
SELECT ?trig WHERE {
    GRAPH vad:ptree {
        ?process vad:hasTrig ?trig .
        FILTER (?process = <ProcessId>)
    }
}
```

#### 1.5. Проверка наличия дочерних процессов (через vad:hasParentObj)
```sparql
SELECT ?childProcess WHERE {
    GRAPH vad:ptree {
        ?childProcess vad:hasParentObj ?process .
        FILTER (?process = <ProcessId>)
    }
}
```

### Условия блокировки удаления
- **Блокировка**: Если найден хотя бы один индивид процесса, индивид исполнителя или схема процесса
  - **Сообщение**: "Удаление невозможно. Вначале удалите все индивиды процесса и схему процесса, затем повторите операцию удаления концепта."
- **Блокировка**: Если найдены дочерние процессы
  - **Сообщение**: "Удаление невозможно. Обнаружены дочерние процессы: [список]. Предварительно откорректируйте vad:hasParentObj в дочерних процессах."

### SPARQL-запрос на удаление
```sparql
DELETE DATA {
    GRAPH vad:ptree {
        <ProcessId> rdf:type vad:TypeProcess .
        <ProcessId> rdfs:label "Label" .
        <ProcessId> dcterms:description "Description" .
        # Все остальные триплеты с данным subject
    }
}
```

---

## 2. Алгоритм удаления концепта исполнителя

### Входные данные
- ID концепта исполнителя (например, `vad:Executor1`)

### Проверки перед удалением

#### 2.1. Проверка существования концепта
```sparql
ASK {
    GRAPH vad:rtree {
        ?executor rdf:type vad:TypeExecutor .
        FILTER (?executor = <ExecutorId>)
    }
}
```

#### 2.2. Проверка использования исполнителя в индивидах (через vad:includes)
```sparql
SELECT ?trig ?group WHERE {
    GRAPH ?trig {
        ?trig rdf:type vad:VADProcessDia .
        ?group vad:includes <ExecutorId> .
    }
}
```

### Условия блокировки удаления
- **Блокировка**: Если исполнитель используется в каком-либо TriG
  - **Сообщение**: "Удаление невозможно. Исполнитель задействован в следующих схемах процессов: [список TriG]. Вначале удалите индивиды исполнителя."

### SPARQL-запрос на удаление
```sparql
DELETE DATA {
    GRAPH vad:rtree {
        <ExecutorId> rdf:type vad:TypeExecutor .
        <ExecutorId> rdfs:label "Label" .
        # Все остальные триплеты с данным subject
    }
}
```

---

## 3. Алгоритм удаления индивида процесса

### Входные данные
- ID концепта процесса (из ptree)

### Этапы работы

#### 3.1. Выбор концепта процесса
После выбора "Удалить индивид процесса" пользователь выбирает ID (label) процесса из выпадающего списка (данные из ptree).

#### 3.2. Кнопка "Показать индивиды"
Формирует и выполняет запрос для отображения всех индивидов данного процесса:
```sparql
SELECT ?trig ?process WHERE {
    GRAPH ?trig {
        ?trig rdf:type vad:VADProcessDia .
        ?process vad:isSubprocessTrig ?trig .
        FILTER (?process = <ProcessId>)
    }
}
```

#### 3.3. Кнопка "Удалить индивиды"
Формирует SPARQL-запрос на удаление **всех триплетов**, которые имеют subject с ID удаляемого индивида процесса:
```sparql
DELETE DATA {
    GRAPH <TriGId> {
        <ProcessId> vad:isSubprocessTrig <TriGId> .
        <ProcessId> vad:hasExecutor <ExecutorGroupId> .
        <ProcessId> vad:processSubtype <Subtype> .
        <ProcessId> vad:hasNext <NextProcess> .
        # Все остальные триплеты с данным subject
    }
}
```

### Особенности
- Удаление индивида процесса НЕ затрагивает концепт процесса в ptree
- При удалении также удаляются связанные группы исполнителей (ExecutorGroup)

---

## 4. Алгоритм удаления индивида исполнителя

### Входные данные
- ID концепта исполнителя (из rtree)

### Этапы работы

#### 4.1. Выбор концепта исполнителя
После выбора "Удалить индивид исполнителя" пользователь выбирает ID (label) исполнителя из выпадающего списка (данные из rtree).

#### 4.2. Кнопка "Показать индивиды"
Формирует и выполняет запрос для отображения всех схем процессов, где указан данный исполнитель:
```sparql
SELECT ?trig ?group WHERE {
    GRAPH ?trig {
        ?trig rdf:type vad:VADProcessDia .
        ?group vad:includes <ExecutorId> .
    }
}
```

#### 4.3. Кнопка "Удалить индивиды"
Формирует SPARQL-запрос на удаление утверждений `vad:includes` для данного исполнителя:
```sparql
DELETE DATA {
    GRAPH <TriGId1> {
        <ExecutorGroup1> vad:includes <ExecutorId> .
    }
}
DELETE DATA {
    GRAPH <TriGId2> {
        <ExecutorGroup2> vad:includes <ExecutorId> .
    }
}
# ... для каждого найденного TriG
```

### Особенности
- Удаляется только предикат `vad:includes` для данного исполнителя
- Предикаты `vad:includes` для других исполнителей в тех же группах остаются
- Концепт исполнителя в rtree НЕ затрагивается

---

## 5. Алгоритм удаления схемы процесса (TriG)

### Входные данные
- ID схемы процесса (TriG)

### Этапы работы

#### 5.1. Выбор схемы процесса
После выбора "Удалить схему процесса" пользователь выбирает TriG из выпадающего списка (только TriG типа `vad:VADProcessDia`).

#### 5.2. Формирование SPARQL-запроса
Запрос должен удалить:
1. Весь граф `vad:VADProcessDia`
2. Связь `vad:hasTrig` в концепте процесса (в ptree)

```sparql
# Удаление всего графа
DROP GRAPH <TriGId>
```

```sparql
# Удаление связи в ptree
DELETE DATA {
    GRAPH vad:ptree {
        <ProcessId> vad:hasTrig <TriGId> .
    }
}
```

### Особенности
- При удалении схемы удаляются все индивиды процессов и исполнителей внутри неё
- Концепты процессов и исполнителей в ptree и rtree НЕ затрагиваются

---

## Последовательность удаления

Для корректного удаления без нарушения целостности данных рекомендуется следующая последовательность:

### Полное удаление процесса
1. **Удалить индивиды исполнителей** в схемах процесса
2. **Удалить индивиды процессов** в схемах процесса
3. **Удалить схему процесса** (TriG)
4. **Удалить концепт процесса** из ptree

### Полное удаление исполнителя
1. **Удалить индивиды исполнителя** из всех схем
2. **Удалить концепт исполнителя** из rtree

### Диаграмма зависимостей
```
vad:ptree (концепты процессов)
    └── vad:TypeProcess
            └── vad:hasTrig --> vad:VADProcessDia (схема)
                                    ├── vad:TypeProcess (индивид)
                                    │       └── vad:hasExecutor --> vad:ExecutorGroup
                                    │                                   └── vad:includes --> vad:TypeExecutor
                                    └── ...

vad:rtree (концепты исполнителей)
    └── vad:TypeExecutor
            └── (используется в vad:includes)
```

---

## Сообщения об ошибках

### Общие ошибки
| Код | Сообщение | Контекст |
|-----|-----------|----------|
| ERR_001 | "Выберите тип операции удаления" | Не выбран тип операции |
| ERR_002 | "Выберите элемент для удаления" | Не выбран ID элемента |
| ERR_003 | "Элемент не найден в данных" | Элемент не существует |

### Ошибки удаления концепта процесса
| Код | Сообщение | Контекст |
|-----|-----------|----------|
| ERR_PC_001 | "Удаление невозможно. Вначале удалите все индивиды процесса и схему процесса." | Найдены индивиды или схема |
| ERR_PC_002 | "Удаление невозможно. Обнаружены дочерние процессы: {список}. Откорректируйте vad:hasParentObj." | Найдены дочерние процессы |

### Ошибки удаления концепта исполнителя
| Код | Сообщение | Контекст |
|-----|-----------|----------|
| ERR_EC_001 | "Удаление невозможно. Исполнитель задействован в схемах: {список}. Вначале удалите индивиды исполнителя." | Исполнитель используется в TriG |

### Ошибки удаления индивидов
| Код | Сообщение | Контекст |
|-----|-----------|----------|
| ERR_IP_001 | "Индивиды процесса не найдены" | Нет индивидов для удаления |
| ERR_IE_001 | "Индивиды исполнителя не найдены" | Нет индивидов для удаления |

### Ошибки удаления схемы
| Код | Сообщение | Контекст |
|-----|-----------|----------|
| ERR_SC_001 | "Схема процесса не найдена" | TriG не существует |

---

## Замечания и предложения

### Потенциальные риски

#### 1. Нарушение ссылочной целостности
**Проблема**: При удалении концепта процесса могут остаться "висящие" ссылки в других частях данных (например, `vad:hasNext` указывающий на удаленный процесс).

**Рекомендация**: Добавить проверку на наличие ссылок на удаляемый процесс через предикаты `vad:hasNext`, `vad:isSubprocessTrig` и другие.

```sparql
SELECT ?trig ?subject ?predicate WHERE {
    GRAPH ?trig {
        ?subject ?predicate <ProcessId> .
    }
}
```

#### 2. Несогласованность TreeView
**Проблема**: Удаление элементов может нарушить иерархию отображения в дереве (TreeView), особенно при удалении родительских процессов.

**Рекомендация**: При удалении элемента с `vad:hasParentObj` предложить пользователю выбрать нового родителя для дочерних элементов или переместить их на верхний уровень.

#### 3. Каскадное удаление
**Проблема**: Текущая реализация не поддерживает каскадное удаление (удаление всех зависимых элементов автоматически).

**Рекомендация**: Добавить опцию "Каскадное удаление" с предупреждением о том, какие элементы будут удалены. Пользователь должен явно подтвердить такую операцию.

#### 4. Отмена операции (Undo)
**Проблема**: После применения SPARQL-запроса на удаление нет возможности отменить операцию.

**Рекомендация**:
- Сохранять состояние RDF данных перед каждой операцией удаления
- Добавить кнопку "Отменить последнее изменение"
- Или использовать механизм версионирования данных

#### 5. Синхронизация с визуализацией
**Проблема**: После удаления элементов граф автоматически не обновляется.

**Рекомендация**: После успешного применения DELETE-запроса автоматически обновлять визуализацию или выводить напоминание пользователю.

### Дополнительные предложения

#### 1. Предпросмотр удаления
Перед выполнением операции показывать пользователю полный список элементов, которые будут затронуты удалением.

#### 2. Журнал операций
Вести журнал всех операций удаления для возможности аудита и восстановления.

#### 3. Подтверждение удаления
Для критических операций (удаление концептов, схем) требовать дополнительное подтверждение от пользователя.

#### 4. Проверка дочерних TriG
При удалении схемы процесса проверять наличие дочерних TriG (через `vad:hasParentTrig`) и предупреждать пользователя.

```sparql
SELECT ?childTrig WHERE {
    GRAPH ?childTrig {
        ?childTrig vad:hasParentTrig <TriGId> .
    }
}
```

---

## История изменений

| Версия | Дата | Описание |
|--------|------|----------|
| 1.0 | 2026-01-29 | Первоначальная версия документа |
