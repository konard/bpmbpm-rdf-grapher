{"version":3,"file":"VoidMetadataEmitter.js","sourceRoot":"","sources":["VoidMetadataEmitter.ts"],"names":[],"mappings":"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","sourcesContent":["/* eslint-disable import/no-nodejs-modules,ts/no-require-imports,ts/no-var-requires */\nimport type * as http from 'node:http';\nimport type { Writable } from 'node:stream';\nimport type * as RDF from '@rdfjs/types';\n\nimport type { QueryEngineBase } from '..';\n\nconst quad = require('rdf-quad');\n\n/**\n * A VoID metadata emitter that emits metadata used in VoID description of the HTTP service sparql endpoint.\n */\nexport class VoidMetadataEmitter {\n  private static readonly STRING_LITERALS = new Set([\n    'alternative',\n    'description',\n    'title',\n  ]);\n\n  private static readonly DATE_LITERALS = new Set([\n    'available',\n    'created',\n    'date',\n    'dateAccepted',\n    'dateCopyrighted',\n    'dateSubmitted',\n    'issued',\n    'modified',\n    'valid',\n  ]);\n\n  public readonly context: any;\n  public cachedStatistics: RDF.Quad[] = [];\n\n  public constructor(\n    context: any,\n  ) {\n    this.context = context;\n  }\n\n  public invalidateCache(): void {\n    this.cachedStatistics = [];\n  }\n\n  /**\n   * Returns a list of all necessary VoID quads.\n   * @param {QueryEngineBase} engine A SPARQL engine.\n   * @param {module:stream.internal.Writable} stdout\n   * @param {module:http.IncomingMessage} request\n   * @param {module:http.ServerResponse} response\n   */\n  public async getVoIDQuads(\n    engine: QueryEngineBase,\n    stdout: Writable,\n    request: http.IncomingMessage,\n    response: http.ServerResponse,\n  ): Promise<RDF.Quad[]> {\n    const s = request.url;\n    const sd = 'http://www.w3.org/ns/sparql-service-description#';\n    const vd = 'http://rdfs.org/ns/void#';\n    const rdf = 'http://www.w3.org/1999/02/22-rdf-syntax-ns#';\n    const rdfType = `${rdf}type`;\n    const dataset = '_:defaultDataset';\n    const graph = '_:defaultGraph';\n    const vocabulary = `${vd}vocabulary`;\n    const dcterms = 'http://purl.org/dc/terms/';\n    const quads: RDF.Quad[] = [\n      quad(s, `${sd}defaultDataset`, dataset),\n      quad(dataset, rdfType, `${sd}Dataset`),\n\n      // Basic VoID metadata\n      quad(dataset, rdfType, `${vd}Dataset`),\n      quad(dataset, `${vd}sparqlEndpoint`, '/sparql'),\n    ];\n\n    // Dublin Core Metadata Terms\n    if (this.context.dcterms) {\n      quads.push(quad(dataset, vocabulary, dcterms));\n      for (const key in this.context.dcterms) {\n        quads.push(quad(dataset, `${dcterms}${key}`, this.convertValue(key, this.context.dcterms[key])));\n      }\n    }\n\n    // Statistics\n\n    // Default graph for statistics\n    quads.push(quad(dataset, `${sd}defaultGraph`, graph));\n    quads.push(quad(graph, rdfType, `${sd}Graph`));\n\n    if (this.cachedStatistics.length === 0) {\n      try {\n        await this.fetchVoIDStatistics(engine);\n      } catch (error: any) {\n        stdout.write(`[500] Server error in results: ${error.message} \\n`);\n        response.end('An internal server error occurred.\\n');\n        return [];\n      }\n    }\n\n    for (const q of this.cachedStatistics) {\n      quads.push(q);\n    }\n\n    return quads;\n  }\n\n  private convertValue(\n    key: string,\n    value: string,\n  ): string {\n    if (VoidMetadataEmitter.STRING_LITERALS.has(key)) {\n      return `\"${value}\"`;\n    }\n    if (VoidMetadataEmitter.DATE_LITERALS.has(key)) {\n      return `\"${value}\"^^http://www.w3.org/2001/XMLSchema#date`;\n    }\n    return value;\n  }\n\n  /**\n   * Fetches the necessary VoID statistics quads and assigns them to this.cachedStatistics\n   * @param {QueryEngineBase} engine A SPARQL engine.\n   * @private\n   */\n  private async fetchVoIDStatistics(\n    engine: QueryEngineBase,\n  ): Promise<void> {\n    const vd = 'http://rdfs.org/ns/void#';\n    const rdf = 'http://www.w3.org/1999/02/22-rdf-syntax-ns#';\n    const rdfType = `${rdf}type`;\n    const dataset = '_:defaultDataset';\n    const graph = '_:defaultGraph';\n\n    const [ globalStatistics, classesStatistic, classPartitions, propertyPartitions ] = await Promise.all([\n      engine.queryBindings(\n        `\nSELECT\n  (COUNT(*) AS ?triples)\n  (SUM(IF(isIRI(?s), 1, 0)) AS ?entities)\n  (COUNT(DISTINCT ?s) AS ?distinctSubjects)\n  (COUNT(DISTINCT ?p) AS ?properties)\n  (COUNT(DISTINCT ?o) AS ?distinctObjects)\nWHERE {\n  ?s ?p ?o\n}\n    `,\n        this.context,\n      ),\n      engine.queryBindings(\n        `\nSELECT\n  (COUNT(DISTINCT ?c) AS ?classes)\nWHERE {\n  ?s a ?c\n}\n    `,\n        this.context,\n      ),\n      engine.queryBindings(\n        `\nSELECT ?class (COUNT(*) AS ?count)\nWHERE { ?s a ?class }\nGROUP BY ?class\n    `,\n        this.context,\n      ),\n      engine.queryBindings(\n        `\nSELECT ?property (COUNT(*) AS ?count)\nWHERE { ?s ?property ?o }\nGROUP BY ?property\n    `,\n        this.context,\n      ),\n    ]);\n\n    const xsdInteger = (n: string): string =>\n      `\"${n}\"^^http://www.w3.org/2001/XMLSchema#integer`;\n\n    await Promise.all([\n      (async(): Promise<void> => {\n        for await (const bindings of globalStatistics) {\n          this.cachedStatistics.push(quad(graph, `${vd}triples`, xsdInteger(bindings.get('triples')!.value)));\n          this.cachedStatistics.push(quad(graph, `${vd}entities`, xsdInteger(bindings.get('entities')!.value)));\n          this.cachedStatistics.push(quad(graph, `${vd}distinctSubjects`, xsdInteger(bindings.get('distinctSubjects')!.value)));\n          this.cachedStatistics.push(quad(graph, `${vd}properties`, xsdInteger(bindings.get('properties')!.value)));\n          this.cachedStatistics.push(quad(graph, `${vd}distinctObjects`, xsdInteger(bindings.get('distinctObjects')!.value)));\n        }\n      })(),\n      (async(): Promise<void> => {\n        for await (const bindings of classesStatistic) {\n          this.cachedStatistics.push(quad(graph, `${vd}classes`, xsdInteger(bindings.get('classes')!.value)));\n        }\n      })(),\n      (async(): Promise<void> => {\n        let i = 0;\n        for await (const bindings of classPartitions) {\n          const classPartition = `_:classPartition${i}`;\n          this.cachedStatistics.push(quad(dataset, `${vd}classPartition`, classPartition));\n          this.cachedStatistics.push(quad(classPartition, rdfType, `${vd}ClassPartition`));\n          this.cachedStatistics.push(quad(classPartition, `${vd}class`, bindings.get('class')!.value));\n          this.cachedStatistics.push(quad(classPartition, `${vd}entities`, xsdInteger(bindings.get('count')!.value)));\n          i++;\n        }\n      })(),\n      (async(): Promise<void> => {\n        let i = 0;\n        for await (const bindings of propertyPartitions) {\n          const propertyPartition = `_:propertyPartition${i}`;\n          this.cachedStatistics.push(quad(dataset, `${vd}propertyPartition`, propertyPartition));\n          this.cachedStatistics.push(quad(propertyPartition, rdfType, `${vd}PropertyPartition`));\n          this.cachedStatistics.push(quad(propertyPartition, `${vd}property`, bindings.get('property')!.value));\n          this.cachedStatistics.push(quad(propertyPartition, `${vd}triples`, xsdInteger(bindings.get('count')!.value)));\n          i++;\n        }\n      })(),\n    ]);\n  }\n}\n"]}