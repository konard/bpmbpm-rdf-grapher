{"version":3,"file":"ActorOptimizeQueryOperationRewriteAdd.js","sourceRoot":"","sources":["ActorOptimizeQueryOperationRewriteAdd.ts"],"names":[],"mappings":";;;AAKA,yFAAqF;AACrF,+DAA0D;AAE1D,yCAA8C;AAE9C,2DAAgF;AAEhF,uDAA+C;AAE/C,MAAM,EAAE,GAAG,IAAI,8BAAW,EAAgB,CAAC;AAE3C;;GAEG;AACH,MAAa,qCAAsC,SAAQ,0DAA2B;IACpF,YAAmB,IAAsC;QACvD,KAAK,CAAC,IAAI,CAAC,CAAC;IACd,CAAC;IAEM,KAAK,CAAC,IAAI,CAAC,OAAsC;QACtD,OAAO,IAAA,mBAAY,GAAE,CAAC;IACxB,CAAC;IAEM,KAAK,CAAC,GAAG,CAAC,MAAqC;QACpD,MAAM,WAAW,GAAwB,MAAM,CAAC,OAAO,CAAC,OAAO,CAAC,+BAAa,CAAC,WAAW,CAAC,CAAC;QAC3F,MAAM,OAAO,GAAG,IAAI,8BAAc,CAAC,WAAW,CAAC,CAAC;QAEhD,MAAM,SAAS,GAAG,4BAAY,CAAC,YAAY,CAAC,MAAM,CAAC,SAAS,EAAE;YAC5D,CAAC,uBAAO,CAAC,KAAK,CAAC,GAAG,CAAC,EAAE;gBACnB,UAAU,EAAE,GAAG,EAAE,CAAC,CAAC,EAAE,QAAQ,EAAE,IAAI,EAAE,CAAC;gBACtC,SAAS,EAAE,CAAC,iBAAiB,EAAE,EAAE;oBAC/B,4EAA4E;oBAC5E,MAAM,WAAW,GAAG,iBAAiB,CAAC,WAAW,KAAK,SAAS,CAAC,CAAC;wBAC/D,EAAE,CAAC,YAAY,EAAE,CAAC,CAAC;wBACnB,iBAAiB,CAAC,WAAW,CAAC;oBAChC,MAAM,MAAM,GAAG,iBAAiB,CAAC,MAAM,KAAK,SAAS,CAAC,CAAC,CAAC,EAAE,CAAC,YAAY,EAAE,CAAC,CAAC,CAAC,iBAAiB,CAAC,MAAM,CAAC;oBAErG,OAAO,OAAO,CAAC,kBAAkB,CAAC,SAAS,EAAE;wBAC3C,OAAO,CAAC,aAAa,CAAC,EAAE,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,EAAE,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,EAAE,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,WAAW,CAAC;qBACzF,EAAE,OAAO,CAAC,aAAa,CAAC,EAAE,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,EAAE,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,EAAE,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,MAAM,CAAC,CAAC,CAAC;gBAC1F,CAAC;aACF;SACF,CAAC,CAAC;QAEH,OAAO,EAAE,SAAS,EAAE,OAAO,EAAE,MAAM,CAAC,OAAO,EAAE,CAAC;IAChD,CAAC;CACF;AAhCD,sFAgCC","sourcesContent":["import type {\n  IActionOptimizeQueryOperation,\n  IActorOptimizeQueryOperationOutput,\n  IActorOptimizeQueryOperationArgs,\n} from '@comunica/bus-optimize-query-operation';\nimport { ActorOptimizeQueryOperation } from '@comunica/bus-optimize-query-operation';\nimport { KeysInitQuery } from '@comunica/context-entries';\nimport type { IActorTest, TestResult } from '@comunica/core';\nimport { passTestVoid } from '@comunica/core';\nimport type { ComunicaDataFactory } from '@comunica/types';\nimport { Algebra, AlgebraFactory, algebraUtils } from '@comunica/utils-algebra';\nimport type * as RDF from '@rdfjs/types';\nimport { DataFactory } from 'rdf-data-factory';\n\nconst DF = new DataFactory<RDF.BaseQuad>();\n\n/**\n * A comunica Rewrite Add Optimize Query Operation Actor.\n */\nexport class ActorOptimizeQueryOperationRewriteAdd extends ActorOptimizeQueryOperation {\n  public constructor(args: IActorOptimizeQueryOperationArgs) {\n    super(args);\n  }\n\n  public async test(_action: IActionOptimizeQueryOperation): Promise<TestResult<IActorTest>> {\n    return passTestVoid();\n  }\n\n  public async run(action: IActionOptimizeQueryOperation): Promise<IActorOptimizeQueryOperationOutput> {\n    const dataFactory: ComunicaDataFactory = action.context.getSafe(KeysInitQuery.dataFactory);\n    const factory = new AlgebraFactory(dataFactory);\n\n    const operation = algebraUtils.mapOperation(action.operation, {\n      [Algebra.Types.ADD]: {\n        preVisitor: () => ({ shortcut: true }),\n        transform: (operationOriginal) => {\n          // CONSTRUCT all quads from the source, and INSERT them into the destination\n          const destination = operationOriginal.destination === 'DEFAULT' ?\n            DF.defaultGraph() :\n            operationOriginal.destination;\n          const source = operationOriginal.source === 'DEFAULT' ? DF.defaultGraph() : operationOriginal.source;\n\n          return factory.createDeleteInsert(undefined, [\n            factory.createPattern(DF.variable('s'), DF.variable('p'), DF.variable('o'), destination),\n          ], factory.createPattern(DF.variable('s'), DF.variable('p'), DF.variable('o'), source));\n        },\n      },\n    });\n\n    return { operation, context: action.context };\n  }\n}\n"]}