{"version":3,"file":"ActorQueryProcessExplainQuery.js","sourceRoot":"","sources":["ActorQueryProcessExplainQuery.ts"],"names":[],"mappings":"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","sourcesContent":["import { ActorQueryProcess } from '@comunica/bus-query-process';\nimport type {\n  IActionQueryProcess,\n  IActorQueryProcessOutput,\n  IActorQueryProcessArgs,\n  IQueryProcessSequential,\n} from '@comunica/bus-query-process';\nimport type { MediatorQuerySerialize } from '@comunica/bus-query-serialize';\nimport { KeysInitQuery } from '@comunica/context-entries';\nimport type { TestResult, IActorTest } from '@comunica/core';\nimport { ActionContextKey, failTest, passTestVoid } from '@comunica/core';\nimport { Algebra, AlgebraFactory, transformer } from '@comunica/utils-algebra';\nimport { getOperationSource } from '@comunica/utils-query-operation';\nimport type * as RDF from '@rdfjs/types';\n\n/**\n * A comunica Explain Query Query Process Actor.\n */\nexport class ActorQueryProcessExplainQuery extends ActorQueryProcess {\n  public readonly queryProcessor: IQueryProcessSequential;\n  public readonly mediatorQuerySerialize: MediatorQuerySerialize;\n\n  public constructor(args: IActorQueryProcessExplainServiceArgs) {\n    super(args);\n    this.queryProcessor = args.queryProcessor;\n    this.mediatorQuerySerialize = args.mediatorQuerySerialize;\n  }\n\n  public async test(action: IActionQueryProcess): Promise<TestResult<IActorTest>> {\n    if ((action.context.get(KeysInitQuery.explain) ??\n      action.context.get(new ActionContextKey('explain'))) !== 'query') {\n      return failTest(`${this.name} can only explain in 'query' mode.`);\n    }\n    return passTestVoid();\n  }\n\n  public async run(action: IActionQueryProcess): Promise<IActorQueryProcessOutput> {\n    // Parse and optimize the query\n    let { operation, context } = await this.queryProcessor.parse(action.query, action.context);\n    ({ operation, context } = await this.queryProcessor.optimize(operation, context));\n\n    // Convert source annotations to SERVICE clauses\n    const AF = new AlgebraFactory();\n    operation = ActorQueryProcessExplainQuery.sourceAnnotationToServices(\n      AF,\n      context.getSafe(KeysInitQuery.dataFactory),\n      operation,\n    );\n\n    // Serialize the operation to a SPARQL query\n    let data: string;\n    if (operation.type === Algebra.Types.UNION) {\n      // This can happen if it was determined during optimization that the query has zero results.\n      data = 'SELECT * WHERE { FILTER(false) }';\n    } else {\n      data = (await this.mediatorQuerySerialize.mediate({\n        queryFormat: { language: 'sparql', version: '1.1' },\n        operation,\n        newlines: true,\n        indentWidth: 2,\n        context,\n      })).query;\n    }\n\n    return {\n      result: {\n        explain: true,\n        type: 'query',\n        data,\n      },\n    };\n  }\n\n  public static sourceAnnotationToServices(\n    algebraFactory: AlgebraFactory,\n    dataFactory: RDF.DataFactory,\n    operation: Algebra.Operation,\n  ): Algebra.Operation {\n    // TODO: The casts below should not be necessary.\n    return <Algebra.Operation> transformer.transformObject(operation, (subOperationUntyped: object) => {\n      const subOperation = <Algebra.Operation> subOperationUntyped;\n      const source = getOperationSource(subOperation);\n      if (source) {\n        return algebraFactory.createService(\n          subOperation,\n          typeof source.source.referenceValue === 'string' ?\n            dataFactory.namedNode(source.source.referenceValue) :\n            dataFactory.namedNode(`comunica:${source.source.referenceValue.constructor.name}`),\n          source.context?.get(KeysInitQuery.lenient),\n        );\n      }\n      return subOperation;\n    });\n  }\n}\n\nexport interface IActorQueryProcessExplainServiceArgs extends IActorQueryProcessArgs {\n  queryProcessor: IQueryProcessSequential;\n  /**\n   * Mediator for serializing queries.\n   */\n  mediatorQuerySerialize: MediatorQuerySerialize;\n}\n"]}