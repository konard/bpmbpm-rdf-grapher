{"version":3,"file":"ActorQuerySourceIdentifyHypermediaSparql.js","sourceRoot":"","sources":["ActorQuerySourceIdentifyHypermediaSparql.ts"],"names":[],"mappings":";;;AASA,yGAEwD;AACxD,+DAA8E;AAE9E,yCAAoD;AAEpD,2DAAyD;AACzD,6EAAmE;AACnE,2DAAwD;AAExD;;GAEG;AACH,MAAa,wCAAyC,SAAQ,yEAAkC;IAC9E,YAAY,CAAe;IAC3B,4BAA4B,CAA+B;IAC3D,sBAAsB,CAAyB;IAC/C,cAAc,CAAU;IACxB,YAAY,CAAU;IACtB,SAAS,CAAS;IAClB,eAAe,CAAU;IACzB,UAAU,CAAa;IACvB,YAAY,CAAS;IACrB,uBAAuB,CAAU;IACjC,+BAA+B,CAAU;IACzC,wBAAwB,CAAS;IAEjD,YAAmB,IAAmD;QACpE,KAAK,CAAC,IAAI,EAAE,QAAQ,CAAC,CAAC;QACtB,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC,YAAY,CAAC;QACtC,IAAI,CAAC,4BAA4B,GAAG,IAAI,CAAC,4BAA4B,CAAC;QACtE,IAAI,CAAC,sBAAsB,GAAG,IAAI,CAAC,sBAAsB,CAAC;QAC1D,IAAI,CAAC,cAAc,GAAG,IAAI,CAAC,cAAc,CAAC;QAC1C,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC,YAAY,CAAC;QACtC,IAAI,CAAC,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC;QAChC,IAAI,CAAC,eAAe,GAAG,OAAO,CAAC,IAAI,CAAC,eAAe,CAAC,CAAC;QACrD,IAAI,CAAC,UAAU,GAAG,IAAI,CAAC,UAAU,CAAC;QAClC,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC,YAAY,CAAC;QACtC,IAAI,CAAC,uBAAuB,GAAG,IAAI,CAAC,uBAAuB,CAAC;QAC5D,IAAI,CAAC,+BAA+B,GAAG,IAAI,CAAC,+BAA+B,CAAC;QAC5E,IAAI,CAAC,wBAAwB,GAAG,IAAI,CAAC,wBAAwB,CAAC;IAChE,CAAC;IAEM,KAAK,CAAC,YAAY,CACvB,MAA4C;QAE5C,IAAI,CAAC,MAAM,CAAC,eAAe,IAAI,CAAC,IAAI,CAAC,eAAe,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,aAAa;YACpF,CAAC,CAAC,IAAI,CAAC,cAAc,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,QAAQ,CAAC,SAAS,CAAC,IAAI,MAAM,CAAC,GAAG,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC,CAAC,EAAE,CAAC;YAChG,OAAO,IAAA,eAAQ,EAAC,SAAS,IAAI,CAAC,IAAI,0EAA0E,CAAC,CAAC;QAChH,CAAC;QACD,OAAO,IAAA,eAAQ,EAAC,EAAE,YAAY,EAAE,CAAC,EAAE,CAAC,CAAC;IACvC,CAAC;IAEM,KAAK,CAAC,GAAG,CAAC,MAA4C;QAC3D,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,OAAO,EAAE,cAAc,MAAM,CAAC,GAAG,uCAAuC,MAAM,CAAC,QAAQ,CAAC,aAAa,IAAI,MAAM,CAAC,GAAG,EAAE,CAAC,CAAC;QAE3I,MAAM,WAAW,GAAwB,MAAM,CAAC,OAAO,CAAC,OAAO,CAAC,+BAAa,CAAC,WAAW,CAAC,CAAC;QAC3F,MAAM,cAAc,GAAG,IAAI,8BAAc,CAAC,WAAW,CAAC,CAAC;QACvD,MAAM,gBAAgB,GAAG,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,oCAAkB,CAAC,YAAY,CAAC,EAAE,MAAM,KAAK,CAAC,CAAC;QAC3F,MAAM,MAAM,GAAG,IAAI,qCAAiB,CAClC,CAAC,MAAM,CAAC,eAAe,IAAI,IAAI,CAAC,eAAe,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC,MAAM,CAAC,QAAQ,CAAC,aAAa,IAAI,MAAM,CAAC,GAAG;QAC3G,iHAAiH;QACjH,MAAM,CAAC,GAAG,EACV,MAAM,CAAC,OAAO,EACd,IAAI,CAAC,YAAY,EACjB,IAAI,CAAC,sBAAsB,EAC3B,IAAI,CAAC,UAAU,EACf,WAAW,EACX,cAAc,EACd,MAAM,wCAAe,CAAC,MAAM,CAAC,IAAI,CAAC,4BAA4B,EAAE,MAAM,CAAC,OAAO,EAAE,WAAW,CAAC,EAC5F,IAAI,CAAC,YAAY,EACjB,IAAI,CAAC,SAAS,EACd,IAAI,CAAC,YAAY;QACjB,0EAA0E;QAC1E,IAAI,CAAC,uBAAuB,IAAI,CAAC,gBAAgB,EACjD,IAAI,CAAC,+BAA+B,EACpC,IAAI,CAAC,wBAAwB,EAC7B,OAAO,CAAC,MAAM,CAAC,OAAO,CAAC,GAAG,CAAC,+BAAa,CAAC,wBAAwB,CAAC,CAAC,EACnE,MAAM,CAAC,QAAQ,CAChB,CAAC;QACF,OAAO,EAAE,MAAM,EAAE,CAAC;IACpB,CAAC;CACF;AArED,4FAqEC","sourcesContent":["import type { MediatorHttp } from '@comunica/bus-http';\nimport type { MediatorMergeBindingsContext } from '@comunica/bus-merge-bindings-context';\nimport type { MediatorQuerySerialize } from '@comunica/bus-query-serialize';\nimport type {\n  IActionQuerySourceIdentifyHypermedia,\n  IActorQuerySourceIdentifyHypermediaOutput,\n  IActorQuerySourceIdentifyHypermediaArgs,\n  IActorQuerySourceIdentifyHypermediaTest,\n} from '@comunica/bus-query-source-identify-hypermedia';\nimport {\n  ActorQuerySourceIdentifyHypermedia,\n} from '@comunica/bus-query-source-identify-hypermedia';\nimport { KeysInitQuery, KeysQueryOperation } from '@comunica/context-entries';\nimport type { TestResult } from '@comunica/core';\nimport { failTest, passTest } from '@comunica/core';\nimport type { ComunicaDataFactory } from '@comunica/types';\nimport { AlgebraFactory } from '@comunica/utils-algebra';\nimport { BindingsFactory } from '@comunica/utils-bindings-factory';\nimport { QuerySourceSparql } from './QuerySourceSparql';\n\n/**\n * A comunica SPARQL Query Source Identify Hypermedia Actor.\n */\nexport class ActorQuerySourceIdentifyHypermediaSparql extends ActorQuerySourceIdentifyHypermedia {\n  public readonly mediatorHttp: MediatorHttp;\n  public readonly mediatorMergeBindingsContext: MediatorMergeBindingsContext;\n  public readonly mediatorQuerySerialize: MediatorQuerySerialize;\n  public readonly checkUrlSuffix: boolean;\n  public readonly forceHttpGet: boolean;\n  public readonly cacheSize: number;\n  public readonly forceSourceType: boolean;\n  public readonly bindMethod: BindMethod;\n  public readonly countTimeout: number;\n  public readonly cardinalityCountQueries: boolean;\n  public readonly cardinalityEstimateConstruction: boolean;\n  public readonly forceGetIfUrlLengthBelow: number;\n\n  public constructor(args: IActorQuerySourceIdentifyHypermediaSparqlArgs) {\n    super(args, 'sparql');\n    this.mediatorHttp = args.mediatorHttp;\n    this.mediatorMergeBindingsContext = args.mediatorMergeBindingsContext;\n    this.mediatorQuerySerialize = args.mediatorQuerySerialize;\n    this.checkUrlSuffix = args.checkUrlSuffix;\n    this.forceHttpGet = args.forceHttpGet;\n    this.cacheSize = args.cacheSize;\n    this.forceSourceType = Boolean(args.forceSourceType);\n    this.bindMethod = args.bindMethod;\n    this.countTimeout = args.countTimeout;\n    this.cardinalityCountQueries = args.cardinalityCountQueries;\n    this.cardinalityEstimateConstruction = args.cardinalityEstimateConstruction;\n    this.forceGetIfUrlLengthBelow = args.forceGetIfUrlLengthBelow;\n  }\n\n  public async testMetadata(\n    action: IActionQuerySourceIdentifyHypermedia,\n  ): Promise<TestResult<IActorQuerySourceIdentifyHypermediaTest>> {\n    if (!action.forceSourceType && !this.forceSourceType && !action.metadata.sparqlService &&\n      !(this.checkUrlSuffix && (action.url.endsWith('/sparql') || action.url.endsWith('/sparql/')))) {\n      return failTest(`Actor ${this.name} could not detect a SPARQL service description or URL ending on /sparql.`);\n    }\n    return passTest({ filterFactor: 1 });\n  }\n\n  public async run(action: IActionQuerySourceIdentifyHypermedia): Promise<IActorQuerySourceIdentifyHypermediaOutput> {\n    this.logInfo(action.context, `Identified ${action.url} as sparql source with service URL: ${action.metadata.sparqlService || action.url}`);\n\n    const dataFactory: ComunicaDataFactory = action.context.getSafe(KeysInitQuery.dataFactory);\n    const algebraFactory = new AlgebraFactory(dataFactory);\n    const isSingularSource = action.context.get(KeysQueryOperation.querySources)?.length === 1;\n    const source = new QuerySourceSparql(\n      (action.forceSourceType ?? this.forceSourceType) ? action.url : action.metadata.sparqlService || action.url,\n      // Pass the original URL as backup, as some endpoints misconfigure their endpoint URL in the service description.\n      action.url,\n      action.context,\n      this.mediatorHttp,\n      this.mediatorQuerySerialize,\n      this.bindMethod,\n      dataFactory,\n      algebraFactory,\n      await BindingsFactory.create(this.mediatorMergeBindingsContext, action.context, dataFactory),\n      this.forceHttpGet,\n      this.cacheSize,\n      this.countTimeout,\n      // Cardinalities can be infinity when we're querying just a single source.\n      this.cardinalityCountQueries && !isSingularSource,\n      this.cardinalityEstimateConstruction,\n      this.forceGetIfUrlLengthBelow,\n      Boolean(action.context.get(KeysInitQuery.parseUnsupportedVersions)),\n      action.metadata,\n    );\n    return { source };\n  }\n}\n\nexport interface IActorQuerySourceIdentifyHypermediaSparqlArgs extends IActorQuerySourceIdentifyHypermediaArgs {\n  /**\n   * The HTTP mediator\n   */\n  mediatorHttp: MediatorHttp;\n  /**\n   * A mediator for creating binding context merge handlers\n   */\n  mediatorMergeBindingsContext: MediatorMergeBindingsContext;\n  /**\n   * Mediator for serializing queries.\n   */\n  mediatorQuerySerialize: MediatorQuerySerialize;\n  /**\n   * If URLs ending with '/sparql' should also be considered SPARQL endpoints.\n   * @default {true}\n   */\n  checkUrlSuffix: boolean;\n  /**\n   * If non-update queries should be sent via HTTP GET instead of POST\n   * @default {false}\n   */\n  forceHttpGet: boolean;\n  /**\n   * The cache size for COUNT queries.\n   * @range {integer}\n   * @default {1024}\n   */\n  cacheSize: number;\n  /**\n   * If provided, forces the source type of a source.\n   * @default {false}\n   */\n  forceSourceType?: boolean;\n  /**\n   * The query operation for communicating bindings.\n   * @default {values}\n   */\n  bindMethod: BindMethod;\n  /**\n   * Timeout in ms of how long count queries are allowed to take.\n   * If the timeout is reached, an infinity cardinality is returned.\n   * @default {3000}\n   */\n  countTimeout: number;\n  /**\n   * If count queries should be sent to obtain the cardinality of (sub)queries.\n   * If set to false, resulting cardinalities will always be considered infinity.\n   * @default {true}\n   */\n  cardinalityCountQueries: boolean;\n  /**\n   * If estimates for queries should be constructed locally from sub-query cardinalities.\n   * If set to false, count queries will used for cardinality estimation at all levels.\n   * @default {false}\n   */\n  cardinalityEstimateConstruction: boolean;\n  /**\n   * Force an HTTP GET instead of default POST (when forceHttpGet is false)\n   * when the url length (including encoded query) is below this number.\n   * @default {600}\n   */\n  forceGetIfUrlLengthBelow: number;\n}\n\nexport type BindMethod = 'values' | 'union' | 'filter';\n"]}