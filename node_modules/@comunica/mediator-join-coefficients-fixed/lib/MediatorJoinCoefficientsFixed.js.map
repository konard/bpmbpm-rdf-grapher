{"version":3,"file":"MediatorJoinCoefficientsFixed.js","sourceRoot":"","sources":["MediatorJoinCoefficientsFixed.ts"],"names":[],"mappings":"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","sourcesContent":["import type { ActorRdfJoin, IActionRdfJoin, IActorRdfJoinTestSideData } from '@comunica/bus-rdf-join';\nimport { KeysQueryOperation } from '@comunica/context-entries';\nimport type { IActorReply, IMediatorArgs, TestResult } from '@comunica/core';\nimport { passTestWithSideData, failTest, Actor, Mediator } from '@comunica/core';\nimport type { IMediatorTypeJoinCoefficients } from '@comunica/mediatortype-join-coefficients';\nimport type { IQueryOperationResult } from '@comunica/types';\n\n/**\n * A mediator that mediates over actors implementing the Join Coefficients mediator type and assigns fixed weights\n * to calculate an overall score and pick the actor with the lowest score.\n */\nexport class MediatorJoinCoefficientsFixed extends Mediator<\n  ActorRdfJoin,\nIActionRdfJoin,\nIMediatorTypeJoinCoefficients,\nIQueryOperationResult,\nIActorRdfJoinTestSideData\n> {\n  public readonly cpuWeight: number;\n  public readonly memoryWeight: number;\n  public readonly timeWeight: number;\n  public readonly ioWeight: number;\n\n  public constructor(args: IMediatorJoinCoefficientsFixedArgs) {\n    super(args);\n    this.cpuWeight = args.cpuWeight;\n    this.memoryWeight = args.memoryWeight;\n    this.timeWeight = args.timeWeight;\n    this.ioWeight = args.ioWeight;\n  }\n\n  protected async mediateWith(\n    action: IActionRdfJoin,\n    testResults: IActorReply<\n      ActorRdfJoin,\nIActionRdfJoin,\nIMediatorTypeJoinCoefficients,\nIQueryOperationResult,\nIActorRdfJoinTestSideData\n>[],\n  ): Promise<TestResult<ActorRdfJoin, IActorRdfJoinTestSideData>> {\n    // Obtain test results\n    const errors: string[] = [];\n    const promises = testResults.map(({ reply }) => reply);\n    const results = (await Promise.all(promises)).map((testResult) => {\n      if (testResult.isFailed()) {\n        errors.push(testResult.getFailMessage());\n        // eslint-disable-next-line array-callback-return\n        return;\n      }\n      return { value: testResult.get(), sideData: testResult.getSideData() };\n    });\n\n    // Calculate costs\n    let costs: (number | undefined)[] = results\n      // eslint-disable-next-line array-callback-return\n      .map((result) => {\n        if (result) {\n          return result.value.iterations * this.cpuWeight +\n            result.value.persistedItems * this.memoryWeight +\n            result.value.blockingItems * this.timeWeight +\n            result.value.requestTime * this.ioWeight;\n        }\n      });\n    const maxCost = Math.max(...costs.filter(cost => cost !== undefined));\n\n    // If we have a limit indicator in the context,\n    // increase cost of entries that have a number of iterations that is higher than the limit AND block items.\n    // In these cases, join operators that produce results early on will be preferred.\n    const limitIndicator: number | undefined = action.context.get(KeysQueryOperation.limitIndicator);\n    if (limitIndicator) {\n      costs = costs.map((cost, i) => {\n        if (cost !== undefined && (<any> results[i]?.value).blockingItems > 0 &&\n\n          (<any> results[i]?.value).iterations > limitIndicator) {\n          return cost + maxCost;\n        }\n        return cost;\n      });\n    }\n\n    // Determine index with lowest cost\n    let minIndex = -1;\n    let minValue = Number.POSITIVE_INFINITY;\n    for (const [ i, cost ] of costs.entries()) {\n      if (cost !== undefined && (minIndex === -1 || cost < minValue)) {\n        minIndex = i;\n        minValue = cost;\n      }\n    }\n\n    // Reject if all actors rejected\n    if (minIndex < 0) {\n      return failTest(this.constructFailureMessage(action, errors));\n    }\n\n    // Return actor with lowest cost\n    const bestActor = testResults[minIndex].actor;\n\n    // Emit calculations in logger\n    if (bestActor.includeInLogs) {\n      Actor.getContextLogger(action.context)?.debug(`Determined physical join operator '${bestActor.logicalType}-${bestActor.physicalName}'`, {\n        entries: action.entries.length,\n        variables: await Promise.all(action.entries\n          .map(async entry => (await entry.output.metadata()).variables.map(variable => variable.variable.value))),\n        costs: Object.fromEntries(costs.map((coeff, i) => [\n          `${testResults[i].actor.logicalType}-${testResults[i].actor.physicalName}`,\n          coeff,\n        ]).filter(entry => entry[1] !== undefined)),\n        coefficients: Object.fromEntries(results.map((result, i) => [\n          `${testResults[i].actor.logicalType}-${testResults[i].actor.physicalName}`,\n          result?.value,\n        ]).filter(entry => entry[1] !== undefined)),\n      });\n    }\n\n    return passTestWithSideData(bestActor, results[minIndex]!.sideData);\n  }\n}\n\nexport interface IMediatorJoinCoefficientsFixedArgs extends IMediatorArgs<\n  ActorRdfJoin,\nIActionRdfJoin,\nIMediatorTypeJoinCoefficients,\nIQueryOperationResult,\nIActorRdfJoinTestSideData\n> {\n  /**\n   * Weight for the CPU cost\n   */\n  cpuWeight: number;\n  /**\n   * Weight for the memory cost\n   */\n  memoryWeight: number;\n  /**\n   * Weight for the execution time cost\n   */\n  timeWeight: number;\n  /**\n   * Weight for the I/O cost\n   */\n  ioWeight: number;\n}\n"]}