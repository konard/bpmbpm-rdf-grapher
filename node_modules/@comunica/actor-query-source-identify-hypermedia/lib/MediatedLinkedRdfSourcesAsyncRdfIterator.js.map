{"version":3,"file":"MediatedLinkedRdfSourcesAsyncRdfIterator.js","sourceRoot":"","sources":["MediatedLinkedRdfSourcesAsyncRdfIterator.ts"],"names":[],"mappings":"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","sourcesContent":["import type { MediatorRdfMetadataAccumulate } from '@comunica/bus-rdf-metadata-accumulate';\nimport type { MediatorRdfResolveHypermediaLinks } from '@comunica/bus-rdf-resolve-hypermedia-links';\nimport type { MediatorRdfResolveHypermediaLinksQueue } from '@comunica/bus-rdf-resolve-hypermedia-links-queue';\nimport { KeysStatistics } from '@comunica/context-entries';\nimport type {\n  IActionContext,\n  IQueryBindingsOptions,\n  MetadataBindings,\n  ILink,\n  IStatisticBase,\n  IDiscoverEventData,\n  ILinkQueue,\n} from '@comunica/types';\nimport type { Algebra } from '@comunica/utils-algebra';\nimport type { SourceStateGetter, ISourceState } from './LinkedRdfSourcesAsyncRdfIterator';\nimport { LinkedRdfSourcesAsyncRdfIterator } from './LinkedRdfSourcesAsyncRdfIterator';\n\n/**\n * A quad iterator that can iterate over consecutive RDF sources\n * that are determined using the rdf-resolve-hypermedia-links bus.\n *\n * @see LinkedRdfSourcesAsyncRdfIterator\n */\nexport class MediatedLinkedRdfSourcesAsyncRdfIterator extends LinkedRdfSourcesAsyncRdfIterator {\n  private readonly mediatorMetadataAccumulate: MediatorRdfMetadataAccumulate;\n  private readonly mediatorRdfResolveHypermediaLinks: MediatorRdfResolveHypermediaLinks;\n  private readonly mediatorRdfResolveHypermediaLinksQueue: MediatorRdfResolveHypermediaLinksQueue;\n  private readonly handledUrls: Record<string, boolean>;\n  private linkQueue: Promise<ILinkQueue> | undefined;\n\n  public constructor(\n    operation: Algebra.Operation,\n    queryBindingsOptions: IQueryBindingsOptions | undefined,\n    context: IActionContext,\n    firstLink: ILink,\n    maxIterators: number,\n    sourceStateGetter: SourceStateGetter,\n    mediatorMetadataAccumulate: MediatorRdfMetadataAccumulate,\n    mediatorRdfResolveHypermediaLinks: MediatorRdfResolveHypermediaLinks,\n    mediatorRdfResolveHypermediaLinksQueue: MediatorRdfResolveHypermediaLinksQueue,\n  ) {\n    super(\n      operation,\n      queryBindingsOptions,\n      context,\n      firstLink,\n      maxIterators,\n      sourceStateGetter,\n    );\n    this.mediatorMetadataAccumulate = mediatorMetadataAccumulate;\n    this.mediatorRdfResolveHypermediaLinks = mediatorRdfResolveHypermediaLinks;\n    this.mediatorRdfResolveHypermediaLinksQueue = mediatorRdfResolveHypermediaLinksQueue;\n    this.handledUrls = { [firstLink.url]: true };\n  }\n\n  protected override isCloseable(linkQueue: ILinkQueue, requireQueueEmpty: boolean): boolean {\n    return (requireQueueEmpty ? linkQueue.isEmpty() : linkQueue.isEmpty()) && !this.areIteratorsRunning();\n  }\n\n  public getLinkQueue(): Promise<ILinkQueue> {\n    if (!this.linkQueue) {\n      this.linkQueue = this.mediatorRdfResolveHypermediaLinksQueue\n        .mediate({ context: this.context })\n        .then(result => result.linkQueue);\n    }\n    return this.linkQueue;\n  }\n\n  protected async getSourceLinks(metadata: Record<string, any>, startSource: ISourceState): Promise<ILink[]> {\n    try {\n      const { links } = await this.mediatorRdfResolveHypermediaLinks.mediate({ context: this.context, metadata });\n      // Update discovery event statistic if available\n      const traversalTracker: IStatisticBase<IDiscoverEventData> | undefined =\n        this.context.get(KeysStatistics.discoveredLinks);\n      if (traversalTracker) {\n        for (const link of links) {\n          traversalTracker.updateStatistic({ url: link.url, metadata: { ...link.metadata }}, startSource.link);\n        }\n      }\n\n      // Filter URLs to avoid cyclic next-page loops\n      return links.filter((link) => {\n        if (this.handledUrls[link.url]) {\n          return false;\n        }\n        this.handledUrls[link.url] = true;\n        return true;\n      });\n    } catch {\n      // No next URLs may be available, for example when we've reached the end of a Hydra next-page sequence.\n      return [];\n    }\n  }\n\n  public async accumulateMetadata(\n    accumulatedMetadata: MetadataBindings,\n    appendingMetadata: MetadataBindings,\n  ): Promise<MetadataBindings> {\n    return <MetadataBindings> (await this.mediatorMetadataAccumulate.mediate({\n      mode: 'append',\n      accumulatedMetadata,\n      appendingMetadata,\n      context: this.context,\n    })).metadata;\n  }\n}\n"]}