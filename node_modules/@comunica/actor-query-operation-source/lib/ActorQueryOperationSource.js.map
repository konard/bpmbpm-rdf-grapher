{"version":3,"file":"ActorQueryOperationSource.js","sourceRoot":"","sources":["ActorQueryOperationSource.ts"],"names":[],"mappings":"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","sourcesContent":["import type { IActionQueryOperation, IActorQueryOperationArgs } from '@comunica/bus-query-operation';\nimport { ActorQueryOperation } from '@comunica/bus-query-operation';\nimport { KeysInitQuery } from '@comunica/context-entries';\nimport type { IActorTest, TestResult } from '@comunica/core';\nimport { failTest, passTest } from '@comunica/core';\nimport type {\n  IPhysicalQueryPlanLogger,\n  IQueryOperationResult,\n  IQuerySourceWrapper,\n} from '@comunica/types';\nimport { Algebra, algebraUtils } from '@comunica/utils-algebra';\nimport { getMetadataBindings, getMetadataQuads } from '@comunica/utils-metadata';\nimport { getOperationSource } from '@comunica/utils-query-operation';\n\n/**\n * A comunica Source Query Operation Actor.\n */\nexport class ActorQueryOperationSource extends ActorQueryOperation {\n  public constructor(args: IActorQueryOperationArgs) {\n    super(args);\n  }\n\n  public async test(action: IActionQueryOperation): Promise<TestResult<IActorTest>> {\n    if (!getOperationSource(action.operation)) {\n      return failTest(`Actor ${this.name} requires an operation with source annotation.`);\n    }\n    return passTest({ httpRequests: 1 });\n  }\n\n  public async run(action: IActionQueryOperation): Promise<IQueryOperationResult> {\n    // Log to physical plan\n    const physicalQueryPlanLogger: IPhysicalQueryPlanLogger | undefined = action.context\n      .get(KeysInitQuery.physicalQueryPlanLogger);\n    if (physicalQueryPlanLogger) {\n      physicalQueryPlanLogger.logOperation(\n        action.operation.type,\n        undefined,\n        action.operation,\n        action.context.get(KeysInitQuery.physicalQueryPlanNode),\n        this.name,\n        {},\n      );\n      action.context = action.context.set(KeysInitQuery.physicalQueryPlanNode, action.operation);\n    }\n\n    const sourceWrapper: IQuerySourceWrapper = getOperationSource(action.operation)!;\n    const mergedContext = sourceWrapper.context ? action.context.merge(sourceWrapper.context) : action.context;\n\n    // Check if the operation is a CONSTRUCT query\n    // We recurse because it may be wrapped in other operations such as SLICE and FROM\n    let construct = false;\n    algebraUtils.visitOperation(action.operation, {\n      [Algebra.Types.CONSTRUCT]: { preVisitor: () => {\n        construct = true;\n        return { shortcut: true };\n      } },\n    });\n    // If so, delegate to queryQuads\n    if (construct) {\n      const quadStream = sourceWrapper.source.queryQuads(action.operation, mergedContext);\n      const metadata = getMetadataQuads(quadStream);\n      return {\n        type: 'quads',\n        quadStream,\n        metadata,\n      };\n    }\n\n    switch (action.operation.type) {\n      case Algebra.Types.ASK:\n        return {\n          type: 'boolean',\n          execute: () => sourceWrapper.source.queryBoolean(<Algebra.Ask>action.operation, mergedContext),\n        };\n      case Algebra.Types.COMPOSITE_UPDATE:\n      case Algebra.Types.DELETE_INSERT:\n      case Algebra.Types.LOAD:\n      case Algebra.Types.CLEAR:\n      case Algebra.Types.CREATE:\n      case Algebra.Types.DROP:\n      case Algebra.Types.ADD:\n      case Algebra.Types.MOVE:\n      case Algebra.Types.COPY:\n        return {\n          type: 'void',\n          execute: () => sourceWrapper.source.queryVoid(action.operation, mergedContext),\n        };\n    }\n\n    const bindingsStream = sourceWrapper.source.queryBindings(action.operation, mergedContext);\n    const metadata = getMetadataBindings(bindingsStream);\n    return {\n      type: 'bindings',\n      bindingsStream,\n      metadata,\n    };\n  }\n}\n"]}