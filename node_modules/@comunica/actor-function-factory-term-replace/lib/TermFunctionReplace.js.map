{"version":3,"file":"TermFunctionReplace.js","sourceRoot":"","sources":["TermFunctionReplace.ts"],"names":[],"mappings":"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","sourcesContent":["import { TermFunctionRegex } from '@comunica/actor-function-factory-term-regex';\nimport { TermFunctionBase } from '@comunica/bus-function-factory';\nimport type {\n  StringLiteral,\n\n  LangStringLiteral,\n} from '@comunica/utils-expression-evaluator';\nimport {\n  declare,\n  langString,\n  SparqlOperator,\n  string,\n  TypeURL,\n} from '@comunica/utils-expression-evaluator';\nimport type { DirLangStringLiteral } from '@comunica/utils-expression-evaluator/lib/expressions';\nimport { dirLangString } from '@comunica/utils-expression-evaluator/lib/functions/Helpers';\n\n/**\n * https://www.w3.org/TR/sparql11-query/#func-replace\n */\nexport class TermFunctionReplace extends TermFunctionBase {\n  public constructor() {\n    super({\n      arity: [ 3, 4 ],\n      operator: SparqlOperator.REPLACE,\n      overloads: declare(SparqlOperator.REPLACE)\n        .onTernaryTyped(\n          [ TypeURL.XSD_STRING, TypeURL.XSD_STRING, TypeURL.XSD_STRING ],\n          () => (arg: string, pattern: string, replacement: string) =>\n            string(TermFunctionReplace.replace(arg, pattern, replacement)),\n        )\n        .set(\n          [ TypeURL.RDF_LANG_STRING, TypeURL.XSD_STRING, TypeURL.XSD_STRING ],\n          () => ([ arg, pattern, replacement ]: [LangStringLiteral, StringLiteral, StringLiteral]) => {\n            const result = TermFunctionReplace.replace(arg.typedValue, pattern.typedValue, replacement.typedValue);\n            return langString(result, arg.language);\n          },\n        )\n        .set(\n          [ TypeURL.RDF_DIR_LANG_STRING, TypeURL.XSD_STRING, TypeURL.XSD_STRING ],\n          () => ([ arg, pattern, replacement ]: [DirLangStringLiteral, StringLiteral, StringLiteral]) => {\n            const result = TermFunctionReplace.replace(arg.typedValue, pattern.typedValue, replacement.typedValue);\n            return dirLangString(result, arg.language, arg.direction);\n          },\n        )\n        .onQuaternaryTyped(\n          [ TypeURL.XSD_STRING, TypeURL.XSD_STRING, TypeURL.XSD_STRING, TypeURL.XSD_STRING ],\n          () => (arg: string, pattern: string, replacement: string, flags: string) =>\n            string(TermFunctionReplace.replace(arg, pattern, replacement, flags)),\n        )\n        .set(\n          [ TypeURL.RDF_LANG_STRING, TypeURL.XSD_STRING, TypeURL.XSD_STRING, TypeURL.XSD_STRING ],\n          () => ([ arg, pattern, replacement, flags ]:\n          [LangStringLiteral, StringLiteral, StringLiteral, StringLiteral]) => {\n            const result = TermFunctionReplace.replace(\n              arg.typedValue,\n              pattern.typedValue,\n              replacement.typedValue,\n              flags.typedValue,\n            );\n            return langString(result, arg.language);\n          },\n        )\n        .set(\n          [ TypeURL.RDF_DIR_LANG_STRING, TypeURL.XSD_STRING, TypeURL.XSD_STRING, TypeURL.XSD_STRING ],\n          () => ([ arg, pattern, replacement, flags ]:\n          [DirLangStringLiteral, StringLiteral, StringLiteral, StringLiteral]) => {\n            const result = TermFunctionReplace.replace(\n              arg.typedValue,\n              pattern.typedValue,\n              replacement.typedValue,\n              flags.typedValue,\n            );\n            return dirLangString(result, arg.language, arg.direction);\n          },\n        )\n        .collect(),\n    });\n  }\n\n  // https://www.w3.org/TR/xpath-functions/#func-replace\n  private static replace(arg: string, pattern: string, replacement: string, flags = ''): string {\n    flags = TermFunctionRegex.cleanFlags(flags);\n    if (flags.includes('x')) {\n      pattern = TermFunctionRegex.flagX(pattern);\n    }\n    if (flags.includes('q')) {\n      pattern = TermFunctionRegex.flagQ(pattern);\n    } else {\n      replacement = replacement.replaceAll('$0', () => '$&');\n    }\n    flags = `${flags.replaceAll(/[qx]/gu, '')}g`;\n    return arg.replaceAll(new RegExp(pattern, flags), replacement);\n  }\n}\n"]}