<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RDF Grapher - Визуализация RDF данных</title>

    <!--
        RDF Grapher - Сервис для парсинга RDF данных и их визуализации в виде графа

        Этот сервис является аналогом https://www.ldf.fi/service/rdf-grapher
        Использует клиентские JavaScript библиотеки:
        - N3.js для парсинга RDF (замена Redland Raptor)
        - Viz.js для рендеринга графов (замена Graphviz)

        Сервис работает полностью на стороне клиента и может быть размещен на GitHub Pages
    -->

    <!-- Стили для интерфейса -->
    <style>
        /* Основные стили страницы */
        * {
            box-sizing: border-box;
        }

        body {
            /* Шрифт и базовые настройки */
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        /* Заголовок страницы */
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        /* Описание сервиса */
        .description {
            background-color: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        /* Основной контейнер формы */
        .container {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Метки полей формы */
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        /* Текстовое поле для ввода RDF */
        textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            resize: vertical;
        }

        /* Фокус на текстовом поле */
        textarea:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.3);
        }

        /* Контейнер для селекторов форматов */
        .format-selectors {
            display: flex;
            gap: 20px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        /* Группа элементов формы */
        .form-group {
            flex: 1;
            min-width: 200px;
        }

        /* Выпадающие списки */
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
        }

        /* Кнопка визуализации */
        button {
            background-color: #4CAF50;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
            transition: background-color 0.3s;
        }

        /* Эффект наведения на кнопку */
        button:hover {
            background-color: #45a049;
        }

        /* Отключенная кнопка */
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        /* Контейнер для результата */
        .result-container {
            margin-top: 20px;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: none;
        }

        /* Область вывода графа */
        #output {
            text-align: center;
            /* overflow и max-width убраны для работы с zoom-container */
            display: inline-block;
        }

        /* SVG изображение графа */
        #output svg {
            /* Убираем ограничение max-width для возможности масштабирования */
            /* max-width: 100%; */
            height: auto;
        }

        /* Сообщение об ошибке */
        .error {
            color: #d32f2f;
            background-color: #ffebee;
            padding: 15px;
            border-radius: 4px;
            margin-top: 10px;
        }

        /* Индикатор загрузки */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        /* Анимация спиннера загрузки */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Кнопки экспорта */
        .export-buttons {
            margin-top: 15px;
            text-align: center;
        }

        .export-buttons button {
            margin: 5px;
            background-color: #2196F3;
        }

        .export-buttons button:hover {
            background-color: #1976D2;
        }

        /* Контейнер с масштабированием */
        .zoom-container {
            position: relative;
            overflow: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            min-height: 300px;
            max-height: 70vh;
        }

        /* Контейнер внутри для масштабирования */
        .zoom-content {
            transform-origin: top left;
            transition: transform 0.2s ease;
        }

        /* Панель управления масштабом */
        .zoom-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }

        .zoom-controls button {
            padding: 8px 15px;
            margin: 0;
            font-size: 14px;
            background-color: #607D8B;
        }

        .zoom-controls button:hover {
            background-color: #455A64;
        }

        .zoom-controls span {
            min-width: 60px;
            text-align: center;
            font-weight: bold;
            color: #333;
        }

        /* Информация о технологиях */
        .tech-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #fff3e0;
            border-radius: 5px;
            font-size: 14px;
        }

        /* Ссылки */
        a {
            color: #1976D2;
        }

        /* Пример RDF */
        .example-link {
            color: #4CAF50;
            cursor: pointer;
            text-decoration: underline;
        }

        .example-link:hover {
            color: #45a049;
        }

        /* Панель префиксов (Namespaces) */
        .prefixes-panel {
            margin-top: 15px;
            padding: 15px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .prefixes-panel h3 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
        }

        .prefixes-content {
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .prefix-line {
            margin: 2px 0;
        }

        .prefix-name {
            color: #6a1b9a;
            font-weight: bold;
        }

        .prefix-url {
            color: #1976D2;
            text-decoration: none;
        }

        .prefix-url:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Заголовок страницы -->
    <h1>RDF Grapher</h1>

    <!-- Описание сервиса -->
    <div class="description">
        <p>
            <strong>RDF Grapher</strong> — сервис для парсинга RDF данных и их визуализации в виде графа.
            Этот сервис является клоном <a href="https://www.ldf.fi/service/rdf-grapher" target="_blank">LDF RDF Grapher</a>.
        </p>
        <p>
            Введите RDF данные в текстовое поле ниже, выберите входной и выходной форматы,
            и нажмите кнопку "Визуализировать" для генерации графа.
        </p>
        <p>
            <strong>Загрузить пример RDF данных:</strong>
            <span class="example-link" onclick="loadExampleTurtle()">Turtle</span> |
            <span class="example-link" onclick="loadExampleNTriples()">N-Triples</span> |
            <span class="example-link" onclick="loadExampleNQuads()">N-Quads</span> |
            <span class="example-link" onclick="loadExampleTriG()">TriG</span>
        </p>
    </div>

    <!-- Основная форма -->
    <div class="container">
        <!-- Метка для текстового поля -->
        <label for="rdf-input">RDF данные или URI:</label>

        <!-- Текстовое поле для ввода RDF -->
        <textarea id="rdf-input" placeholder="Введите RDF данные в формате Turtle, N-Triples, N-Quads или TriG...

Пример (Turtle):
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix ex: <http://example.org/> .

ex:john a foaf:Person ;
    foaf:name &quot;John Doe&quot; ;
    foaf:knows ex:jane .

ex:jane a foaf:Person ;
    foaf:name &quot;Jane Smith&quot; ."></textarea>

        <!-- Селекторы форматов -->
        <div class="format-selectors">
            <!-- Выбор входного формата -->
            <div class="form-group">
                <label for="input-format">Входной формат:</label>
                <select id="input-format">
                    <!--
                        Поддерживаемые входные форматы:
                        - Turtle (.ttl) - наиболее читаемый формат
                        - N-Triples (.nt) - простой построчный формат
                        - N-Quads (.nq) - N-Triples с именованными графами
                        - TriG (.trig) - Turtle с именованными графами
                    -->
                    <option value="turtle" selected>Turtle</option>
                    <option value="n-triples">N-Triples</option>
                    <option value="n-quads">N-Quads</option>
                    <option value="trig">TriG</option>
                </select>
            </div>

            <!-- Выбор выходного формата -->
            <div class="form-group">
                <label for="output-format">Выходной формат:</label>
                <select id="output-format">
                    <!--
                        Поддерживаемые выходные форматы:
                        - SVG - векторный формат, масштабируемый
                        - PNG - растровый формат для скачивания
                    -->
                    <option value="svg" selected>SVG</option>
                    <option value="png">PNG</option>
                </select>
            </div>

            <!-- Выбор движка компоновки графа -->
            <div class="form-group">
                <label for="layout-engine">Движок компоновки:</label>
                <select id="layout-engine">
                    <!--
                        Graphviz движки компоновки:
                        - dot - иерархическая (направленные графы)
                        - neato - spring model (ненаправленные графы)
                        - fdp - force-directed placement
                        - circo - круговая компоновка
                        - twopi - радиальная компоновка
                    -->
                    <option value="dot" selected>dot (иерархическая)</option>
                    <option value="neato">neato (spring model)</option>
                    <option value="fdp">fdp (force-directed)</option>
                    <option value="circo">circo (круговая)</option>
                    <option value="twopi">twopi (радиальная)</option>
                </select>
            </div>
        </div>

        <!-- Кнопка визуализации -->
        <button id="visualize-btn" onclick="visualize()">Визуализировать</button>
    </div>

    <!-- Контейнер для результата -->
    <div class="result-container" id="result-container">
        <h2>Результат:</h2>
        <!-- Панель управления масштабом -->
        <div class="zoom-controls" id="zoom-controls" style="display: none;">
            <button onclick="zoomOut()">−</button>
            <span id="zoom-level">100%</span>
            <button onclick="zoomIn()">+</button>
            <button onclick="zoomReset()">Сброс</button>
            <button onclick="zoomFit()">Вписать</button>
        </div>
        <!-- Область вывода графа с масштабированием -->
        <div class="zoom-container" id="zoom-container">
            <div class="zoom-content" id="zoom-content">
                <div id="output"></div>
            </div>
        </div>
        <!-- Кнопки экспорта -->
        <div class="export-buttons" id="export-buttons" style="display: none;">
            <button onclick="downloadSVG()">Скачать SVG</button>
            <button onclick="downloadPNG()">Скачать PNG</button>
            <button onclick="openInNewWindowGitHub()">Показать в окне github</button>
            <button onclick="openInNewWindowLdfFi()">Показать в окне ldf.fi</button>
        </div>
        <!-- Панель префиксов (Namespaces) -->
        <div class="prefixes-panel" id="prefixes-panel" style="display: none;">
            <h3>Prefixes:</h3>
            <div class="prefixes-content" id="prefixes-content"></div>
        </div>
    </div>

    <!-- Информация об используемых технологиях -->
    <div class="tech-info">
        <h3>Используемые технологии:</h3>
        <ul>
            <li>
                <strong>N3.js</strong> — JavaScript библиотека для парсинга RDF
                (замена <a href="http://librdf.org/raptor/rapper.html" target="_blank">Redland Raptor</a>)
                — <a href="https://github.com/rdfjs/N3.js" target="_blank">GitHub</a>
            </li>
            <li>
                <strong>Viz.js</strong> — WebAssembly версия
                <a href="http://graphviz.org/" target="_blank">Graphviz</a> для браузера
                — <a href="https://github.com/mdaines/viz-js" target="_blank">GitHub</a>
            </li>
        </ul>
        <p>
            Этот сервис работает полностью на стороне клиента (в браузере)
            и не требует серверной части, что позволяет размещать его на GitHub Pages.
        </p>
    </div>

    <!-- Подключение библиотеки N3.js для парсинга RDF -->
    <!-- N3.js - быстрый, спецификационно-совместимый парсер RDF для JavaScript -->
    <script src="https://unpkg.com/n3@1.17.2/browser/n3.min.js"></script>

    <!-- Подключение библиотеки Viz.js для рендеринга графов -->
    <!-- Viz.js - WebAssembly сборка Graphviz для работы в браузере -->
    <script src="https://unpkg.com/@viz-js/viz@3.4.0/lib/viz-standalone.js"></script>

    <script>
        /**
         * RDF Grapher - Основной JavaScript модуль
         *
         * Этот модуль отвечает за:
         * 1. Парсинг RDF данных с помощью N3.js
         * 2. Генерацию DOT-кода для Graphviz
         * 3. Рендеринг графа с помощью Viz.js
         * 4. Экспорт результата в SVG и PNG форматы
         */

        // Глобальная переменная для хранения текущего SVG
        let currentSvgElement = null;

        // Глобальная переменная для хранения текущего масштаба
        let currentScale = 1.0;

        // Глобальная переменная для хранения префиксов
        let currentPrefixes = {};

        /**
         * Применяет текущий масштаб к контейнеру с графом
         */
        function applyZoom() {
            const zoomContent = document.getElementById('zoom-content');
            const zoomLevel = document.getElementById('zoom-level');

            if (zoomContent) {
                zoomContent.style.transform = `scale(${currentScale})`;
            }
            if (zoomLevel) {
                zoomLevel.textContent = Math.round(currentScale * 100) + '%';
            }
        }

        /**
         * Увеличивает масштаб на 10%
         */
        function zoomIn() {
            if (currentScale < 3.0) {
                currentScale += 0.1;
                applyZoom();
            }
        }

        /**
         * Уменьшает масштаб на 10%
         */
        function zoomOut() {
            if (currentScale > 0.1) {
                currentScale -= 0.1;
                applyZoom();
            }
        }

        /**
         * Сбрасывает масштаб к 100%
         */
        function zoomReset() {
            currentScale = 1.0;
            applyZoom();
        }

        /**
         * Вписывает граф в видимую область контейнера
         */
        function zoomFit() {
            const zoomContainer = document.getElementById('zoom-container');
            const output = document.getElementById('output');
            const svg = output ? output.querySelector('svg') : null;

            if (!zoomContainer || !svg) {
                return;
            }

            // Получаем размеры контейнера
            const containerWidth = zoomContainer.clientWidth - 20; // с учетом padding
            const containerHeight = zoomContainer.clientHeight - 20;

            // Получаем размеры SVG
            let svgWidth = parseFloat(svg.getAttribute('width')) || svg.getBoundingClientRect().width;
            let svgHeight = parseFloat(svg.getAttribute('height')) || svg.getBoundingClientRect().height;

            // Если размеры в pt, конвертируем
            const widthStr = svg.getAttribute('width') || '';
            const heightStr = svg.getAttribute('height') || '';
            if (widthStr.includes('pt')) {
                svgWidth = parseFloat(widthStr) * 1.33;
            }
            if (heightStr.includes('pt')) {
                svgHeight = parseFloat(heightStr) * 1.33;
            }

            // Вычисляем масштаб для вписывания
            const scaleX = containerWidth / svgWidth;
            const scaleY = containerHeight / svgHeight;
            currentScale = Math.min(scaleX, scaleY, 1.0); // не более 100%

            applyZoom();
        }

        /**
         * Загружает пример RDF данных в формате Turtle
         */
        function loadExampleTurtle() {
            const exampleRdf = `# Пример RDF данных в формате Turtle
# Определение префиксов (сокращений для URI)
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix ex: <http://example.org/> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .

# Описание человека John
ex:john rdf:type foaf:Person ;
    foaf:name "John Doe" ;
    foaf:age 30 ;
    foaf:knows ex:jane, ex:bob .

# Описание человека Jane
ex:jane rdf:type foaf:Person ;
    foaf:name "Jane Smith" ;
    foaf:knows ex:john .

# Описание человека Bob
ex:bob rdf:type foaf:Person ;
    foaf:name "Bob Wilson" ;
    foaf:workplaceHomepage <http://example.org/company> .

# Описание компании
ex:company rdf:type foaf:Organization ;
    foaf:name "Example Corp" ;
    foaf:member ex:bob, ex:jane .`;

            document.getElementById('rdf-input').value = exampleRdf;
            document.getElementById('input-format').value = 'turtle';
        }

        /**
         * Загружает пример RDF данных в формате N-Triples
         */
        function loadExampleNTriples() {
            const exampleRdf = `# Пример RDF данных в формате N-Triples
# Каждая строка содержит один триплет: субъект предикат объект .
<http://example.org/john> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://xmlns.com/foaf/0.1/Person> .
<http://example.org/john> <http://xmlns.com/foaf/0.1/name> "John Doe" .
<http://example.org/john> <http://xmlns.com/foaf/0.1/age> "30"^^<http://www.w3.org/2001/XMLSchema#integer> .
<http://example.org/john> <http://xmlns.com/foaf/0.1/knows> <http://example.org/jane> .
<http://example.org/john> <http://xmlns.com/foaf/0.1/knows> <http://example.org/bob> .
<http://example.org/jane> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://xmlns.com/foaf/0.1/Person> .
<http://example.org/jane> <http://xmlns.com/foaf/0.1/name> "Jane Smith" .
<http://example.org/jane> <http://xmlns.com/foaf/0.1/knows> <http://example.org/john> .
<http://example.org/bob> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://xmlns.com/foaf/0.1/Person> .
<http://example.org/bob> <http://xmlns.com/foaf/0.1/name> "Bob Wilson" .
<http://example.org/bob> <http://xmlns.com/foaf/0.1/workplaceHomepage> <http://example.org/company> .
<http://example.org/company> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://xmlns.com/foaf/0.1/Organization> .
<http://example.org/company> <http://xmlns.com/foaf/0.1/name> "Example Corp" .
<http://example.org/company> <http://xmlns.com/foaf/0.1/member> <http://example.org/bob> .
<http://example.org/company> <http://xmlns.com/foaf/0.1/member> <http://example.org/jane> .`;

            document.getElementById('rdf-input').value = exampleRdf;
            document.getElementById('input-format').value = 'n-triples';
        }

        /**
         * Загружает пример RDF данных в формате N-Quads
         */
        function loadExampleNQuads() {
            const exampleRdf = `# Пример RDF данных в формате N-Quads
# Формат: субъект предикат объект граф .
# N-Quads расширяет N-Triples добавлением именованных графов
<http://example.org/john> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://xmlns.com/foaf/0.1/Person> <http://example.org/people> .
<http://example.org/john> <http://xmlns.com/foaf/0.1/name> "John Doe" <http://example.org/people> .
<http://example.org/john> <http://xmlns.com/foaf/0.1/knows> <http://example.org/jane> <http://example.org/people> .
<http://example.org/jane> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://xmlns.com/foaf/0.1/Person> <http://example.org/people> .
<http://example.org/jane> <http://xmlns.com/foaf/0.1/name> "Jane Smith" <http://example.org/people> .
<http://example.org/company> <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://xmlns.com/foaf/0.1/Organization> <http://example.org/organizations> .
<http://example.org/company> <http://xmlns.com/foaf/0.1/name> "Example Corp" <http://example.org/organizations> .
<http://example.org/company> <http://xmlns.com/foaf/0.1/member> <http://example.org/john> <http://example.org/organizations> .`;

            document.getElementById('rdf-input').value = exampleRdf;
            document.getElementById('input-format').value = 'n-quads';
        }

        /**
         * Загружает пример RDF данных в формате TriG
         */
        function loadExampleTriG() {
            const exampleRdf = `# Пример RDF данных в формате TriG
# TriG расширяет Turtle добавлением именованных графов
@prefix foaf: <http://xmlns.com/foaf/0.1/> .
@prefix ex: <http://example.org/> .
@prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .

# Граф с информацией о людях
ex:people {
    ex:john rdf:type foaf:Person ;
        foaf:name "John Doe" ;
        foaf:knows ex:jane .

    ex:jane rdf:type foaf:Person ;
        foaf:name "Jane Smith" ;
        foaf:knows ex:john .
}

# Граф с информацией об организациях
ex:organizations {
    ex:company rdf:type foaf:Organization ;
        foaf:name "Example Corp" ;
        foaf:member ex:john, ex:jane .
}`;

            document.getElementById('rdf-input').value = exampleRdf;
            document.getElementById('input-format').value = 'trig';
        }

        /**
         * Для обратной совместимости: вызывает загрузку примера Turtle
         */
        function loadExample() {
            loadExampleTurtle();
        }

        /**
         * Извлекает локальное имя из URI
         * Например: http://xmlns.com/foaf/0.1/Person -> Person
         *
         * @param {string} uri - Полный URI
         * @returns {string} - Локальное имя или сокращенный URI
         */
        function getLocalName(uri) {
            // Если это не строка, возвращаем как есть
            if (typeof uri !== 'string') {
                return String(uri);
            }

            // Попытка извлечь локальное имя после # или последнего /
            const hashIndex = uri.lastIndexOf('#');
            const slashIndex = uri.lastIndexOf('/');

            // Выбираем индекс, который дает более короткое имя
            const splitIndex = Math.max(hashIndex, slashIndex);

            if (splitIndex !== -1 && splitIndex < uri.length - 1) {
                return uri.substring(splitIndex + 1);
            }

            // Если не удалось извлечь, возвращаем весь URI
            return uri;
        }

        /**
         * Получает имя с префиксом из URI, используя известные префиксы
         * Например: http://xmlns.com/foaf/0.1/Person -> foaf:Person
         *
         * @param {string} uri - Полный URI
         * @param {Object} prefixes - Объект с префиксами (prefix -> namespace)
         * @returns {string} - Имя с префиксом или локальное имя
         */
        function getPrefixedName(uri, prefixes) {
            // Если это не строка, возвращаем как есть
            if (typeof uri !== 'string') {
                return String(uri);
            }

            // Ищем подходящий префикс
            for (const [prefix, namespace] of Object.entries(prefixes)) {
                if (uri.startsWith(namespace)) {
                    const localName = uri.substring(namespace.length);
                    // Возвращаем prefixed name (например, foaf:Person)
                    return prefix + ':' + localName;
                }
            }

            // Если префикс не найден, возвращаем локальное имя
            return getLocalName(uri);
        }

        /**
         * Экранирует специальные символы для использования в DOT-формате
         *
         * @param {string} str - Исходная строка
         * @returns {string} - Экранированная строка
         */
        function escapeDotString(str) {
            // Экранируем кавычки и обратные слеши
            return str.replace(/\\/g, '\\\\').replace(/"/g, '\\"');
        }

        /**
         * Генерирует уникальный идентификатор узла для DOT
         *
         * @param {string} value - Значение узла
         * @returns {string} - Уникальный идентификатор
         */
        function generateNodeId(value) {
            // Создаем хеш из строки для уникального ID
            let hash = 0;
            for (let i = 0; i < value.length; i++) {
                const char = value.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Преобразуем в 32-битное целое
            }
            return 'node' + Math.abs(hash);
        }

        /**
         * Преобразует RDF триплеты в DOT-код для Graphviz
         *
         * @param {Array} quads - Массив RDF триплетов (quads)
         * @param {Object} prefixes - Объект с префиксами (prefix -> namespace)
         * @returns {string} - DOT-код графа
         */
        function rdfToDot(quads, prefixes = {}) {
            // Множества для хранения уникальных узлов и ребер
            const nodes = new Map(); // Карта: значение -> ID узла
            const edges = [];        // Массив ребер

            // Множество использованных префиксов для блока Namespaces
            const usedPrefixes = new Set();

            // Обрабатываем каждый триплет
            quads.forEach(quad => {
                // Извлекаем компоненты триплета
                const subject = quad.subject;
                const predicate = quad.predicate;
                const object = quad.object;

                // Получаем значения для отображения
                const subjectValue = subject.value;
                const predicateValue = predicate.value;
                const objectValue = object.value;

                // Получаем имена с префиксами для читаемости
                const subjectLabel = getPrefixedName(subjectValue, prefixes);
                const predicateLabel = getPrefixedName(predicateValue, prefixes);
                const objectLabel = object.termType === 'Literal'
                    ? `"${objectValue}"`
                    : getPrefixedName(objectValue, prefixes);

                // Отслеживаем использованные префиксы
                for (const [prefix, namespace] of Object.entries(prefixes)) {
                    if (subjectValue.startsWith(namespace) ||
                        predicateValue.startsWith(namespace) ||
                        (object.termType !== 'Literal' && objectValue.startsWith(namespace))) {
                        usedPrefixes.add(prefix);
                    }
                }

                // Создаем узлы, если они еще не существуют
                if (!nodes.has(subjectValue)) {
                    nodes.set(subjectValue, {
                        id: generateNodeId(subjectValue),
                        label: subjectLabel,
                        isUri: subject.termType === 'NamedNode',
                        isBlank: subject.termType === 'BlankNode'
                    });
                }

                if (!nodes.has(objectValue)) {
                    nodes.set(objectValue, {
                        id: generateNodeId(objectValue),
                        label: objectLabel,
                        isUri: object.termType === 'NamedNode',
                        isLiteral: object.termType === 'Literal',
                        isBlank: object.termType === 'BlankNode'
                    });
                }

                // Добавляем ребро
                edges.push({
                    from: nodes.get(subjectValue).id,
                    to: nodes.get(objectValue).id,
                    label: predicateLabel
                });
            });

            // Генерируем DOT-код
            let dot = 'digraph RDFGraph {\n';

            // Настройки графа
            dot += '    // Настройки графа\n';
            dot += '    rankdir=LR;\n';           // Направление слева направо
            dot += '    node [fontname="Arial"];\n';
            dot += '    edge [fontname="Arial", fontsize=10];\n';
            dot += '\n';

            // Блок Namespaces теперь отображается отдельно под графом, а не внутри SVG

            // Добавляем узлы
            dot += '    // Узлы графа\n';
            nodes.forEach((nodeInfo, value) => {
                let style = '';

                if (nodeInfo.isLiteral) {
                    // Литералы - прямоугольники с желтым фоном
                    style = ', shape=box, style=filled, fillcolor="#ffffcc"';
                } else if (nodeInfo.isBlank) {
                    // Пустые узлы - эллипсы с серым фоном
                    style = ', shape=ellipse, style=filled, fillcolor="#e0e0e0"';
                } else if (nodeInfo.isUri) {
                    // URI - эллипсы с голубым фоном
                    style = ', shape=ellipse, style=filled, fillcolor="#cce5ff"';
                }

                dot += `    ${nodeInfo.id} [label="${escapeDotString(nodeInfo.label)}"${style}];\n`;
            });

            dot += '\n';

            // Добавляем ребра
            dot += '    // Ребра графа (предикаты)\n';
            edges.forEach(edge => {
                dot += `    ${edge.from} -> ${edge.to} [label="${escapeDotString(edge.label)}"];\n`;
            });

            dot += '}\n';

            return dot;
        }

        /**
         * Показывает индикатор загрузки
         */
        function showLoading() {
            const output = document.getElementById('output');
            const resultContainer = document.getElementById('result-container');

            resultContainer.style.display = 'block';
            output.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Обработка RDF данных...</p>
                </div>
            `;

            // Скрываем кнопки экспорта, управление масштабом и панель префиксов во время загрузки
            document.getElementById('export-buttons').style.display = 'none';
            document.getElementById('zoom-controls').style.display = 'none';
            document.getElementById('prefixes-panel').style.display = 'none';
        }

        /**
         * Показывает сообщение об ошибке
         *
         * @param {string} message - Текст ошибки
         */
        function showError(message) {
            const output = document.getElementById('output');
            const resultContainer = document.getElementById('result-container');

            resultContainer.style.display = 'block';
            output.innerHTML = `<div class="error"><strong>Ошибка:</strong> ${message}</div>`;

            // Скрываем кнопки экспорта, управление масштабом и панель префиксов при ошибке
            document.getElementById('export-buttons').style.display = 'none';
            document.getElementById('zoom-controls').style.display = 'none';
            document.getElementById('prefixes-panel').style.display = 'none';
        }

        /**
         * Отображает панель префиксов с кликабельными URL
         *
         * @param {Object} prefixes - Объект с префиксами (prefix -> namespace)
         */
        function displayPrefixes(prefixes) {
            const prefixesPanel = document.getElementById('prefixes-panel');
            const prefixesContent = document.getElementById('prefixes-content');

            // Получаем список использованных префиксов
            const prefixEntries = Object.entries(prefixes);

            // Если нет префиксов, скрываем панель
            if (prefixEntries.length === 0) {
                prefixesPanel.style.display = 'none';
                return;
            }

            // Сортируем префиксы по имени
            prefixEntries.sort((a, b) => a[0].localeCompare(b[0]));

            // Формируем HTML для отображения префиксов
            let html = '';
            for (const [prefix, namespace] of prefixEntries) {
                // Создаем кликабельную ссылку для namespace
                html += `<div class="prefix-line">`;
                html += `<span class="prefix-name">@prefix ${prefix}:</span> `;
                html += `<a href="${namespace}" class="prefix-url" target="_blank">&lt;${namespace}&gt;</a> .`;
                html += `</div>`;
            }

            prefixesContent.innerHTML = html;
            prefixesPanel.style.display = 'block';
        }

        /**
         * Основная функция визуализации RDF данных
         * Парсит RDF, генерирует DOT-код и рендерит граф
         */
        async function visualize() {
            // Получаем входные данные
            const rdfInput = document.getElementById('rdf-input').value.trim();
            const inputFormat = document.getElementById('input-format').value;
            const outputFormat = document.getElementById('output-format').value;
            const layoutEngine = document.getElementById('layout-engine').value;

            // Проверяем, что данные введены
            if (!rdfInput) {
                showError('Пожалуйста, введите RDF данные');
                return;
            }

            // Показываем индикатор загрузки
            showLoading();

            // Отключаем кнопку на время обработки
            const button = document.getElementById('visualize-btn');
            button.disabled = true;
            button.textContent = 'Обработка...';

            try {
                // Шаг 1: Парсинг RDF данных с помощью N3.js
                // N3.Parser поддерживает Turtle, N-Triples, N-Quads и TriG
                const parser = new N3.Parser({ format: inputFormat });
                const quads = [];
                let prefixes = {};

                // Парсим RDF данные
                // N3.js использует callback-based API
                await new Promise((resolve, reject) => {
                    parser.parse(rdfInput, (error, quad, parsedPrefixes) => {
                        if (error) {
                            reject(error);
                            return;
                        }
                        if (quad) {
                            quads.push(quad);
                        } else {
                            // null quad означает конец парсинга
                            // parsedPrefixes содержит все найденные префиксы
                            if (parsedPrefixes) {
                                prefixes = parsedPrefixes;
                            }
                            resolve();
                        }
                    });
                });

                // Сохраняем префиксы в глобальную переменную
                currentPrefixes = prefixes;

                // Проверяем, что получены триплеты
                if (quads.length === 0) {
                    showError('Не найдено RDF триплетов в данных');
                    return;
                }

                // Шаг 2: Генерация DOT-кода из RDF триплетов
                // Передаем префиксы для создания prefixed names
                const dotCode = rdfToDot(quads, prefixes);

                // Выводим DOT-код в консоль для отладки
                console.log('Сгенерированный DOT-код:', dotCode);

                // Шаг 3: Рендеринг графа с помощью Viz.js
                // Viz.js использует WebAssembly для быстрого рендеринга
                const viz = await Viz.instance();

                // Рендерим граф в SVG формате
                // SVG всегда генерируется первым, т.к. из него можно получить PNG
                const svgString = viz.renderString(dotCode, {
                    format: 'svg',
                    engine: layoutEngine
                });

                // Отображаем результат
                const output = document.getElementById('output');

                // Сбрасываем масштаб перед отображением нового графа
                currentScale = 1.0;
                applyZoom();

                if (outputFormat === 'svg') {
                    // Отображаем SVG напрямую
                    output.innerHTML = svgString;
                    currentSvgElement = output.querySelector('svg');

                    // Показываем кнопки экспорта и управление масштабом
                    document.getElementById('export-buttons').style.display = 'block';
                    document.getElementById('zoom-controls').style.display = 'flex';
                } else if (outputFormat === 'png') {
                    // Конвертируем SVG в PNG через Canvas
                    const pngDataUrl = await svgToPng(svgString);
                    output.innerHTML = `<img src="${pngDataUrl}" alt="RDF Graph" style="max-width: 100%;">`;
                    currentSvgElement = null;

                    // Сохраняем SVG для экспорта
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = svgString;
                    currentSvgElement = tempDiv.querySelector('svg');

                    // Показываем кнопки экспорта и управление масштабом
                    document.getElementById('export-buttons').style.display = 'block';
                    document.getElementById('zoom-controls').style.display = 'flex';
                }

                // Отображаем панель префиксов
                displayPrefixes(prefixes);

                // Выводим статистику
                console.log(`Обработано ${quads.length} триплетов`);
                console.log('Найденные префиксы:', prefixes);

            } catch (error) {
                // Обрабатываем ошибки парсинга или рендеринга
                console.error('Ошибка визуализации:', error);
                showError(`${error.message}`);
            } finally {
                // Восстанавливаем кнопку
                button.disabled = false;
                button.textContent = 'Визуализировать';
            }
        }

        /**
         * Конвертирует SVG строку в PNG Data URL
         * Использует Canvas API для растеризации
         *
         * @param {string} svgString - SVG код
         * @returns {Promise<string>} - Data URL изображения PNG
         */
        function svgToPng(svgString) {
            return new Promise((resolve, reject) => {
                // Создаем временный элемент для SVG
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = svgString;
                const svgElement = tempDiv.querySelector('svg');

                // Получаем размеры SVG
                let width = parseInt(svgElement.getAttribute('width')) || 800;
                let height = parseInt(svgElement.getAttribute('height')) || 600;

                // Если размеры в pt, конвертируем в px (приблизительно)
                const widthStr = svgElement.getAttribute('width') || '';
                const heightStr = svgElement.getAttribute('height') || '';

                if (widthStr.includes('pt')) {
                    width = Math.ceil(parseFloat(widthStr) * 1.33);
                }
                if (heightStr.includes('pt')) {
                    height = Math.ceil(parseFloat(heightStr) * 1.33);
                }

                // Создаем Canvas
                const canvas = document.createElement('canvas');
                canvas.width = width * 2;  // Увеличиваем для лучшего качества
                canvas.height = height * 2;
                const ctx = canvas.getContext('2d');

                // Масштабируем для лучшего качества
                ctx.scale(2, 2);

                // Заполняем белым фоном
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, width, height);

                // Создаем изображение из SVG
                const img = new Image();
                const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);

                img.onload = function() {
                    // Рисуем SVG на Canvas
                    ctx.drawImage(img, 0, 0, width, height);
                    URL.revokeObjectURL(url);

                    // Конвертируем в PNG
                    resolve(canvas.toDataURL('image/png'));
                };

                img.onerror = function() {
                    URL.revokeObjectURL(url);
                    reject(new Error('Ошибка при конвертации SVG в PNG'));
                };

                img.src = url;
            });
        }

        /**
         * Скачивает граф в формате SVG
         */
        function downloadSVG() {
            if (!currentSvgElement) {
                alert('Сначала визуализируйте RDF данные');
                return;
            }

            // Получаем SVG код
            const svgData = new XMLSerializer().serializeToString(currentSvgElement);
            const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });

            // Создаем ссылку для скачивания
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(svgBlob);
            downloadLink.download = 'rdf-graph.svg';

            // Инициируем скачивание
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);

            // Освобождаем URL
            URL.revokeObjectURL(downloadLink.href);
        }

        /**
         * Скачивает граф в формате PNG
         */
        async function downloadPNG() {
            if (!currentSvgElement) {
                alert('Сначала визуализируйте RDF данные');
                return;
            }

            try {
                // Получаем SVG код
                const svgData = new XMLSerializer().serializeToString(currentSvgElement);

                // Конвертируем в PNG
                const pngDataUrl = await svgToPng(svgData);

                // Создаем ссылку для скачивания
                const downloadLink = document.createElement('a');
                downloadLink.href = pngDataUrl;
                downloadLink.download = 'rdf-graph.png';

                // Инициируем скачивание
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);

            } catch (error) {
                console.error('Ошибка при скачивании PNG:', error);
                alert('Ошибка при создании PNG файла');
            }
        }

        /**
         * Маппинг внутренних форматов на форматы параметров LDF сервиса
         */
        const formatMapping = {
            'turtle': 'ttl',
            'n-triples': 'nt',
            'n-quads': 'nq',
            'trig': 'trig'
        };

        /**
         * Открывает визуализацию в новом окне через внешний LDF сервис
         * Формирует URL с параметрами: rdf=данные&from=формат&to=png
         */
        function openInNewWindowLdfFi() {
            // Получаем входные данные
            const rdfInput = document.getElementById('rdf-input').value.trim();
            const inputFormat = document.getElementById('input-format').value;

            // Проверяем, что данные введены
            if (!rdfInput) {
                alert('Пожалуйста, введите RDF данные');
                return;
            }

            // Получаем формат для параметра URL
            const fromFormat = formatMapping[inputFormat] || 'ttl';

            // Кодируем RDF данные для URL
            // Заменяем пробелы на + для совместимости с LDF сервисом
            const encodedRdf = encodeURIComponent(rdfInput).replace(/%20/g, '+');

            // Формируем URL для внешнего сервиса
            const serviceUrl = `https://www.ldf.fi/service/rdf-grapher?rdf=${encodedRdf}&from=${fromFormat}&to=png`;

            // Открываем в новом окне
            window.open(serviceUrl, '_blank');
        }

        /**
         * Открывает визуализацию в новом окне через GitHub Pages (без внешнего сервиса)
         * Формирует URL с параметрами: rdf=данные&from=формат&to=формат
         * Аналогично работе LDF сервиса
         */
        function openInNewWindowGitHub() {
            // Получаем входные данные
            const rdfInput = document.getElementById('rdf-input').value.trim();
            const inputFormat = document.getElementById('input-format').value;
            const outputFormat = document.getElementById('output-format').value;

            // Проверяем, что данные введены
            if (!rdfInput) {
                alert('Пожалуйста, введите RDF данные');
                return;
            }

            // Получаем формат для параметра URL
            const fromFormat = formatMapping[inputFormat] || 'ttl';

            // Кодируем RDF данные для URL
            // Заменяем пробелы на + для совместимости (аналогично LDF сервису)
            const encodedRdf = encodeURIComponent(rdfInput).replace(/%20/g, '+');

            // Определяем базовый URL для GitHub Pages
            // Используем текущий URL или дефолтный путь
            let baseUrl;
            if (window.location.hostname === 'bpmbpm.github.io') {
                baseUrl = 'https://bpmbpm.github.io/rdf-grapher/ver1/';
            } else {
                // Для локального тестирования используем текущий путь
                baseUrl = window.location.origin + window.location.pathname;
            }

            // Формируем URL с параметрами
            const serviceUrl = `${baseUrl}?rdf=${encodedRdf}&from=${fromFormat}&to=${outputFormat}`;

            // Открываем в новом окне
            window.open(serviceUrl, '_blank');
        }

        /**
         * Парсит URL параметры и возвращает объект с параметрами
         * Поддерживаемые параметры:
         * - rdf: RDF данные (URL-encoded)
         * - from: входной формат (ttl, nt, nq, trig)
         * - to: выходной формат (svg, png)
         *
         * @returns {Object} - Объект с параметрами
         */
        function parseUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const params = {};

            // Получаем RDF данные из параметра
            if (urlParams.has('rdf')) {
                params.rdf = urlParams.get('rdf');
            }

            // Получаем входной формат
            if (urlParams.has('from')) {
                const fromParam = urlParams.get('from');
                // Маппинг обратный: параметры URL -> внутренние форматы
                const reverseFormatMapping = {
                    'ttl': 'turtle',
                    'turtle': 'turtle',
                    'nt': 'n-triples',
                    'n-triples': 'n-triples',
                    'nq': 'n-quads',
                    'n-quads': 'n-quads',
                    'trig': 'trig'
                };
                params.from = reverseFormatMapping[fromParam] || 'turtle';
            }

            // Получаем выходной формат
            if (urlParams.has('to')) {
                const toParam = urlParams.get('to');
                if (toParam === 'png' || toParam === 'svg') {
                    params.to = toParam;
                }
            }

            return params;
        }

        /**
         * Инициализация при загрузке страницы
         * Проверяет URL параметры и автоматически визуализирует данные, если они переданы
         */
        document.addEventListener('DOMContentLoaded', function() {
            console.log('RDF Grapher загружен');
            console.log('Используемые библиотеки: N3.js, Viz.js');

            // Парсим URL параметры
            const params = parseUrlParams();

            // Если есть RDF данные в URL, заполняем форму и визуализируем
            if (params.rdf) {
                console.log('Обнаружены RDF данные в URL, загружаем...');

                // Заполняем текстовое поле RDF данными
                document.getElementById('rdf-input').value = params.rdf;

                // Устанавливаем входной формат, если указан
                if (params.from) {
                    document.getElementById('input-format').value = params.from;
                }

                // Устанавливаем выходной формат, если указан
                if (params.to) {
                    document.getElementById('output-format').value = params.to;
                }

                // Небольшая задержка для уверенности, что все элементы загружены
                setTimeout(function() {
                    visualize();
                }, 100);
            }
        });
    </script>
</body>
</html>
