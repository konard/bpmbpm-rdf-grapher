<!DOCTYPE html>
<html>
<head>
    <title>Test Issue 56 Fixes - Min distance and line crossing</title>
    <script src="https://unpkg.com/@viz-js/viz@3.4.0/lib/viz-standalone.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test { margin: 20px 0; border: 1px solid #ccc; padding: 15px; }
        h2 { color: #333; }
        pre { background: #f5f5f5; padding: 10px; overflow: auto; font-size: 11px; }
        .issue { color: red; }
        .fix { color: green; }
    </style>
</head>
<body>
    <h1>Issue 56 Fixes - Min CDS-Executor distance and line crossing</h1>
    <p>Testing solutions for issue #56 requirements.</p>

    <div class="test">
        <h2>Test 1: Current layout with crossing issue (Process 2 → Process 4 crosses Process 3)</h2>
        <p class="issue">Shows the problem: Line from P2 to P4 crosses P3</p>
        <div id="test1"></div>
    </div>

    <div class="test">
        <h2>Test 2: Reduced ranksep for minimal CDS-Executor distance</h2>
        <p class="fix">Using ranksep=0.3 instead of 0.5</p>
        <div id="test2"></div>
    </div>

    <div class="test">
        <h2>Test 3: Fix line crossing with proper port specification and curved splines</h2>
        <p class="fix">Using ports and headclip/tailclip for edge routing</p>
        <div id="test3"></div>
    </div>

    <div class="test">
        <h2>Test 4: VAD Row Wrapping - 4 processes per row with max VAD length</h2>
        <p class="fix">Using subgraphs to wrap VAD to multiple rows when exceeding max length</p>
        <div id="test4"></div>
    </div>

    <div class="test">
        <h2>Test 5: Combined fix - minimal distance + no crossing + row wrapping</h2>
        <p class="fix">Full solution combining all fixes</p>
        <div id="test5"></div>
    </div>

    <script>
        async function runTests() {
            const viz = await Viz.instance();

            // Test 1: Current problematic layout with crossing
            const dot1 = `
digraph VADGraph {
    rankdir=TB;
    node [fontname="Arial"];
    edge [fontname="Arial", fontsize=10];
    splines=curved;
    nodesep=0.8;
    ranksep=0.5;

    // Process nodes
    P1 [label=<Процесс 1> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P2 [label=<Процесс 2> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P3 [label=<Процесс 3> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P4 [label=<Процесс 4> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P5 [label=<Процесс 5> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];

    // Executor nodes
    E1 [label=<<FONT POINT-SIZE="9">Исполнитель 1</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E2 [label=<<FONT POINT-SIZE="9">Исп. 1, Исп. 2</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E3 [label=<<FONT POINT-SIZE="9">Исполнитель 3</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E4 [label=<<FONT POINT-SIZE="9">Исп. 3, Исп. 4</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E5 [label=<<FONT POINT-SIZE="9">Исполнитель 5</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];

    // All executors on same row
    { rank=same; E1; E2; E3; E4; E5; }

    // Visible hasExecutor edges
    P1 -> E1 [color="#1565C0" penwidth="1" style="dashed" arrowhead="none" weight=10];
    P2 -> E2 [color="#1565C0" penwidth="1" style="dashed" arrowhead="none" weight=10];
    P3 -> E3 [color="#1565C0" penwidth="1" style="dashed" arrowhead="none" weight=10];
    P4 -> E4 [color="#1565C0" penwidth="1" style="dashed" arrowhead="none" weight=10];
    P5 -> E5 [color="#1565C0" penwidth="1" style="dashed" arrowhead="none" weight=10];

    // Process flow in rank=same subgraph
    { rank=same;
        P1;
        P2;
        P3;
        P4;
        P5;
        // Normal sequence
        P1:e -> P2:w [color="#2E7D32" penwidth="1" style="solid" arrowhead="vee"];
        // P2 connects to both P3 AND P4 - this causes crossing
        P2:e -> P3:w [color="#2E7D32" penwidth="1" style="solid" arrowhead="vee"];
        P2:e -> P4:w [color="#2E7D32" penwidth="1" style="solid" arrowhead="vee"];
        P3:e -> P4:w [color="#2E7D32" penwidth="1" style="solid" arrowhead="vee"];
        P4:e -> P5:w [color="#2E7D32" penwidth="1" style="solid" arrowhead="vee"];
    }
}`;

            renderTest('test1', viz, dot1);

            // Test 2: Reduced ranksep
            const dot2 = `
digraph VADGraph {
    rankdir=TB;
    node [fontname="Arial"];
    edge [fontname="Arial", fontsize=10];
    splines=curved;
    nodesep=0.8;
    ranksep=0.3;

    // Process nodes
    P1 [label=<Процесс 1> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P2 [label=<Процесс 2> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P3 [label=<Процесс 3> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P4 [label=<Процесс 4> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];

    // Executor nodes
    E1 [label=<<FONT POINT-SIZE="9">Исполнитель 1</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E2 [label=<<FONT POINT-SIZE="9">Исп. 1, Исп. 2</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E3 [label=<<FONT POINT-SIZE="9">Исполнитель 3</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E4 [label=<<FONT POINT-SIZE="9">Исп. 3, Исп. 4</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];

    // All executors on same row
    { rank=same; E1; E2; E3; E4; }

    // Visible hasExecutor edges
    P1 -> E1 [color="#1565C0" penwidth="1" style="dashed" arrowhead="none" weight=10];
    P2 -> E2 [color="#1565C0" penwidth="1" style="dashed" arrowhead="none" weight=10];
    P3 -> E3 [color="#1565C0" penwidth="1" style="dashed" arrowhead="none" weight=10];
    P4 -> E4 [color="#1565C0" penwidth="1" style="dashed" arrowhead="none" weight=10];

    // Process flow
    { rank=same;
        P1; P2; P3; P4;
        P1:e -> P2:w [color="#2E7D32" penwidth="1" style="solid" arrowhead="vee"];
        P2:e -> P3:w [color="#2E7D32" penwidth="1" style="solid" arrowhead="vee"];
        P3:e -> P4:w [color="#2E7D32" penwidth="1" style="solid" arrowhead="vee"];
    }
}`;

            renderTest('test2', viz, dot2);

            // Test 3: Fix line crossing with additional constraints
            // For P2->P4 edge that skips P3, we route it ABOVE or BELOW the nodes
            const dot3 = `
digraph VADGraph {
    rankdir=TB;
    node [fontname="Arial"];
    edge [fontname="Arial", fontsize=10];
    splines=spline;
    nodesep=0.8;
    ranksep=0.3;

    // Process nodes
    P1 [label=<Процесс 1> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P2 [label=<Процесс 2> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P3 [label=<Процесс 3> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P4 [label=<Процесс 4> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P5 [label=<Процесс 5> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];

    // Executor nodes
    E1 [label=<<FONT POINT-SIZE="9">Исполнитель 1</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E2 [label=<<FONT POINT-SIZE="9">Исп. 1, Исп. 2</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E3 [label=<<FONT POINT-SIZE="9">Исполнитель 3</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E4 [label=<<FONT POINT-SIZE="9">Исп. 3, Исп. 4</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E5 [label=<<FONT POINT-SIZE="9">Исполнитель 5</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];

    // All executors on same row
    { rank=same; E1; E2; E3; E4; E5; }

    // Visible hasExecutor edges
    P1 -> E1 [color="#1565C0" penwidth="1" style="dashed" arrowhead="none" weight=10];
    P2 -> E2 [color="#1565C0" penwidth="1" style="dashed" arrowhead="none" weight=10];
    P3 -> E3 [color="#1565C0" penwidth="1" style="dashed" arrowhead="none" weight=10];
    P4 -> E4 [color="#1565C0" penwidth="1" style="dashed" arrowhead="none" weight=10];
    P5 -> E5 [color="#1565C0" penwidth="1" style="dashed" arrowhead="none" weight=10];

    // Process flow - use north ports for skip-edges to avoid crossing
    { rank=same;
        P1;
        P2;
        P3;
        P4;
        P5;
        // Normal sequential flow
        P1:e -> P2:w [color="#2E7D32" penwidth="1" style="solid" arrowhead="vee"];
        P2:e -> P3:w [color="#2E7D32" penwidth="1" style="solid" arrowhead="vee"];
        // Skip edge P2->P4 uses north ports to go ABOVE nodes
        P2:n -> P4:n [color="#2E7D32" penwidth="1" style="solid" arrowhead="vee"];
        P3:e -> P4:w [color="#2E7D32" penwidth="1" style="solid" arrowhead="vee"];
        P4:e -> P5:w [color="#2E7D32" penwidth="1" style="solid" arrowhead="vee"];
    }
}`;

            renderTest('test3', viz, dot3);

            // Test 4: VAD Row Wrapping
            const dot4 = `
digraph VADGraph {
    rankdir=TB;
    node [fontname="Arial"];
    edge [fontname="Arial", fontsize=10];
    splines=curved;
    nodesep=0.8;
    ranksep=0.3;

    // Row 1: Processes 1-4
    P1 [label=<Процесс 1> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P2 [label=<Процесс 2> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P3 [label=<Процесс 3> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P4 [label=<Процесс 4> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];

    // Row 2: Processes 5-8
    P5 [label=<Процесс 5> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P6 [label=<Процесс 6> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P7 [label=<Процесс 7> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P8 [label=<Процесс 8> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];

    // Executors Row 1
    E1 [label=<<FONT POINT-SIZE="9">Исп. 1</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E2 [label=<<FONT POINT-SIZE="9">Исп. 2</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E3 [label=<<FONT POINT-SIZE="9">Исп. 3</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E4 [label=<<FONT POINT-SIZE="9">Исп. 4</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];

    // Executors Row 2
    E5 [label=<<FONT POINT-SIZE="9">Исп. 5</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E6 [label=<<FONT POINT-SIZE="9">Исп. 6</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E7 [label=<<FONT POINT-SIZE="9">Исп. 7</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E8 [label=<<FONT POINT-SIZE="9">Исп. 8</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];

    // Row 1 CDS processes
    { rank=same; P1; P2; P3; P4; }
    // Row 1 Executors
    { rank=same; E1; E2; E3; E4; }
    // Row 2 CDS processes
    { rank=same; P5; P6; P7; P8; }
    // Row 2 Executors
    { rank=same; E5; E6; E7; E8; }

    // HasExecutor edges
    P1 -> E1 [color="#1565C0" style="dashed" arrowhead="none" weight=10];
    P2 -> E2 [color="#1565C0" style="dashed" arrowhead="none" weight=10];
    P3 -> E3 [color="#1565C0" style="dashed" arrowhead="none" weight=10];
    P4 -> E4 [color="#1565C0" style="dashed" arrowhead="none" weight=10];
    P5 -> E5 [color="#1565C0" style="dashed" arrowhead="none" weight=10];
    P6 -> E6 [color="#1565C0" style="dashed" arrowhead="none" weight=10];
    P7 -> E7 [color="#1565C0" style="dashed" arrowhead="none" weight=10];
    P8 -> E8 [color="#1565C0" style="dashed" arrowhead="none" weight=10];

    // Process flow Row 1
    P1:e -> P2:w [color="#2E7D32" penwidth="1" arrowhead="vee"];
    P2:e -> P3:w [color="#2E7D32" penwidth="1" arrowhead="vee"];
    P3:e -> P4:w [color="#2E7D32" penwidth="1" arrowhead="vee"];

    // Connection between rows (P4 -> P5) - uses south port on E4 to flow down
    E4 -> P5 [color="#2E7D32" penwidth="1" arrowhead="vee" style="solid" constraint=true];

    // Process flow Row 2
    P5:e -> P6:w [color="#2E7D32" penwidth="1" arrowhead="vee"];
    P6:e -> P7:w [color="#2E7D32" penwidth="1" arrowhead="vee"];
    P7:e -> P8:w [color="#2E7D32" penwidth="1" arrowhead="vee"];
}`;

            renderTest('test4', viz, dot4);

            // Test 5: Combined fixes
            const dot5 = `
digraph VADGraph {
    rankdir=TB;
    node [fontname="Arial"];
    edge [fontname="Arial", fontsize=10];
    splines=spline;
    nodesep=0.8;
    ranksep=0.3;

    // Row 1: Processes 1-4
    P1 [label=<Процесс 1> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P2 [label=<Процесс 2> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P3 [label=<Процесс 3> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P4 [label=<Процесс 4> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];

    // Row 2: Processes 5-8
    P5 [label=<Процесс 5> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P6 [label=<Процесс 6> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P7 [label=<Процесс 7> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];
    P8 [label=<Процесс 8> shape="cds" color="#2E7D32" fillcolor="#A5D6A7" fontsize="11" style="filled"];

    // Executors Row 1
    E1 [label=<<FONT POINT-SIZE="9">Исп. 1</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E2 [label=<<FONT POINT-SIZE="9">Исп. 2</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E3 [label=<<FONT POINT-SIZE="9">Исп. 3</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E4 [label=<<FONT POINT-SIZE="9">Исп. 4</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];

    // Executors Row 2
    E5 [label=<<FONT POINT-SIZE="9">Исп. 5</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E6 [label=<<FONT POINT-SIZE="9">Исп. 6</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E7 [label=<<FONT POINT-SIZE="9">Исп. 7</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];
    E8 [label=<<FONT POINT-SIZE="9">Исп. 8</FONT>> shape="ellipse" color="#B8860B" fillcolor="#FFFFCC" style="filled"];

    // Layout ordering
    { rank=same; P1; P2; P3; P4; }
    { rank=same; E1; E2; E3; E4; }
    { rank=same; P5; P6; P7; P8; }
    { rank=same; E5; E6; E7; E8; }

    // HasExecutor edges (minimal distance with ranksep=0.3)
    P1 -> E1 [color="#1565C0" style="dashed" arrowhead="none" weight=10];
    P2 -> E2 [color="#1565C0" style="dashed" arrowhead="none" weight=10];
    P3 -> E3 [color="#1565C0" style="dashed" arrowhead="none" weight=10];
    P4 -> E4 [color="#1565C0" style="dashed" arrowhead="none" weight=10];
    P5 -> E5 [color="#1565C0" style="dashed" arrowhead="none" weight=10];
    P6 -> E6 [color="#1565C0" style="dashed" arrowhead="none" weight=10];
    P7 -> E7 [color="#1565C0" style="dashed" arrowhead="none" weight=10];
    P8 -> E8 [color="#1565C0" style="dashed" arrowhead="none" weight=10];

    // Process flow Row 1 - with skip edge using north ports
    P1:e -> P2:w [color="#2E7D32" penwidth="1" arrowhead="vee"];
    P2:e -> P3:w [color="#2E7D32" penwidth="1" arrowhead="vee"];
    // Skip edge P2->P4 goes above via north ports (avoids crossing P3)
    P2:n -> P4:n [color="#2E7D32" penwidth="1" arrowhead="vee"];
    P3:e -> P4:w [color="#2E7D32" penwidth="1" arrowhead="vee"];

    // Row transition (P4 -> P5)
    E4 -> P5 [color="#2E7D32" penwidth="1" arrowhead="vee" constraint=true];

    // Process flow Row 2
    P5:e -> P6:w [color="#2E7D32" penwidth="1" arrowhead="vee"];
    P6:e -> P7:w [color="#2E7D32" penwidth="1" arrowhead="vee"];
    P7:e -> P8:w [color="#2E7D32" penwidth="1" arrowhead="vee"];
}`;

            renderTest('test5', viz, dot5);
        }

        function renderTest(id, viz, dot) {
            try {
                document.getElementById(id).innerHTML = viz.renderSVGElement(dot).outerHTML;
            } catch(e) {
                document.getElementById(id).innerHTML = '<pre style="color:red">' + e + '</pre>';
            }
            document.getElementById(id).innerHTML += '<pre>' + dot + '</pre>';
        }

        runTests();
    </script>
</body>
</html>
