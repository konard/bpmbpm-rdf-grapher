# Del Concept\Individ - Документация модуля удаления

## Обзор

Модуль `del_concept_individ.js` предоставляет функциональность для удаления концептов и индивидов в системе RDF Grapher. Модуль следует принципам SPARQL-driven программирования, описанным в [sparql-driven-programming.md](sparql-driven-programming.md).

## Поддерживаемые операции удаления

| Операция | Описание | Целевой граф |
|----------|----------|--------------|
| Удалить концепт процесса | Удаление vad:TypeProcess из ptree | vad:ptree |
| Удалить концепт исполнителя | Удаление vad:TypeExecutor из rtree | vad:rtree |
| Удалить индивид процесса | Удаление триплетов индивида из TriG | vad:VADProcessDia |
| Удалить индивид исполнителя | Удаление vad:includes из TriG | vad:VADProcessDia |
| Удалить схему процесса (TriG) | Удаление всего графа TriG | vad:ptree + TriG |

---

## Алгоритм работы

### Общая последовательность

```
1. Пользователь нажимает "Del Concept\Individ"
         ↓
2. Открывается модальное окно выбора операции
         ↓
3. Выбор типа операции из dropdown
         ↓
4. Загрузка доступных элементов (концепты/индивиды/TriG)
         ↓
5. Выбор элемента для удаления
         ↓
6. Выполнение проверок (для концептов)
         ↓
7. Отображение промежуточных SPARQL запросов
         ↓
8. Генерация итогового SPARQL DELETE запроса
         ↓
9. Вывод запроса в "Result in SPARQL"
         ↓
10. Выполнение запроса кнопкой "Применить..."
```

---

## Проверки перед удалением

### 1. Удаление концепта процесса (vad:TypeProcess)

**Выполняемые проверки:**

| Проверка | SPARQL запрос | Сообщение об ошибке |
|----------|---------------|---------------------|
| Наличие индивидов | `CHECK_PROCESS_INDIVIDUALS` | "Найдено N индивидов процесса. Сначала удалите все индивиды." |
| Наличие схемы (hasTrig) | `CHECK_PROCESS_SCHEMA` | "Найдено N схем процесса. Сначала удалите все схемы." |
| Наличие дочерних процессов | `CHECK_CHILDREN_PROCESSES` | "Найдено N дочерних процессов. Сначала измените их vad:hasParentObj." |

**Последовательность удаления:**
1. Сначала удалите все индивиды процесса
2. Затем удалите схему процесса (TriG)
3. Измените vad:hasParentObj у дочерних процессов
4. Только после этого можно удалить концепт

### 2. Удаление концепта исполнителя (vad:TypeExecutor)

**Выполняемые проверки:**

| Проверка | SPARQL запрос | Сообщение об ошибке |
|----------|---------------|---------------------|
| Использование в TriG | `CHECK_EXECUTOR_USAGE` | "Исполнитель используется в N TriG. Сначала удалите эти индивиды исполнителя." |
| Наличие дочерних исполнителей | `CHECK_CHILDREN_EXECUTORS` | "Найдено N дочерних исполнителей. Сначала измените их vad:hasParentObj." |

**Последовательность удаления:**
1. Удалите все vad:includes с данным исполнителем из TriG
2. Измените vad:hasParentObj у дочерних исполнителей
3. Только после этого можно удалить концепт

### 3. Удаление индивида процесса

**Проверки не требуются.**

Кнопка "Показать индивиды" выводит список всех индивидов процесса для выбранного концепта.

**Что удаляется:**
- Все триплеты, где subject = URI индивида процесса

### 4. Удаление индивида исполнителя

**Проверки не требуются.**

Кнопка "Показать индивиды" выводит список всех TriG, где используется выбранный исполнитель.

**Что удаляется:**
- Триплеты `?processIndivid vad:includes <executorUri>` из соответствующих TriG

### 5. Удаление схемы процесса (TriG)

**Проверки не требуются.**

**Что удаляется:**
1. Триплет `<conceptUri> vad:hasTrig <trigUri>` из vad:ptree
2. Весь граф TriG (DROP GRAPH)

---

## Сообщения об ошибках

### Критические ошибки (блокируют удаление)

| Код | Сообщение | Решение |
|-----|-----------|---------|
| E001 | "Найдено N индивидов процесса" | Удалите индивиды через "Удалить индивид процесса" |
| E002 | "Найдено N схем процесса" | Удалите схемы через "Удалить схему процесса" |
| E003 | "Найдено N дочерних процессов" | Измените vad:hasParentObj у дочерних элементов |
| E004 | "Исполнитель используется в N TriG" | Удалите индивиды исполнителя через "Удалить индивид исполнителя" |
| E005 | "Найдено N дочерних исполнителей" | Измените vad:hasParentObj у дочерних элементов |

### Предупреждения

| Код | Сообщение | Описание |
|-----|-----------|----------|
| W001 | "Не найден концепт процесса для данного TriG" | TriG не связан с концептом через vad:hasTrig |
| W002 | "Индивиды не найдены" | Для выбранного концепта нет индивидов |

### Информационные сообщения

| Сообщение | Контекст |
|-----------|----------|
| "Проверки пройдены. Концепт можно удалить." | Все проверки успешны |
| "SPARQL DELETE запрос... успешно сгенерирован" | Запрос готов к выполнению |

---

## Риски и рекомендации

### Потенциальные риски

1. **Нарушение целостности иерархии (treeview)**
   - Удаление концепта без проверки дочерних элементов может "осиротить" дочерние узлы
   - Решение: проверка CHECK_CHILDREN_* блокирует удаление

2. **Удаление TriG типа VADProcessDia**
   - При DROP GRAPH удаляются все триплеты графа TriG
   - **Анализ:** TriG типа VADProcessDia является "автономным" - он ссылается через `vad:hasParentObj` на концепт процесса (например, `vad:t_p1.1 vad:hasParentObj vad:p1.1`), а не на родительскую схему. Поэтому удаление TriG не нарушает связей с другими схемами.
   - При удалении схемы также удаляется триплет `vad:hasTrig` в ptree, что корректно отражает отсутствие схемы у данного концепта
   - **Риск минимален:** Удаление TriG не приводит к каскадным нарушениям целостности, так как другие TriG и концепты не зависят от удаляемой схемы напрямую
   - **Рекомендация:** Перед удалением убедитесь, что схема больше не нужна. Восстановление возможно только из резервной копии

3. **Несогласованность после удаления индивида исполнителя**
   - Если исполнитель упоминается в нескольких TriG, удаление из одного может быть неполным
   - Решение: модуль удаляет из ВСЕХ найденных TriG

4. **Циклические зависимости vad:hasParentObj**
   - При изменении родителя возможно создание цикла
   - Решение: на этапе редактирования hasParentObj нужна отдельная проверка (не реализовано в этом модуле)

### Рекомендации по использованию

1. **Перед удалением концепта:**
   - Просмотрите все индивиды через "Показать индивиды"
   - Убедитесь, что понимаете, что будет удалено
   - Проверьте, нет ли дочерних элементов

2. **При удалении схемы (TriG):**
   - Помните, что удаляется ВСЯ схема целиком
   - Нет возможности восстановить без резервной копии

3. **Порядок удаления для полной очистки концепта:**
   ```
   1. Удалить все индивиды процесса
   2. Удалить все индивиды исполнителей
   3. Удалить схему (TriG)
   4. Исправить vad:hasParentObj у дочерних
   5. Удалить концепт
   ```

---

## Генерируемые SPARQL запросы

### DELETE концепта

```sparql
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX vad: <http://example.org/vad#>

DELETE WHERE {
    GRAPH vad:ptree {
        vad:ConceptName ?p ?o .
    }
}
```

### DELETE индивида процесса

```sparql
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX vad: <http://example.org/vad#>

# Удаление всех триплетов индивида процесса
DELETE WHERE {
    GRAPH vad:ProcessTriG {
        vad:ProcessIndivid ?p ?o .
    }
}
```

### DELETE индивида исполнителя

```sparql
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX vad: <http://example.org/vad#>

# Удаление связи vad:includes для исполнителя
DELETE DATA {
    GRAPH vad:ProcessTriG {
        vad:ProcessIndivid vad:includes vad:ExecutorName .
    }
}
```

### DELETE схемы (TriG)

```sparql
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX vad: <http://example.org/vad#>

# Удаление триплета vad:hasTrig в концепте процесса
DELETE DATA {
    GRAPH vad:ptree {
        vad:ProcessConcept vad:hasTrig vad:ProcessTriG .
    }
};

# Удаление всего графа TriG
DROP GRAPH vad:ProcessTriG
```

---

## Связанные файлы

- [create_new_concept.js](../create_new_concept.js) - Модуль создания концептов (аналог для создания)
- [sparql-driven-programming.md](sparql-driven-programming.md) - Руководство по SPARQL-driven программированию
- [ui-documentation.md](ui-documentation.md) - Документация UI
- [vad-basic-ontology.ttl](../vad-basic-ontology.ttl) - Базовая онтология VAD
- [vad-basic-ontology_tech_Appendix.ttl](../vad-basic-ontology_tech_Appendix.ttl) - Технологическое приложение

---

## История изменений

| Версия | Дата | Описание |
|--------|------|----------|
| 1.0 | 2026-01-29 | Первоначальная версия модуля |

---

## Ссылки

- [Issue #211](https://github.com/bpmbpm/rdf-grapher/issues/211) - Исходный запрос на реализацию
- [SPARQL 1.1 Update](https://www.w3.org/TR/sparql11-update/) - Спецификация SPARQL UPDATE
