# Руководство по интеграции Protege с RDF Grapher

## Обзор

Данное руководство описывает использование [Protege](https://protege.stanford.edu/) в качестве редактора онтологий для проекта RDF Grapher (ver8tree). Protege — это бесплатный редактор онтологий с открытым исходным кодом, поддерживающий спецификации OWL 2 и RDF.

## Содержание

1. [Установка](#установка)
2. [Поддерживаемые форматы файлов](#поддерживаемые-форматы-файлов)
3. [Открытие файлов проекта в Protege](#открытие-файлов-проекта-в-protege)
4. [Редактирование онтологии](#редактирование-онтологии)
5. [Работа с Tech Appendix](#работа-с-tech-appendix)
6. [Добавление новых типов TriG](#добавление-новых-типов-trig)
7. [Сохранение и экспорт](#сохранение-и-экспорт)
8. [Интеграция с RDF Grapher](#интеграция-с-rdf-grapher)
9. [Использование Reasoner (логического вывода)](#использование-reasoner-логического-вывода)
10. [WebProtege (веб-версия)](#webprotege-веб-версия)
11. [Примеры](#примеры)
12. [Устранение неполадок](#устранение-неполадок)

---

## Установка

### Protege Desktop

1. Скачайте Protege Desktop с сайта: https://protege.stanford.edu/software.php
2. Установите приложение для вашей операционной системы (Windows, macOS, Linux)
3. Запустите Protege

### WebProtege (Альтернатива)

Для совместного редактирования используйте WebProtege: https://webprotege.stanford.edu/

---

## Поддерживаемые форматы файлов

Protege поддерживает следующие форматы:

| Формат | Расширение | Чтение | Запись | Примечания |
|--------|------------|--------|--------|------------|
| Turtle | .ttl | Да | Да | Человекочитаемый, рекомендуется для редактирования |
| RDF/XML | .rdf, .owl | Да | Да | Стандартный формат |
| OWL/XML | .owx | Да | Да | XML-формат, специфичный для OWL |
| JSON-LD | .jsonld | Да | Да | Формат на основе JSON |

**Важно:** Protege может напрямую открывать .ttl файлы через `File -> Open...` (Ctrl+O).

---

## Открытие файлов проекта в Protege

### Открытие vad-basic-ontology.ttl

1. Запустите Protege Desktop
2. Выберите `File -> Open...` (или нажмите `Ctrl+O`)
3. Перейдите к файлу `ver8tree/vad-basic-ontology.ttl`
4. Нажмите "Open"

### Открытие vad-basic-ontology_tech_Appendix.ttl

1. Выберите `File -> Open...`
2. Перейдите к файлу `ver8tree/vad-basic-ontology_tech_Appendix.ttl`
3. Нажмите "Open"

**Совет:** Если двойной клик не работает, всегда используйте меню File для открытия .ttl файлов.

---

## Редактирование онтологии

### Базовая навигация в Protege

После открытия TTL-файла Protege отображает несколько вкладок:

- **Active Ontology** — Обзор и метаданные
- **Entities** — Просмотр всех классов, свойств и индивидов
- **Classes** — Иерархическое представление классов
- **Object Properties** — Отношения между сущностями
- **Data Properties** — Атрибуты с литеральными значениями
- **Individuals** — Экземпляры классов

### Редактирование определений классов

1. Перейдите на вкладку **Classes**
2. Найдите класс в иерархии (например, `vad:Process`)
3. Кликните на имя класса
4. Редактируйте свойства в правой панели:
   - rdfs:label — Отображаемое имя
   - rdfs:comment — Описание
   - rdfs:subClassOf — Родительский класс

### Редактирование определений свойств

1. Перейдите на вкладку **Object Properties** или **Data Properties**
2. Выберите свойство (например, `vad:hasParentObj`)
3. Редактируйте в правой панели:
   - rdfs:domain — Какие типы могут иметь это свойство
   - rdfs:range — Какие значения допустимы

---

## Работа с Tech Appendix

Файл `vad-basic-ontology_tech_Appendix.ttl` содержит технические классы для настройки окна Smart Design в RDF Grapher.

### Редактирование vad:ConceptProcessPredicate

Этот объект определяет предикаты, доступные для TypeProcess в контексте ptree.

**В Protege:**

1. Откройте `vad-basic-ontology_tech_Appendix.ttl`
2. Перейдите на вкладку **Individuals**
3. Найдите `vad:ConceptProcessPredicate`
4. Редактируйте значения `vad:includePredicate`

**Пример: Добавление нового предиката `vad:hasCategory`**

В редакторе индивидов Protege добавьте в `vad:includePredicate`:
```
vad:hasCategory
```

**Результат в TTL:**
```turtle
vad:ConceptProcessPredicate
    rdf:type vad:Tech ;
    rdfs:label "ConceptProcessPredicate" ;
    vad:includePredicate rdf:type, rdfs:label, dcterms:description, vad:hasTrig, vad:hasCategory ;
    # ... остальная часть определения
```

### Редактирование vad:IndividProcessPredicate

Для свойств индивидуальных процессов в контексте VADProcessDia:

1. Найдите `vad:IndividProcessPredicate` в Individuals
2. Редактируйте `vad:includePredicate` для добавления/удаления предикатов
3. Редактируйте `vad:autoGeneratedPredicate` для автозаполняемых значений

### Создание новых Tech-объектов

Для создания нового Tech-объекта (например, для нового Subject Type):

1. Перейдите на вкладку **Individuals**
2. Нажмите кнопку "Add Individual"
3. Назовите по шаблону: `vad:Concept{Type}Predicate`
4. Установите `rdf:type` в `vad:Tech`
5. Добавьте `vad:includePredicate` со списком предикатов
6. Добавьте `vad:contextTriGType` для указания контекста

---

## Добавление новых типов TriG

### Пример: Добавление варианта vad:ObjectTree

Для добавления нового типа TriG, расширяющего ObjectTree:

1. Откройте `vad-basic-ontology.ttl` в Protege
2. Перейдите на вкладку **Classes**
3. Щёлкните правой кнопкой мыши на `vad:ObjectTree`
4. Выберите "Add subclass..."
5. Назовите его (например, `vad:CustomTree`)
6. Добавьте свойства:
   - rdfs:label
   - rdfs:comment
   - dcterms:description

**Результат в TTL:**
```turtle
vad:CustomTree
    rdf:type rdfs:Class, owl:Class ;
    rdfs:subClassOf vad:ObjectTree ;
    rdfs:label "CustomTree" ;
    rdfs:comment "Пользовательский тип дерева для конкретного случая использования" ;
    dcterms:description "Пользовательский вариант ObjectTree" .
```

### Добавление Tech-предикатов для нового типа

После создания типа добавьте Tech-объект в `tech_Appendix.ttl`:

```turtle
vad:ConceptCustomTreePredicate
    rdf:type vad:Tech ;
    rdfs:label "ConceptCustomTreePredicate" ;
    vad:includePredicate rdf:type, rdfs:label, vad:hasParentObj ;
    vad:contextTriGType vad:CustomTree ;
    rdfs:comment "Предикаты для типа CustomTree" ;
    dcterms:description "Группа свойств для CustomTree" .
```

---

## Сохранение и экспорт

### Сохранение в формате Turtle

1. `File -> Save As...`
2. Выберите формат: **Turtle Syntax**
3. Выберите расположение
4. Нажмите "Save"

### Важные замечания по сохранению

- Protege может переупорядочить триплеты при сохранении
- Комментарии в исходном TTL могут быть потеряны
- Всегда сохраняйте резервную копию исходных файлов

### Рекомендуемый рабочий процесс

1. Сделайте резервную копию исходного файла
2. Откройте и отредактируйте в Protege
3. Сохраните с новым именем (например, `*_edited.ttl`)
4. Просмотрите изменения с помощью diff-инструмента
5. Примените только необходимые изменения к исходному файлу

---

## Интеграция с RDF Grapher

### Загрузка отредактированной онтологии

После редактирования файлов в Protege:

1. Сохраните файл в формате Turtle (.ttl)
2. Поместите файл в папку `ver8tree/` (при необходимости заменив оригинал)
3. Откройте https://bpmbpm.github.io/rdf-grapher/ver8tree/
4. Приложение загрузит обновлённую онтологию

### Эффект изменений

| Изменение | Эффект в RDF Grapher |
|-----------|---------------------|
| Редактирование `vad:ConceptProcessPredicate.includePredicate` | Новые предикаты появляются в выпадающем списке Predicate для TypeProcess в ptree |
| Редактирование `vad:IndividProcessPredicate.includePredicate` | Новые предикаты появляются для TypeProcess в VADProcessDia |
| Добавление нового класса | Новая опция в выпадающем списке Subject Type (если добавлен в VAD_ALLOWED_TYPES) |
| Редактирование `vad:hasNodeStyle` | Изменяет внешний вид узла процесса на диаграмме |

### Тестирование изменений

1. Загрузите модифицированную онтологию в RDF Grapher
2. Выберите режим "SPARQL Smart Design"
3. Протестируйте окно Smart Design:
   - Проверьте выпадающий список Subject Type
   - Проверьте значения выпадающего списка Predicate
   - Проверьте предложения Object

---

## Использование Reasoner (логического вывода)

Protege включает встроенные reasoner'ы (логические движки), которые можно использовать для автоматического вычисления значений на основе определённых правил. Это особенно полезно для вычисления таких свойств, как `vad:processSubtype`.

### Что такое Reasoner?

Reasoner (рассуждатель, логический вывод) — это компонент, который автоматически выводит новые факты из существующих данных на основе заданных правил и ограничений онтологии.

### Включение Reasoner в Protege

1. Откройте онтологию в Protege
2. Перейдите в меню `Reasoner`
3. Выберите reasoner:
   - **Pellet** — полнофункциональный OWL 2 reasoner
   - **HermiT** — эффективный OWL 2 reasoner
   - **FaCT++** — быстрый reasoner для OWL DL
4. Выберите `Reasoner -> Start reasoner` (или нажмите `Ctrl+R`)

### Пример: Вычисление vad:processSubtype

Свойство `vad:processSubtype` используется для классификации процессов на основе их положения в иерархии и наличия схемы детализации.

#### Подтипы процессов

| Подтип | Условие hasTrig | Условие положения | Описание |
|--------|-----------------|-------------------|----------|
| `DetailedChild` | Есть `vad:hasTrig` в ptree | Индивид в схеме родительского процесса | Детализированный подпроцесс |
| `DetailedExternal` | Есть `vad:hasTrig` в ptree | Индивид во внешней схеме | Детализированный внешний процесс |
| `notDetailedChild` | Нет `vad:hasTrig` в ptree | Индивид в схеме родительского процесса | Недетализированный подпроцесс |
| `notDetailedExternal` | Нет `vad:hasTrig` в ptree | Индивид во внешней схеме | Недетализированный внешний процесс |
| `NotDefinedType` | Любое | `hasParentObj = pNotDefined` | Процесс с неопределённым родителем |

#### Алгоритм определения processSubtype

```
ДЛЯ КАЖДОГО TriG типа VADProcessDia (trigUri):
    ДЛЯ КАЖДОГО индивида процесса (processUri) в этом TriG:
        1. Получить hasParentObj индивида из ptree
        2. ЕСЛИ hasParentObj == pNotDefined:
             processSubtype = NotDefinedType
             ПЕРЕЙТИ к следующему индивиду

        3. Получить hasParentObj TriG (trigParentObj)
           (это концепт процесса, которому принадлежит схема)

        4. Определить isChild:
           isChild = (hasParentObj индивида == trigParentObj)
           (индивид является подпроцессом, если его родитель == владелец схемы)

        5. Проверить наличие hasTrig для концепта процесса в ptree:
           hasDetailingSchema = (концепт имеет vad:hasTrig)

        6. Вычислить processSubtype:
           ЕСЛИ hasDetailingSchema:
               ЕСЛИ isChild: processSubtype = DetailedChild
               ИНАЧЕ: processSubtype = DetailedExternal
           ИНАЧЕ:
               ЕСЛИ isChild: processSubtype = notDetailedChild
               ИНАЧЕ: processSubtype = notDetailedExternal
```

#### Использование SWRL-правил в Protege

SWRL (Semantic Web Rule Language) позволяет определять правила вывода. Для добавления правил:

1. Перейдите на вкладку **Rules** (может потребоваться установка плагина)
2. Создайте новое правило

**Пример правила для NotDefinedType:**
```
vad:TypeProcess(?p) ^ vad:hasParentObj(?p, vad:pNotDefined)
    -> vad:processSubtype(?p, vad:NotDefinedType)
```

**Пример правила для DetailedChild:**
```
vad:TypeProcess(?p) ^
vad:hasParentObj(?p, ?parent) ^
vad:hasTrig(?p, ?schema) ^
vad:isSubprocessTrig(?p, ?currentTrig) ^
vad:hasParentObj(?currentTrig, ?trigParent) ^
sameAs(?parent, ?trigParent) ^
differentFrom(?parent, vad:pNotDefined)
    -> vad:processSubtype(?p, vad:DetailedChild)
```

**Пример правила для notDetailedChild:**
```
vad:TypeProcess(?p) ^
vad:hasParentObj(?p, ?parent) ^
NOT EXISTS { vad:hasTrig(?p, ?schema) } ^
vad:isSubprocessTrig(?p, ?currentTrig) ^
vad:hasParentObj(?currentTrig, ?trigParent) ^
sameAs(?parent, ?trigParent) ^
differentFrom(?parent, vad:pNotDefined)
    -> vad:processSubtype(?p, vad:notDetailedChild)
```

### SPARQL-запросы для вычисления processSubtype

Вместо использования reasoner можно выполнять SPARQL CONSTRUCT запросы для вычисления значений.

**SPARQL для определения notDetailedChild:**
```sparql
PREFIX vad: <http://example.org/vad#>
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>

CONSTRUCT {
    ?process vad:processSubtype vad:notDetailedChild .
}
WHERE {
    GRAPH ?trig {
        ?trig rdf:type vad:VADProcessDia .
        ?trig vad:hasParentObj ?trigParent .
        ?process vad:isSubprocessTrig ?trig .
    }

    GRAPH vad:ptree {
        ?process rdf:type vad:TypeProcess .
        ?process vad:hasParentObj ?processParent .
        # НЕТ vad:hasTrig
        FILTER NOT EXISTS { ?process vad:hasTrig ?schema . }
    }

    # Условия:
    # 1. Процесс НЕ имеет схемы детализации
    # 2. Родитель процесса совпадает с владельцем TriG
    # 3. Родитель != pNotDefined
    FILTER(?processParent = ?trigParent)
    FILTER(?processParent != vad:pNotDefined)
}
```

### Просмотр результатов логического вывода

После запуска reasoner:

1. Перейдите на вкладку **Individuals**
2. Выберите интересующий процесс
3. В секции "Property assertions" найдите `vad:processSubtype`
4. Вычисленные (inferred) значения отображаются жёлтым фоном

### Экспорт результатов вывода

1. `File -> Export inferred axioms as ontology...`
2. Выберите формат (Turtle рекомендуется)
3. Сохраните файл

---

## WebProtege (веб-версия)

WebProtege — это веб-версия Protege, доступная по адресу https://webprotege.stanford.edu/. Она позволяет работать с онтологиями без установки локального приложения.

### Преимущества WebProtege

| Функция | WebProtege | Protege Desktop |
|---------|------------|-----------------|
| Установка | Не требуется | Требуется |
| Совместная работа | Встроенная | Ограниченная |
| Комментарии и обсуждения | Да | Нет |
| История изменений | Да | Нет |
| Контроль доступа | Да | Нет |
| Оффлайн работа | Нет | Да |
| Полный контроль reasoner | Нет | Да |

### Начало работы с WebProtege

1. Перейдите на https://webprotege.stanford.edu/
2. Зарегистрируйтесь или войдите в систему
3. Создайте новый проект или импортируйте существующую онтологию

### Импорт онтологии

1. Нажмите "Create New Project"
2. Введите название проекта
3. Выберите "Upload ontology"
4. Загрузите файл `vad-basic-ontology.ttl` или `vad-basic-ontology_tech_Appendix.ttl`

### Особенности работы в WebProtege

**Редактирование классов:**
- Навигация по иерархии классов в левой панели
- Редактирование аннотаций в правой панели
- История изменений доступна для каждого элемента

**Совместная работа:**
- Приглашение участников по email
- Комментарии к изменениям
- Уведомления об изменениях

**Экспорт:**
1. `Project -> Download`
2. Выберите формат: Turtle (.ttl)
3. Скачайте файл

### Ограничения WebProtege

- Не поддерживает все плагины Protege Desktop
- Reasoner функциональность ограничена
- Требуется интернет-соединение
- Размер загружаемых файлов ограничен

### Рекомендации по выбору

**Используйте WebProtege когда:**
- Нужна совместная работа над онтологией
- Работа ведётся из разных мест/устройств
- Требуется отслеживание истории изменений
- Важны комментарии и обсуждения

**Используйте Protege Desktop когда:**
- Требуется полнофункциональный reasoner
- Нужна работа с большими онтологиями
- Требуется оффлайн работа
- Нужны специфические плагины

---

## Примеры

### Пример 1: Добавление нового предиката для процессов

**Цель:** Добавить предикат `vad:priority` для концептов процессов.

**Шаги:**
1. Откройте `vad-basic-ontology.ttl` в Protege
2. Добавьте новое Data Property `vad:priority`:
   - Domain: `vad:TypeProcess`
   - Range: `xsd:integer`
3. Сохраните файл
4. Откройте `vad-basic-ontology_tech_Appendix.ttl`
5. Найдите `vad:ConceptProcessPredicate`
6. Добавьте `vad:priority` в `vad:includePredicate`
7. Сохраните файл

**Результат:** В Smart Design при редактировании TypeProcess в ptree будет доступен предикат "priority".

### Пример 2: Создание нового стиля подтипа процесса

**Цель:** Добавить новый визуальный стиль для "критических" процессов.

**Шаги:**
1. Откройте `vad-basic-ontology_tech_Appendix.ttl`
2. Добавьте новый класс:
```turtle
vad:Critical
    rdf:type rdfs:Class, owl:Class ;
    rdfs:label "Critical" ;
    vad:hasNodeStyle "shape=\"cds\" height=\"0.8\" width=\"1.5\" color=\"#B71C1C\" fillcolor=\"#FFCDD2\" fontname=\"Arial\" fontsize=\"11\" style=\"filled\"" ;
    vad:styleLegendLabel "Критический процесс" ;
    rdfs:comment "Критический процесс, требующий особого внимания" ;
    dcterms:description "Процесс, отмеченный как критический" .
```
3. Сохраните файл

**Результат:** Критические процессы будут отображаться с красной цветовой схемой.

### Пример 3: Изменение автогенерируемых предикатов

**Цель:** Убрать автоматическое создание группы исполнителей.

**Шаги:**
1. Откройте `vad-basic-ontology_tech_Appendix.ttl`
2. Найдите `vad:IndividProcessPredicate`
3. Удалите `vad:hasExecutor` из `vad:autoGeneratedPredicate`
4. Сохраните файл

**Результат:** При создании новых экземпляров процессов группа исполнителей не будет автоматически создаваться.

---

## Устранение неполадок

### Файл не открывается в Protege

- Используйте `File -> Open...` вместо двойного клика
- Попробуйте переименовать .ttl в .owl
- Проверьте кодировку файла (должна быть UTF-8)

### Потеря комментариев после сохранения

Protege не сохраняет все комментарии при записи. Решение:
1. Сохраните исходный файл как резервную копию
2. Используйте diff-инструмент для слияния изменений вручную
3. Или примите форматирование Protege

### Отсутствующие префиксы

Если Protege жалуется на неопределённые префиксы:
1. Убедитесь, что все префиксы объявлены в начале файла
2. Добавьте недостающие объявления префиксов

### Классы не появляются

Если новые классы не отображаются в RDF Grapher:
1. Проверьте, что класс является подклассом соответствующего типа
2. Проверьте, нужно ли добавить класс в `VAD_ALLOWED_TYPES` в JavaScript-коде
3. Очистите кэш браузера и перезагрузите

### Ошибки Reasoner

Если reasoner Protege сообщает о несоответствиях:
1. Проверьте наличие циклических отношений подклассов
2. Проверьте ограничения domain/range
3. Попробуйте отключить reasoner: `Reasoner -> None`

---

## Структура файлов

```
ver8tree/
├── Protege/
│   ├── README.md              # Руководство (английский)
│   ├── README.ru.md           # Данное руководство (русский)
│   ├── ttl-to-owl.py          # Конвертер: TTL -> OWL/XML (Python)
│   ├── owl-to-ttl.py          # Конвертер: OWL/XML -> TTL (Python)
│   ├── ttl-to-owl.js          # Конвертер: TTL -> OWL/XML (браузерный JS)
│   ├── owl-to-ttl.js          # Конвертер: OWL/XML -> TTL (браузерный JS)
│   └── examples/
│       ├── add-predicate.md       # Пример: добавление предиката (английский)
│       ├── add-predicate.ru.md    # Пример: добавление предиката (русский)
│       ├── add-class.md           # Пример: добавление класса (английский)
│       ├── add-class.ru.md        # Пример: добавление класса (русский)
│       ├── edit-concept-process-predicate.md    # Пример: редактирование (английский)
│       └── edit-concept-process-predicate.ru.md # Пример: редактирование (русский)
├── vad-basic-ontology.ttl     # Основная онтология
├── vad-basic-ontology_tech_Appendix.ttl  # Техническое приложение
└── Trig_VADv5.ttl             # Пример RDF-данных
```

---

## Ссылки

- Сайт Protege: https://protege.stanford.edu/
- WebProtege: https://webprotege.stanford.edu/
- Документация Protege: https://protegewiki.stanford.edu/
- Спецификация OWL 2: https://www.w3.org/TR/owl2-overview/
- Синтаксис Turtle: https://www.w3.org/TR/turtle/
- Проект RDF Grapher: https://github.com/bpmbpm/rdf-grapher

---

## История версий

| Версия | Дата | Изменения |
|--------|------|-----------|
| 1.0 | 2026-01-27 | Начальная версия |
| 1.1 | 2026-01-27 | Добавлены разделы о Reasoner и WebProtege |
