<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RDF Grapher ver9c - –¢–µ—Å—Ç Individ: –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è</title>
    <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ issue: https://github.com/bpmbpm/rdf-grapher/issues/319 -->
    <!-- Pull Request: https://github.com/bpmbpm/rdf-grapher/pull/320 -->
    <!-- –î–≤–∞ —Ä–µ–∂–∏–º–∞ hasNext: issue #313, PR #314 -->
    <style>
        body { font-family: Consolas, Monaco, monospace; padding: 20px; background-color: #f5f5f5; }
        h1 { color: #333; border-bottom: 2px solid #1976D2; padding-bottom: 10px; }
        h2 { color: #1976D2; margin-top: 30px; }
        h3 { color: #2196F3; margin-top: 20px; font-size: 16px; }
        .step { padding: 10px 15px; margin: 5px 0; border-radius: 4px; font-size: 14px; }
        .step-passed { background-color: #d4edda; border-left: 4px solid #28a745; color: #155724; }
        .step-failed { background-color: #f8d7da; border-left: 4px solid #dc3545; color: #721c24; }
        .step-running { background-color: #fff3cd; border-left: 4px solid #ffc107; color: #856404; }
        .step-info { background-color: #d1ecf1; border-left: 4px solid #17a2b8; color: #0c5460; }
        .phase-header { background-color: #e3f2fd; border-left: 4px solid #1976D2; color: #0d47a1; font-weight: bold; margin-top: 20px; }
        .summary { margin-top: 20px; padding: 15px; border-radius: 4px; font-size: 16px; font-weight: bold; }
        .summary-passed { background-color: #d4edda; color: #155724; }
        .summary-failed { background-color: #f8d7da; color: #721c24; }
        .sparql-block { background-color: #263238; color: #EEFFFF; padding: 15px; border-radius: 4px; margin: 10px 0; font-size: 13px; white-space: pre-wrap; overflow-x: auto; }
        .data-block { background-color: #FAFAFA; border: 1px solid #E0E0E0; padding: 15px; border-radius: 4px; margin: 10px 0; font-size: 13px; white-space: pre-wrap; overflow-x: auto; max-height: 400px; overflow-y: auto; }
        #test-log { margin-top: 10px; }
    </style>
</head>
<body>
    <h1>–¢–µ—Å—Ç Individ: –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥–æ–≤</h1>
    <p>
        –°—Ü–µ–Ω–∞—Ä–∏–π —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Å–æ–∑–¥–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è –∏–Ω–¥–∏–≤–∏–¥–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
        –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å <a href="../../doc/algorithm/io_concept_individ_v4.md">io_concept_individ_v4.md</a>.<br>
        <strong>–§–∞–∑–∞ 1:</strong> –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ vad:t_p1 (—Å hasNext –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–Ω–¥–∏–≤–∏–¥)<br>
        <strong>–§–∞–∑–∞ 2:</strong> –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ vad:includes –≤ ExecutorGroup)<br>
        <strong>–§–∞–∑–∞ 3:</strong> –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è (—É–¥–∞–ª–µ–Ω–∏–µ vad:includes)<br>
        <strong>–§–∞–∑–∞ 4:</strong> –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ (3 —ç—Ç–∞–ø–∞: –∏—Å—Ö–æ–¥—è—â–∏–µ —Å–≤—è–∑–∏, ExecutorGroup, –≤—Ö–æ–¥—è—â–∏–µ hasNext)
    </p>
    <p>
        <strong>issue #313 (PR #314):</strong> –î–≤–∞ —Ä–µ–∂–∏–º–∞ –¥–ª—è vad:hasNext:<br>
        - "vad:hasNext –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π" (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é): –∏–Ω–¥–∏–≤–∏–¥—ã –≤ TriG<br>
        - "vad:hasNext –Ω–∞ –ª—é–±–æ–π": –≤—Å–µ –∫–æ–Ω—Ü–µ–ø—Ç—ã –∏–∑ ptree
    </p>
    <div id="test-log"></div>
    <div id="test-summary"></div>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ N3.js –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è RDF –¥–∞–Ω–Ω—ã—Ö -->
    <script src="https://unpkg.com/n3@1.17.2/browser/n3.min.js"></script>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Comunica –¥–ª—è SPARQL –∑–∞–ø—Ä–æ—Å–æ–≤ -->
    <script src="https://rdf.js.org/comunica-browser/versions/v4/engines/query-sparql-rdfjs/comunica-browser.js"></script>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ RDF Grapher (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —É—Ç–∏–ª–∏—Ç—ã) -->
    <script src="../../9_vadlib/vadlib.js"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ SPARQL-–¥–≤–∏–∂–∫–∞ (funSPARQLvalues –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏) -->
    <script src="../../9_vadlib/vadlib_sparql.js"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ç—Ä–∏–ø–ª—Å—Ç–æ—Ä–∞ (parseTriGHierarchy, validateVAD) -->
    <script src="../../2_triplestore/2_triplestore_logic.js"></script>

    <script>
        // ============================================================================
        // –¢–µ—Å—Ç Individ: –°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥–æ–≤ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
        // –°—Å—ã–ª–∫–∞ –Ω–∞ issue: https://github.com/bpmbpm/rdf-grapher/issues/319
        // –î–≤–∞ —Ä–µ–∂–∏–º–∞ hasNext: issue #313, PR #314
        // ============================================================================

        const testLog = document.getElementById('test-log');
        const testSummary = document.getElementById('test-summary');
        let stepResults = [];

        /**
         * –õ–æ–≥–∏—Ä—É–µ—Ç —à–∞–≥ —Å—Ü–µ–Ω–∞—Ä–∏—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞
         */
        function logStep(name, status, message) {
            const div = document.createElement('div');
            div.className = `step step-${status === 'phase' ? 'phase-header' : status}`;
            const icons = { passed: '‚úÖ', failed: '‚ùå', running: '‚è≥', info: '‚ÑπÔ∏è', phase: 'üìã' };
            div.textContent = `${icons[status] || ''} ${name}: ${message}`;
            testLog.appendChild(div);
            if (status === 'passed' || status === 'failed') {
                stepResults.push({ name, passed: status === 'passed', message });
            }
        }

        /**
         * –í—ã–≤–æ–¥–∏—Ç –±–ª–æ–∫ —Å SPARQL-–∑–∞–ø—Ä–æ—Å–æ–º –∏–ª–∏ –¥–∞–Ω–Ω—ã–º–∏ –≤ –ª–æ–≥
         */
        function logBlock(title, content, type = 'data') {
            const h = document.createElement('h3');
            h.textContent = title;
            testLog.appendChild(h);

            const div = document.createElement('div');
            div.className = type === 'sparql' ? 'sparql-block' : 'data-block';
            div.textContent = content;
            testLog.appendChild(div);
        }

        /**
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—É—é —Å–≤–æ–¥–∫—É –ø–æ –≤—Å–µ–º —à–∞–≥–∞–º
         */
        function showSummary() {
            const passed = stepResults.filter(s => s.passed).length;
            const total = stepResults.length;
            const allPassed = passed === total;
            testSummary.className = `summary ${allPassed ? 'summary-passed' : 'summary-failed'}`;
            testSummary.textContent = `–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞ Individ: ${passed}/${total} —à–∞–≥–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ ${allPassed ? '‚úÖ' : '‚ùå'}`;
        }

        /**
         * –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∞ (TriG) –∏–∑ –º–∞—Å—Å–∏–≤–∞ –∫–≤–∞–¥–æ–≤
         */
        function getGraphContent(graphUri, quads, prefixes) {
            const graphQuads = quads.filter(q => q.graph && q.graph.value === graphUri);
            if (graphQuads.length === 0) return '(–≥—Ä–∞—Ñ –ø—É—Å—Ç)';

            const graphLabel = getPrefixedName(graphUri, prefixes);
            let output = `${graphLabel} {\n`;

            graphQuads.forEach(q => {
                const s = getPrefixedName(q.subject.value, prefixes);
                const p = getPrefixedName(q.predicate.value, prefixes);
                const o = q.object.termType === 'Literal'
                    ? `"${q.object.value}"`
                    : getPrefixedName(q.object.value, prefixes);
                output += `    ${s} ${p} ${o} .\n`;
            });

            output += '}';
            return output;
        }

        /**
         * –ü—Ä–∏–º–µ–Ω—è–µ—Ç SPARQL –∑–∞–ø—Ä–æ—Å –∫ currentStore —á–µ—Ä–µ–∑ Comunica
         */
        async function applySparql(sparqlQuery) {
            try {
                if (!comunicaEngine) {
                    if (typeof Comunica !== 'undefined' && Comunica.QueryEngine) {
                        comunicaEngine = new Comunica.QueryEngine();
                    } else {
                        throw new Error('Comunica –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
                    }
                }

                await comunicaEngine.queryVoid(sparqlQuery, {
                    sources: [currentStore]
                });

                currentQuads = currentStore.getQuads(null, null, null, null);
                return true;
            } catch (error) {
                console.error('applySparql error:', error);
                throw error;
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –ø–∞—Ä—Å–∏—Ç TriG –¥–∞–Ω–Ω—ã–µ
         */
        async function loadTriGData() {
            const response = await fetch('../../dia/Trig_VADv5.ttl');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.text();

            const quads = [];
            let prefixes = {};

            await new Promise((resolve, reject) => {
                const parser = new N3.Parser({ format: 'trig' });
                parser.parse(data, (error, quad, parsedPrefixes) => {
                    if (error) { reject(error); return; }
                    if (quad) { quads.push(quad); }
                    else {
                        if (parsedPrefixes) prefixes = parsedPrefixes;
                        resolve();
                    }
                });
            });

            return { quads, prefixes };
        }

        /**
         * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∏–Ω–¥–∏–≤–∏–¥–∞ –≤ TriG
         */
        function checkIndividExists(individUri, trigUri) {
            const isSubprocessTrigUri = 'http://example.org/vad#isSubprocessTrig';
            return currentStore.getQuads(
                N3.DataFactory.namedNode(individUri),
                N3.DataFactory.namedNode(isSubprocessTrigUri),
                N3.DataFactory.namedNode(trigUri),
                N3.DataFactory.namedNode(trigUri)
            ).length > 0;
        }

        /**
         * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ ExecutorGroup –≤ TriG
         */
        function checkExecutorGroupExists(groupUri, trigUri) {
            const rdfTypeUri = 'http://www.w3.org/1999/02/22-rdf-syntax-ns#type';
            const executorGroupTypeUri = 'http://example.org/vad#ExecutorGroup';
            return currentStore.getQuads(
                N3.DataFactory.namedNode(groupUri),
                N3.DataFactory.namedNode(rdfTypeUri),
                N3.DataFactory.namedNode(executorGroupTypeUri),
                N3.DataFactory.namedNode(trigUri)
            ).length > 0;
        }

        /**
         * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ vad:includes —Å–≤—è–∑–∏
         */
        function checkIncludesExists(groupUri, executorUri, trigUri) {
            const includesUri = 'http://example.org/vad#includes';
            return currentStore.getQuads(
                N3.DataFactory.namedNode(groupUri),
                N3.DataFactory.namedNode(includesUri),
                N3.DataFactory.namedNode(executorUri),
                N3.DataFactory.namedNode(trigUri)
            ).length > 0;
        }

        /**
         * –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—ã –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ TriG (–¥–ª—è —Ä–µ–∂–∏–º–∞ "–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π")
         */
        function getIndividsInTrig(trigUri) {
            const isSubprocessTrigUri = 'http://example.org/vad#isSubprocessTrig';
            const individs = [];

            currentQuads.forEach(quad => {
                if (quad.predicate.value === isSubprocessTrigUri &&
                    quad.object.value === trigUri &&
                    quad.graph && quad.graph.value === trigUri) {
                    individs.push(quad.subject.value);
                }
            });
            return individs;
        }

        /**
         * –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–∞
         */
        async function runTest() {
            // ================================================================
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            // ================================================================
            logStep('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞', 'running', '–ó–∞–≥—Ä—É–∑–∫–∞ Trig_VADv5.ttl...');
            try {
                const { quads, prefixes } = await loadTriGData();
                currentQuads = quads;
                currentPrefixes = prefixes;
                currentStore = new N3.Store();
                quads.forEach(q => currentStore.addQuad(q));

                logStep('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞', 'passed', `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${quads.length} –∫–≤–∞–¥–æ–≤, ${Object.keys(prefixes).length} –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤`);
            } catch (error) {
                logStep('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞', 'failed', `–û—à–∏–±–∫–∞: ${error.message}`);
                showSummary();
                return;
            }

            // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–∞
            const trigUri = 'http://example.org/vad#t_p1';
            const trigPrefixed = 'vad:t_p1';
            const newProcessUri = 'http://example.org/vad#p2.1';  // –ö–æ–Ω—Ü–µ–ø—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ ptree
            const newProcessPrefixed = 'vad:p2.1';
            const executorGroupUri = 'http://example.org/vad#ExecutorGroup_p2.1';
            const executorGroupPrefixed = 'vad:ExecutorGroup_p2.1';
            const existingIndividUri = 'http://example.org/vad#p1.1';  // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–Ω–¥–∏–≤–∏–¥ –≤ t_p1
            const existingIndividPrefixed = 'vad:p1.1';
            const executorUri = 'http://example.org/vad#Executor3';
            const executorPrefixed = 'vad:Executor3';

            const prefixLines = Object.entries(currentPrefixes)
                .map(([prefix, uri]) => `PREFIX ${prefix}: <${uri}>`)
                .join('\n');

            // ================================================================
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ hasNext "–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π" (issue #313)
            // ================================================================
            logStep('–†–µ–∂–∏–º hasNext', 'info', '–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∂–∏–º–∞ "vad:hasNext –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π" (issue #313)');

            const existingIndivids = getIndividsInTrig(trigUri);
            logStep('–†–µ–∂–∏–º hasNext', 'passed',
                `–ù–∞–π–¥–µ–Ω–æ ${existingIndivids.length} —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∏–Ω–¥–∏–≤–∏–¥–æ–≤ –≤ ${trigPrefixed}: ` +
                existingIndivids.map(uri => getPrefixedName(uri, currentPrefixes)).join(', '));

            // ================================================================
            // –§–ê–ó–ê 1: –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞
            // ================================================================
            logStep('–§–ê–ó–ê 1', 'phase', '–°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ vad:p2.1 –≤ vad:t_p1 —Å hasNext –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–Ω–¥–∏–≤–∏–¥');

            // –®–∞–≥ 1.1: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ SPARQL INSERT –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∂–∏–º "vad:hasNext –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π" - —Å—Å—ã–ª–∞–µ–º—Å—è –Ω–∞ p1.1 –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –µ—Å—Ç—å –≤ t_p1
            const phase1InsertQuery = `${prefixLines}

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∏–Ω–¥–∏–≤–∏–¥–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å ExecutorGroup
# hasNext —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–Ω–¥–∏–≤–∏–¥ –≤ TriG (—Ä–µ–∂–∏–º "–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π", issue #313)
INSERT DATA {
    GRAPH ${trigPrefixed} {
        ${newProcessPrefixed} vad:isSubprocessTrig ${trigPrefixed} ;
            vad:hasExecutor ${executorGroupPrefixed} ;
            vad:hasNext ${existingIndividPrefixed} .

        # –ì—Ä—É–ø–ø–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π (ID —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ ExecutorGroup_ + ID –ø—Ä–æ—Ü–µ—Å—Å–∞)
        ${executorGroupPrefixed} rdf:type vad:ExecutorGroup ;
            rdfs:label "–ì—Ä—É–ø–ø–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π –ø—Ä–æ—Ü–µ—Å—Å–∞ p2.1" .
    }
}`;

            logBlock('–§–∞–∑–∞ 1 - SPARQL INSERT (–ò–Ω–¥–∏–≤–∏–¥ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å hasNext –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π)', phase1InsertQuery, 'sparql');
            logStep('–®–∞–≥ 1.1', 'passed', 'SPARQL INSERT DATA –∑–∞–ø—Ä–æ—Å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω (hasNext –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∏–Ω–¥–∏–≤–∏–¥ vad:p1.1)');

            // –®–∞–≥ 1.2: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ SPARQL INSERT
            logStep('–®–∞–≥ 1.2', 'running', '–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ INSERT –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–∏–≤–∏–¥–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞...');
            try {
                const quadsBefore = currentQuads.length;
                await applySparql(phase1InsertQuery);
                const quadsAfter = currentQuads.length;
                logStep('–®–∞–≥ 1.2', 'passed', `–î–æ–±–∞–≤–ª–µ–Ω–æ ${quadsAfter - quadsBefore} –∫–≤–∞–¥–æ–≤. –í—Å–µ–≥–æ: ${quadsAfter}`);
            } catch (error) {
                logStep('–®–∞–≥ 1.2', 'failed', `–û—à–∏–±–∫–∞: ${error.message}`);
                showSummary();
                return;
            }

            // –®–∞–≥ 1.3: –í—ã–≤–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ t_p1 –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∏–Ω–¥–∏–≤–∏–¥–∞
            const trigContentAfterIndivid = getGraphContent(trigUri, currentQuads, currentPrefixes);
            logBlock('–§–∞–∑–∞ 1 - –°–æ–¥–µ—Ä–∂–∏–º–æ–µ vad:t_p1 –ø–æ—Å–ª–µ INSERT', trigContentAfterIndivid, 'data');

            // –®–∞–≥ 1.4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∏–Ω–¥–∏–≤–∏–¥–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞
            if (checkIndividExists(newProcessUri, trigUri)) {
                logStep('–®–∞–≥ 1.3', 'passed', `–ò–Ω–¥–∏–≤–∏–¥ ${newProcessPrefixed} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –≤ ${trigPrefixed}`);
            } else {
                logStep('–®–∞–≥ 1.3', 'failed', `–ò–Ω–¥–∏–≤–∏–¥ ${newProcessPrefixed} –ù–ï –Ω–∞–π–¥–µ–Ω –≤ ${trigPrefixed}`);
                showSummary();
                return;
            }

            // –®–∞–≥ 1.5: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è ExecutorGroup
            if (checkExecutorGroupExists(executorGroupUri, trigUri)) {
                logStep('–®–∞–≥ 1.4', 'passed', `ExecutorGroup ${executorGroupPrefixed} –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–Ω–∞`);
            } else {
                logStep('–®–∞–≥ 1.4', 'failed', `ExecutorGroup ${executorGroupPrefixed} –ù–ï —Å–æ–∑–¥–∞–Ω–∞`);
                showSummary();
                return;
            }

            // ================================================================
            // –§–ê–ó–ê 2: –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
            // ================================================================
            logStep('–§–ê–ó–ê 2', 'phase', '–°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ vad:includes –≤ ExecutorGroup');

            const phase2InsertQuery = `${prefixLines}

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É (–∏–Ω–¥–∏–≤–∏–¥ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è)
INSERT DATA {
    GRAPH ${trigPrefixed} {
        ${executorGroupPrefixed} vad:includes ${executorPrefixed} .
    }
}`;

            logBlock('–§–∞–∑–∞ 2 - SPARQL INSERT (–ò–Ω–¥–∏–≤–∏–¥ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è)', phase2InsertQuery, 'sparql');
            logStep('–®–∞–≥ 2.1', 'passed', 'SPARQL INSERT DATA –∑–∞–ø—Ä–æ—Å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω');

            // –®–∞–≥ 2.2: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ SPARQL INSERT
            logStep('–®–∞–≥ 2.2', 'running', '–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ INSERT –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –≤ ExecutorGroup...');
            try {
                const quadsBefore = currentQuads.length;
                await applySparql(phase2InsertQuery);
                const quadsAfter = currentQuads.length;
                logStep('–®–∞–≥ 2.2', 'passed', `–î–æ–±–∞–≤–ª–µ–Ω ${quadsAfter - quadsBefore} –∫–≤–∞–¥. –í—Å–µ–≥–æ: ${quadsAfter}`);
            } catch (error) {
                logStep('–®–∞–≥ 2.2', 'failed', `–û—à–∏–±–∫–∞: ${error.message}`);
                showSummary();
                return;
            }

            // –®–∞–≥ 2.3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è vad:includes
            if (checkIncludesExists(executorGroupUri, executorUri, trigUri)) {
                logStep('–®–∞–≥ 2.3', 'passed', `–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å ${executorPrefixed} –¥–æ–±–∞–≤–ª–µ–Ω –≤ ${executorGroupPrefixed} —á–µ—Ä–µ–∑ vad:includes`);
            } else {
                logStep('–®–∞–≥ 2.3', 'failed', `–°–≤—è–∑—å vad:includes –ù–ï —Å–æ–∑–¥–∞–Ω–∞`);
                showSummary();
                return;
            }

            // ================================================================
            // –§–ê–ó–ê 3: –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
            // ================================================================
            logStep('–§–ê–ó–ê 3', 'phase', '–£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è: —É–¥–∞–ª–µ–Ω–∏–µ vad:includes –∏–∑ ExecutorGroup');

            const phase3DeleteQuery = `${prefixLines}

# –£–¥–∞–ª–µ–Ω–∏–µ —Å–≤—è–∑–∏ vad:includes –¥–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
DELETE DATA {
    GRAPH ${trigPrefixed} {
        ${executorGroupPrefixed} vad:includes ${executorPrefixed} .
    }
}`;

            logBlock('–§–∞–∑–∞ 3 - SPARQL DELETE (–ò–Ω–¥–∏–≤–∏–¥ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è)', phase3DeleteQuery, 'sparql');
            logStep('–®–∞–≥ 3.1', 'passed', 'SPARQL DELETE DATA –∑–∞–ø—Ä–æ—Å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω');

            // –®–∞–≥ 3.2: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ SPARQL DELETE
            logStep('–®–∞–≥ 3.2', 'running', '–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ DELETE –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –∏–∑ ExecutorGroup...');
            try {
                const quadsBefore = currentQuads.length;
                await applySparql(phase3DeleteQuery);
                const quadsAfter = currentQuads.length;
                logStep('–®–∞–≥ 3.2', 'passed', `–£–¥–∞–ª—ë–Ω ${quadsBefore - quadsAfter} –∫–≤–∞–¥. –í—Å–µ–≥–æ: ${quadsAfter}`);
            } catch (error) {
                logStep('–®–∞–≥ 3.2', 'failed', `–û—à–∏–±–∫–∞: ${error.message}`);
                showSummary();
                return;
            }

            // –®–∞–≥ 3.3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è vad:includes
            if (!checkIncludesExists(executorGroupUri, executorUri, trigUri)) {
                logStep('–®–∞–≥ 3.3', 'passed', `–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å ${executorPrefixed} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω –∏–∑ ${executorGroupPrefixed}`);
            } else {
                logStep('–®–∞–≥ 3.3', 'failed', `–°–≤—è–∑—å vad:includes –≤—Å—ë –µ—â—ë —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
                showSummary();
                return;
            }

            // ================================================================
            // –§–ê–ó–ê 4: –£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ (3 —ç—Ç–∞–ø–∞)
            // ================================================================
            logStep('–§–ê–ó–ê 4', 'phase', '–£–¥–∞–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞: 3 —ç—Ç–∞–ø–∞ —Å–æ–≥–ª–∞—Å–Ω–æ io_concept_individ_v4.md');

            // –≠—Ç–∞–ø 1: –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∏—Å—Ö–æ–¥—è—â–∏—Ö —Å–≤—è–∑–µ–π –∏–Ω–¥–∏–≤–∏–¥–∞
            const phase4Step1Query = `${prefixLines}

# issue #309: –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∏—Å—Ö–æ–¥—è—â–∏—Ö —Ç—Ä–∏–ø–ª–µ—Ç–æ–≤ –∏–Ω–¥–∏–≤–∏–¥–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞
# –≠—Ç–∞–ø 1 –∏–∑ 3: —É–¥–∞–ª—è–µ—Ç isSubprocessTrig, hasExecutor, hasNext
DELETE WHERE {
    GRAPH ${trigPrefixed} {
        ${newProcessPrefixed} ?p ?o .
    }
}`;

            // –≠—Ç–∞–ø 2: –£–¥–∞–ª–µ–Ω–∏–µ ExecutorGroup
            const phase4Step2Query = `${prefixLines}

# issue #309: –£–¥–∞–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ ExecutorGroup
# –≠—Ç–∞–ø 2 –∏–∑ 3: —É–¥–∞–ª—è–µ—Ç rdf:type, rdfs:label, vad:includes
DELETE WHERE {
    GRAPH ${trigPrefixed} {
        ${executorGroupPrefixed} ?p ?o .
    }
}`;

            // –≠—Ç–∞–ø 3: –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ö–æ–¥—è—â–∏—Ö vad:hasNext
            // –í –¥–∞–Ω–Ω–æ–º —Ç–µ—Å—Ç–µ –≤—Ö–æ–¥—è—â–∏—Ö hasNext –Ω–µ—Ç (–¥—Ä—É–≥–∏–µ –∏–Ω–¥–∏–≤–∏–¥—ã –Ω–µ —Å—Å—ã–ª–∞—é—Ç—Å—è –Ω–∞ p2.1)
            // –ù–æ –º—ã –≤—Å—ë —Ä–∞–≤–Ω–æ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
            const phase4Step3Query = `${prefixLines}

# issue #309: –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ö–æ–¥—è—â–∏—Ö —Å–≤—è–∑–µ–π vad:hasNext
# –≠—Ç–∞–ø 3 –∏–∑ 3: —É–¥–∞–ª—è–µ—Ç —Å—Å—ã–ª–∫–∏ –Ω–∞ —É–¥–∞–ª—è–µ–º—ã–π –∏–Ω–¥–∏–≤–∏–¥ –æ—Ç –¥—Ä—É–≥–∏—Ö –∏–Ω–¥–∏–≤–∏–¥–æ–≤
DELETE WHERE {
    GRAPH ${trigPrefixed} {
        ?s vad:hasNext ${newProcessPrefixed} .
    }
}`;

            // –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const fullDeleteQuery = phase4Step1Query + '\n;\n' + phase4Step2Query + '\n;\n' + phase4Step3Query;
            logBlock('–§–∞–∑–∞ 4 - SPARQL DELETE (–ò–Ω–¥–∏–≤–∏–¥ –ø—Ä–æ—Ü–µ—Å—Å–∞, 3 —ç—Ç–∞–ø–∞)', fullDeleteQuery, 'sparql');
            logStep('–®–∞–≥ 4.1', 'passed', 'SPARQL DELETE –∑–∞–ø—Ä–æ—Å—ã —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã (3 —ç—Ç–∞–ø–∞)');

            // –®–∞–≥ 4.2: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —ç—Ç–∞–ø–∞ 1
            logStep('–®–∞–≥ 4.2', 'running', '–≠—Ç–∞–ø 1: –£–¥–∞–ª–µ–Ω–∏–µ –∏—Å—Ö–æ–¥—è—â–∏—Ö —Å–≤—è–∑–µ–π –∏–Ω–¥–∏–≤–∏–¥–∞...');
            try {
                const quadsBefore = currentQuads.length;
                await applySparql(phase4Step1Query);
                const quadsAfter = currentQuads.length;
                logStep('–®–∞–≥ 4.2', 'passed', `–≠—Ç–∞–ø 1 –≤—ã–ø–æ–ª–Ω–µ–Ω. –£–¥–∞–ª–µ–Ω–æ ${quadsBefore - quadsAfter} –∫–≤–∞–¥–æ–≤. –í—Å–µ–≥–æ: ${quadsAfter}`);
            } catch (error) {
                logStep('–®–∞–≥ 4.2', 'failed', `–û—à–∏–±–∫–∞: ${error.message}`);
                showSummary();
                return;
            }

            // –®–∞–≥ 4.3: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —ç—Ç–∞–ø–∞ 2
            logStep('–®–∞–≥ 4.3', 'running', '–≠—Ç–∞–ø 2: –£–¥–∞–ª–µ–Ω–∏–µ ExecutorGroup...');
            try {
                const quadsBefore = currentQuads.length;
                await applySparql(phase4Step2Query);
                const quadsAfter = currentQuads.length;
                logStep('–®–∞–≥ 4.3', 'passed', `–≠—Ç–∞–ø 2 –≤—ã–ø–æ–ª–Ω–µ–Ω. –£–¥–∞–ª–µ–Ω–æ ${quadsBefore - quadsAfter} –∫–≤–∞–¥–æ–≤. –í—Å–µ–≥–æ: ${quadsAfter}`);
            } catch (error) {
                logStep('–®–∞–≥ 4.3', 'failed', `–û—à–∏–±–∫–∞: ${error.message}`);
                showSummary();
                return;
            }

            // –®–∞–≥ 4.4: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —ç—Ç–∞–ø–∞ 3
            logStep('–®–∞–≥ 4.4', 'running', '–≠—Ç–∞–ø 3: –£–¥–∞–ª–µ–Ω–∏–µ –≤—Ö–æ–¥—è—â–∏—Ö vad:hasNext...');
            try {
                const quadsBefore = currentQuads.length;
                await applySparql(phase4Step3Query);
                const quadsAfter = currentQuads.length;
                const deletedCount = quadsBefore - quadsAfter;
                logStep('–®–∞–≥ 4.4', 'passed', `–≠—Ç–∞–ø 3 –≤—ã–ø–æ–ª–Ω–µ–Ω. –£–¥–∞–ª–µ–Ω–æ ${deletedCount} –∫–≤–∞–¥–æ–≤ (${deletedCount === 0 ? '–≤—Ö–æ–¥—è—â–∏—Ö hasNext –Ω–µ –±—ã–ª–æ' : '–≤—Ö–æ–¥—è—â–∏–µ hasNext —É–¥–∞–ª–µ–Ω—ã'}). –í—Å–µ–≥–æ: ${quadsAfter}`);
            } catch (error) {
                logStep('–®–∞–≥ 4.4', 'failed', `–û—à–∏–±–∫–∞: ${error.message}`);
                showSummary();
                return;
            }

            // –®–∞–≥ 4.5: –í—ã–≤–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ t_p1 –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
            const trigContentAfterDelete = getGraphContent(trigUri, currentQuads, currentPrefixes);
            logBlock('–§–∞–∑–∞ 4 - –°–æ–¥–µ—Ä–∂–∏–º–æ–µ vad:t_p1 –ø–æ—Å–ª–µ DELETE', trigContentAfterDelete, 'data');

            // –®–∞–≥ 4.6: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∏–Ω–¥–∏–≤–∏–¥–∞
            if (!checkIndividExists(newProcessUri, trigUri)) {
                logStep('–®–∞–≥ 4.5', 'passed', `–ò–Ω–¥–∏–≤–∏–¥ ${newProcessPrefixed} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω –∏–∑ ${trigPrefixed}`);
            } else {
                logStep('–®–∞–≥ 4.5', 'failed', `–ò–Ω–¥–∏–≤–∏–¥ ${newProcessPrefixed} –≤—Å—ë –µ—â—ë —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ ${trigPrefixed}`);
                showSummary();
                return;
            }

            // –®–∞–≥ 4.7: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è ExecutorGroup
            if (!checkExecutorGroupExists(executorGroupUri, trigUri)) {
                logStep('–®–∞–≥ 4.6', 'passed', `ExecutorGroup ${executorGroupPrefixed} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞`);
            } else {
                logStep('–®–∞–≥ 4.6', 'failed', `ExecutorGroup ${executorGroupPrefixed} –≤—Å—ë –µ—â—ë —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
            }

            showSummary();
        }

        // –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            runTest();
        });
    </script>
</body>
</html>
