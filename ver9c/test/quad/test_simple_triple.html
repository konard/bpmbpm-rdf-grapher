<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RDF Grapher ver9c - –¢–µ—Å—Ç Simple Triple: 4 —Ñ–∞–∑—ã (–¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ç–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è)</title>
    <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ issue: https://github.com/bpmbpm/rdf-grapher/issues/256 -->
    <style>
        body { font-family: Consolas, Monaco, monospace; padding: 20px; background-color: #f5f5f5; }
        h1 { color: #333; border-bottom: 2px solid #1976D2; padding-bottom: 10px; }
        h2 { color: #1976D2; margin-top: 30px; }
        h3 { color: #2196F3; margin-top: 20px; font-size: 16px; }
        .step { padding: 10px 15px; margin: 5px 0; border-radius: 4px; font-size: 14px; }
        .step-passed { background-color: #d4edda; border-left: 4px solid #28a745; color: #155724; }
        .step-failed { background-color: #f8d7da; border-left: 4px solid #dc3545; color: #721c24; }
        .step-running { background-color: #fff3cd; border-left: 4px solid #ffc107; color: #856404; }
        .step-info { background-color: #d1ecf1; border-left: 4px solid #17a2b8; color: #0c5460; }
        .phase-header { background-color: #e3f2fd; border-left: 4px solid #1976D2; color: #0d47a1; font-weight: bold; margin-top: 20px; }
        .summary { margin-top: 20px; padding: 15px; border-radius: 4px; font-size: 16px; font-weight: bold; }
        .summary-passed { background-color: #d4edda; color: #155724; }
        .summary-failed { background-color: #f8d7da; color: #721c24; }
        .sparql-block { background-color: #263238; color: #EEFFFF; padding: 15px; border-radius: 4px; margin: 10px 0; font-size: 13px; white-space: pre-wrap; overflow-x: auto; }
        .data-block { background-color: #FAFAFA; border: 1px solid #E0E0E0; padding: 15px; border-radius: 4px; margin: 10px 0; font-size: 13px; white-space: pre-wrap; overflow-x: auto; max-height: 400px; overflow-y: auto; }
        #test-log { margin-top: 10px; }
    </style>
</head>
<body>
    <h1>–¢–µ—Å—Ç Simple Triple: 4 —Ñ–∞–∑—ã</h1>
    <p>
        –°—Ü–µ–Ω–∞—Ä–∏–π —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Å–æ–∑–¥–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–Ω—Ü–µ–ø—Ç–æ–≤ —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º SPARQL —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–∞–∫ Simple Triple".<br>
        <strong>–§–∞–∑–∞ 1:</strong> –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ç–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ ptree<br>
        <strong>–§–∞–∑–∞ 2:</strong> –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ç–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –≤ rtree<br>
        <strong>–§–∞–∑–∞ 3:</strong> –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ç–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–∑ ptree<br>
        <strong>–§–∞–∑–∞ 4:</strong> –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ç–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –∏–∑ rtree
    </p>
    <div id="test-log"></div>
    <div id="test-summary"></div>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ N3.js –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è RDF –¥–∞–Ω–Ω—ã—Ö -->
    <script src="https://unpkg.com/n3@1.17.2/browser/n3.min.js"></script>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Comunica –¥–ª—è SPARQL –∑–∞–ø—Ä–æ—Å–æ–≤ -->
    <script src="https://rdf.js.org/comunica-browser/versions/v4/engines/query-sparql-rdfjs/comunica-browser.js"></script>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–π –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ RDF Grapher (–≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —É—Ç–∏–ª–∏—Ç—ã) -->
    <script src="../../9_vadlib/vadlib.js"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ SPARQL-–¥–≤–∏–∂–∫–∞ (funSPARQLvalues –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏) -->
    <script src="../../9_vadlib/vadlib_sparql.js"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ —Ç—Ä–∏–ø–ª—Å—Ç–æ—Ä–∞ (parseTriGHierarchy, validateVAD) -->
    <script src="../../2_triplestore/2_triplestore_logic.js"></script>

    <script>
        // ============================================================================
        // –¢–µ—Å—Ç Simple Triple: 4 —Ñ–∞–∑—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –∫–æ–Ω—Ü–µ–ø—Ç–æ–≤
        // –°—Å—ã–ª–∫–∞ –Ω–∞ issue: https://github.com/bpmbpm/rdf-grapher/issues/256
        // ============================================================================

        const testLog = document.getElementById('test-log');
        const testSummary = document.getElementById('test-summary');
        let stepResults = [];

        /**
         * –õ–æ–≥–∏—Ä—É–µ—Ç —à–∞–≥ —Å—Ü–µ–Ω–∞—Ä–∏—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–∞
         * @param {string} name - –ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–≥–∞
         * @param {string} status - –°—Ç–∞—Ç—É—Å: 'passed', 'failed', 'running', 'info', 'phase'
         * @param {string} message - –û–ø–∏—Å–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
         */
        function logStep(name, status, message) {
            const div = document.createElement('div');
            div.className = `step step-${status === 'phase' ? 'phase-header' : status}`;
            const icons = { passed: '‚úÖ', failed: '‚ùå', running: '‚è≥', info: '‚ÑπÔ∏è', phase: 'üìã' };
            div.textContent = `${icons[status] || ''} ${name}: ${message}`;
            testLog.appendChild(div);
            if (status === 'passed' || status === 'failed') {
                stepResults.push({ name, passed: status === 'passed', message });
            }
        }

        /**
         * –í—ã–≤–æ–¥–∏—Ç –±–ª–æ–∫ —Å SPARQL-–∑–∞–ø—Ä–æ—Å–æ–º –∏–ª–∏ –¥–∞–Ω–Ω—ã–º–∏ –≤ –ª–æ–≥
         * @param {string} title - –ó–∞–≥–æ–ª–æ–≤–æ–∫ –±–ª–æ–∫–∞
         * @param {string} content - –°–æ–¥–µ—Ä–∂–∏–º–æ–µ
         * @param {string} type - –¢–∏–ø: 'sparql' –∏–ª–∏ 'data'
         */
        function logBlock(title, content, type = 'data') {
            const h = document.createElement('h3');
            h.textContent = title;
            testLog.appendChild(h);

            const div = document.createElement('div');
            div.className = type === 'sparql' ? 'sparql-block' : 'data-block';
            div.textContent = content;
            testLog.appendChild(div);
        }

        /**
         * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∏—Ç–æ–≥–æ–≤—É—é —Å–≤–æ–¥–∫—É –ø–æ –≤—Å–µ–º —à–∞–≥–∞–º
         */
        function showSummary() {
            const passed = stepResults.filter(s => s.passed).length;
            const total = stepResults.length;
            const allPassed = passed === total;
            testSummary.className = `summary ${allPassed ? 'summary-passed' : 'summary-failed'}`;
            testSummary.textContent = `–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞ Simple Triple: ${passed}/${total} —à–∞–≥–æ–≤ –ø—Ä–æ–π–¥–µ–Ω–æ ${allPassed ? '‚úÖ' : '‚ùå'}`;
        }

        /**
         * –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∞ (TriG) –∏–∑ –º–∞—Å—Å–∏–≤–∞ –∫–≤–∞–¥–æ–≤
         * @param {string} graphUri - URI –≥—Ä–∞—Ñ–∞ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è
         * @param {Array} quads - –ú–∞—Å—Å–∏–≤ RDF-–∫–≤–∞–¥–æ–≤
         * @param {Object} prefixes - –°–ª–æ–≤–∞—Ä—å –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤
         * @returns {string} - –¢–µ–∫—Å—Ç–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –≥—Ä–∞—Ñ–∞
         */
        function getGraphContent(graphUri, quads, prefixes) {
            const graphQuads = quads.filter(q => q.graph && q.graph.value === graphUri);
            if (graphQuads.length === 0) return '(–≥—Ä–∞—Ñ –ø—É—Å—Ç)';

            const graphLabel = getPrefixedName(graphUri, prefixes);
            let output = `${graphLabel} {\n`;

            graphQuads.forEach(q => {
                const s = getPrefixedName(q.subject.value, prefixes);
                const p = getPrefixedName(q.predicate.value, prefixes);
                const o = q.object.termType === 'Literal'
                    ? `"${q.object.value}"`
                    : getPrefixedName(q.object.value, prefixes);
                output += `    ${s} ${p} ${o} .\n`;
            });

            output += '}';
            return output;
        }

        /**
         * –ü—Ä–∏–º–µ–Ω—è–µ—Ç SPARQL –∑–∞–ø—Ä–æ—Å –∫ currentStore —á–µ—Ä–µ–∑ Comunica (Simple Triple mode)
         * @param {string} sparqlQuery - SPARQL UPDATE –∑–∞–ø—Ä–æ—Å
         * @returns {Promise<boolean>} - true –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ
         */
        async function applySimpleTriple(sparqlQuery) {
            try {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Comunica engine –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                if (!comunicaEngine) {
                    if (typeof Comunica !== 'undefined' && Comunica.QueryEngine) {
                        comunicaEngine = new Comunica.QueryEngine();
                    } else {
                        throw new Error('Comunica –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
                    }
                }

                // –í—ã–ø–æ–ª–Ω—è–µ–º SPARQL UPDATE —á–µ—Ä–µ–∑ Comunica
                await comunicaEngine.queryVoid(sparqlQuery, {
                    sources: [currentStore]
                });

                // –û–±–Ω–æ–≤–ª—è–µ–º currentQuads –∏–∑ store
                currentQuads = currentStore.getQuads(null, null, null, null);

                return true;
            } catch (error) {
                console.error('applySimpleTriple error:', error);
                throw error;
            }
        }

        /**
         * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –ø–∞—Ä—Å–∏—Ç TriG –¥–∞–Ω–Ω—ã–µ
         * @returns {Promise<{quads: Array, prefixes: Object}>}
         */
        async function loadTriGData() {
            const response = await fetch('../../dia/Trig_VADv5.ttl');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const data = await response.text();

            const quads = [];
            let prefixes = {};

            await new Promise((resolve, reject) => {
                const parser = new N3.Parser({ format: 'trig' });
                parser.parse(data, (error, quad, parsedPrefixes) => {
                    if (error) { reject(error); return; }
                    if (quad) { quads.push(quad); }
                    else {
                        if (parsedPrefixes) prefixes = parsedPrefixes;
                        resolve();
                    }
                });
            });

            return { quads, prefixes };
        }

        /**
         * –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–∞
         */
        async function runTest() {
            // ================================================================
            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            // ================================================================
            logStep('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞', 'running', '–ó–∞–≥—Ä—É–∑–∫–∞ Trig_VADv5.ttl...');
            try {
                const { quads, prefixes } = await loadTriGData();
                currentQuads = quads;
                currentPrefixes = prefixes;
                currentStore = new N3.Store();
                quads.forEach(q => currentStore.addQuad(q));

                logStep('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞', 'passed', `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${quads.length} –∫–≤–∞–¥–æ–≤, ${Object.keys(prefixes).length} –ø—Ä–µ—Ñ–∏–∫—Å–æ–≤`);
            } catch (error) {
                logStep('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞', 'failed', `–û—à–∏–±–∫–∞: ${error.message}`);
                showSummary();
                return;
            }

            // ================================================================
            // –§–ê–ó–ê 1: –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ç–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤ ptree
            // ================================================================
            logStep('–§–ê–ó–ê 1', 'phase', '–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ç–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ vad:process_test –≤ vad:ptree');

            // –®–∞–≥ 1.1: –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ SPARQL INSERT
            const prefixLines = Object.entries(currentPrefixes)
                .map(([prefix, uri]) => `PREFIX ${prefix}: <${uri}>`)
                .join('\n');

            const phase1InsertQuery = `${prefixLines}

INSERT DATA {
    GRAPH vad:ptree {
        vad:process_test rdf:type vad:TypeProcess .
        vad:process_test rdfs:label "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å" .
        vad:process_test dcterms:description "–¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ quadstore" .
        vad:process_test vad:hasParentObj vad:p1 .
    }
}`;

            logBlock('–§–∞–∑–∞ 1 - SPARQL INSERT (Simple Triple)', phase1InsertQuery, 'sparql');
            logStep('–®–∞–≥ 1.1', 'passed', 'SPARQL INSERT DATA –∑–∞–ø—Ä–æ—Å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω');

            // –®–∞–≥ 1.2: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ SPARQL INSERT
            logStep('–®–∞–≥ 1.2', 'running', '–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ INSERT –∫–∞–∫ Simple Triple...');
            try {
                const quadsBefore = currentQuads.length;
                await applySimpleTriple(phase1InsertQuery);
                const quadsAfter = currentQuads.length;
                logStep('–®–∞–≥ 1.2', 'passed', `–î–æ–±–∞–≤–ª–µ–Ω–æ ${quadsAfter - quadsBefore} –∫–≤–∞–¥–æ–≤. –í—Å–µ–≥–æ: ${quadsAfter}`);
            } catch (error) {
                logStep('–®–∞–≥ 1.2', 'failed', `–û—à–∏–±–∫–∞: ${error.message}`);
                showSummary();
                return;
            }

            // –®–∞–≥ 1.3: –í—ã–≤–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ ptree
            const ptreeContentAfterInsert = getGraphContent(
                'http://example.org/vad#ptree',
                currentQuads,
                currentPrefixes
            );
            logBlock('–§–∞–∑–∞ 1 - –°–æ–¥–µ—Ä–∂–∏–º–æ–µ vad:ptree –ø–æ—Å–ª–µ INSERT', ptreeContentAfterInsert, 'data');

            // –®–∞–≥ 1.4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–æ–Ω—Ü–µ–ø—Ç–∞
            const foundProcess = currentStore.getQuads(
                N3.DataFactory.namedNode('http://example.org/vad#process_test'),
                N3.DataFactory.namedNode('http://www.w3.org/2000/01/rdf-schema#label'),
                null,
                N3.DataFactory.namedNode('http://example.org/vad#ptree')
            );

            if (foundProcess.length > 0) {
                logStep('–®–∞–≥ 1.3', 'passed', `–ö–æ–Ω—Ü–µ–ø—Ç vad:process_test –Ω–∞–π–¥–µ–Ω –≤ ptree. Label: "${foundProcess[0].object.value}"`);
            } else {
                logStep('–®–∞–≥ 1.3', 'failed', '–ö–æ–Ω—Ü–µ–ø—Ç vad:process_test –ù–ï –Ω–∞–π–¥–µ–Ω –≤ ptree');
                showSummary();
                return;
            }

            // ================================================================
            // –§–ê–ó–ê 2: –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ç–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –≤ rtree
            // ================================================================
            logStep('–§–ê–ó–ê 2', 'phase', '–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ç–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è vad:executor_test –≤ vad:rtree');

            const phase2InsertQuery = `${prefixLines}

INSERT DATA {
    GRAPH vad:rtree {
        vad:executor_test rdf:type vad:TypeExecutor .
        vad:executor_test rdfs:label "–¢–µ—Å—Ç–æ–≤—ã–π –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å" .
        vad:executor_test vad:hasParentObj vad:Org-structure .
    }
}`;

            logBlock('–§–∞–∑–∞ 2 - SPARQL INSERT (Simple Triple)', phase2InsertQuery, 'sparql');
            logStep('–®–∞–≥ 2.1', 'passed', 'SPARQL INSERT DATA –∑–∞–ø—Ä–æ—Å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω');

            // –®–∞–≥ 2.2: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ SPARQL INSERT
            logStep('–®–∞–≥ 2.2', 'running', '–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ INSERT –∫–∞–∫ Simple Triple...');
            try {
                const quadsBefore = currentQuads.length;
                await applySimpleTriple(phase2InsertQuery);
                const quadsAfter = currentQuads.length;
                logStep('–®–∞–≥ 2.2', 'passed', `–î–æ–±–∞–≤–ª–µ–Ω–æ ${quadsAfter - quadsBefore} –∫–≤–∞–¥–æ–≤. –í—Å–µ–≥–æ: ${quadsAfter}`);
            } catch (error) {
                logStep('–®–∞–≥ 2.2', 'failed', `–û—à–∏–±–∫–∞: ${error.message}`);
                showSummary();
                return;
            }

            // –®–∞–≥ 2.3: –í—ã–≤–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ rtree
            const rtreeContentAfterInsert = getGraphContent(
                'http://example.org/vad#rtree',
                currentQuads,
                currentPrefixes
            );
            logBlock('–§–∞–∑–∞ 2 - –°–æ–¥–µ—Ä–∂–∏–º–æ–µ vad:rtree –ø–æ—Å–ª–µ INSERT', rtreeContentAfterInsert, 'data');

            // –®–∞–≥ 2.4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∫–æ–Ω—Ü–µ–ø—Ç–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
            const foundExecutor = currentStore.getQuads(
                N3.DataFactory.namedNode('http://example.org/vad#executor_test'),
                N3.DataFactory.namedNode('http://www.w3.org/2000/01/rdf-schema#label'),
                null,
                N3.DataFactory.namedNode('http://example.org/vad#rtree')
            );

            if (foundExecutor.length > 0) {
                logStep('–®–∞–≥ 2.3', 'passed', `–ö–æ–Ω—Ü–µ–ø—Ç vad:executor_test –Ω–∞–π–¥–µ–Ω –≤ rtree. Label: "${foundExecutor[0].object.value}"`);
            } else {
                logStep('–®–∞–≥ 2.3', 'failed', '–ö–æ–Ω—Ü–µ–ø—Ç vad:executor_test –ù–ï –Ω–∞–π–¥–µ–Ω –≤ rtree');
                showSummary();
                return;
            }

            // ================================================================
            // –§–ê–ó–ê 3: –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ç–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏–∑ ptree
            // ================================================================
            logStep('–§–ê–ó–ê 3', 'phase', '–£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ç–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ vad:process_test –∏–∑ vad:ptree');

            const phase3DeleteQuery = `${prefixLines}

DELETE WHERE {
    GRAPH vad:ptree {
        vad:process_test ?p ?o .
    }
}`;

            logBlock('–§–∞–∑–∞ 3 - SPARQL DELETE WHERE (Simple Triple)', phase3DeleteQuery, 'sparql');
            logStep('–®–∞–≥ 3.1', 'passed', 'SPARQL DELETE WHERE –∑–∞–ø—Ä–æ—Å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω');

            // –®–∞–≥ 3.2: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ SPARQL DELETE
            logStep('–®–∞–≥ 3.2', 'running', '–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ DELETE –∫–∞–∫ Simple Triple...');
            try {
                const quadsBefore = currentQuads.length;
                await applySimpleTriple(phase3DeleteQuery);
                const quadsAfter = currentQuads.length;
                logStep('–®–∞–≥ 3.2', 'passed', `–£–¥–∞–ª–µ–Ω–æ ${quadsBefore - quadsAfter} –∫–≤–∞–¥–æ–≤. –í—Å–µ–≥–æ: ${quadsAfter}`);
            } catch (error) {
                logStep('–®–∞–≥ 3.2', 'failed', `–û—à–∏–±–∫–∞: ${error.message}`);
                showSummary();
                return;
            }

            // –®–∞–≥ 3.3: –í—ã–≤–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ ptree –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
            const ptreeContentAfterDelete = getGraphContent(
                'http://example.org/vad#ptree',
                currentQuads,
                currentPrefixes
            );
            logBlock('–§–∞–∑–∞ 3 - –°–æ–¥–µ—Ä–∂–∏–º–æ–µ vad:ptree –ø–æ—Å–ª–µ DELETE', ptreeContentAfterDelete, 'data');

            // –®–∞–≥ 3.4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∫–æ–Ω—Ü–µ–ø—Ç–∞
            const remainingProcess = currentStore.getQuads(
                N3.DataFactory.namedNode('http://example.org/vad#process_test'),
                null, null,
                N3.DataFactory.namedNode('http://example.org/vad#ptree')
            );

            if (remainingProcess.length === 0) {
                logStep('–®–∞–≥ 3.3', 'passed', '–ö–æ–Ω—Ü–µ–ø—Ç vad:process_test —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω –∏–∑ ptree');
            } else {
                logStep('–®–∞–≥ 3.3', 'failed', `–ö–æ–Ω—Ü–µ–ø—Ç vad:process_test –≤—Å—ë –µ—â—ë –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ ptree: ${remainingProcess.length} –∫–≤–∞–¥–æ–≤`);
                showSummary();
                return;
            }

            // ================================================================
            // –§–ê–ó–ê 4: –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ç–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –∏–∑ rtree
            // ================================================================
            logStep('–§–ê–ó–ê 4', 'phase', '–£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ü–µ–ø—Ç–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è vad:executor_test –∏–∑ vad:rtree');

            const phase4DeleteQuery = `${prefixLines}

DELETE WHERE {
    GRAPH vad:rtree {
        vad:executor_test ?p ?o .
    }
}`;

            logBlock('–§–∞–∑–∞ 4 - SPARQL DELETE WHERE (Simple Triple)', phase4DeleteQuery, 'sparql');
            logStep('–®–∞–≥ 4.1', 'passed', 'SPARQL DELETE WHERE –∑–∞–ø—Ä–æ—Å —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω');

            // –®–∞–≥ 4.2: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ SPARQL DELETE
            logStep('–®–∞–≥ 4.2', 'running', '–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ DELETE –∫–∞–∫ Simple Triple...');
            try {
                const quadsBefore = currentQuads.length;
                await applySimpleTriple(phase4DeleteQuery);
                const quadsAfter = currentQuads.length;
                logStep('–®–∞–≥ 4.2', 'passed', `–£–¥–∞–ª–µ–Ω–æ ${quadsBefore - quadsAfter} –∫–≤–∞–¥–æ–≤. –í—Å–µ–≥–æ: ${quadsAfter}`);
            } catch (error) {
                logStep('–®–∞–≥ 4.2', 'failed', `–û—à–∏–±–∫–∞: ${error.message}`);
                showSummary();
                return;
            }

            // –®–∞–≥ 4.3: –í—ã–≤–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ rtree –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
            const rtreeContentAfterDelete = getGraphContent(
                'http://example.org/vad#rtree',
                currentQuads,
                currentPrefixes
            );
            logBlock('–§–∞–∑–∞ 4 - –°–æ–¥–µ—Ä–∂–∏–º–æ–µ vad:rtree –ø–æ—Å–ª–µ DELETE', rtreeContentAfterDelete, 'data');

            // –®–∞–≥ 4.4: –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∫–æ–Ω—Ü–µ–ø—Ç–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è
            const remainingExecutor = currentStore.getQuads(
                N3.DataFactory.namedNode('http://example.org/vad#executor_test'),
                null, null,
                N3.DataFactory.namedNode('http://example.org/vad#rtree')
            );

            if (remainingExecutor.length === 0) {
                logStep('–®–∞–≥ 4.3', 'passed', '–ö–æ–Ω—Ü–µ–ø—Ç vad:executor_test —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª—ë–Ω –∏–∑ rtree');
            } else {
                logStep('–®–∞–≥ 4.3', 'failed', `–ö–æ–Ω—Ü–µ–ø—Ç vad:executor_test –≤—Å—ë –µ—â—ë –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ rtree: ${remainingExecutor.length} –∫–≤–∞–¥–æ–≤`);
            }

            showSummary();
        }

        // –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            runTest();
        });
    </script>
</body>
</html>
