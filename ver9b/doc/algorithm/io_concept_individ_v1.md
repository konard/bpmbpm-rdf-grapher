<!-- Ссылка на issue: https://github.com/bpmbpm/rdf-grapher/issues/248 -->

# Алгоритмы создания и удаления концептов и индивидов

В данном документе описаны алгоритмы CRUD-операций над основными сущностями системы:
1. Концепт процесса (TypeProcess) — хранится в `vad:ptree`
2. Концепт исполнителя (TypeExecutor) — хранится в `vad:rtree`
3. Схема процесса (VADProcessDia) — именованный граф TriG
4. Индивид процесса — экземпляр концепта в конкретной схеме процесса

---

## 1. Создание и удаление концепта процесса

### 1.1 Создание концепта процесса

**Модуль:** `3_sd/3_sd_create_new_concept/3_sd_create_new_concept_logic.js`

#### Алгоритм

1. Пользователь нажимает кнопку "New Concept" → вызывается `openNewConceptModal()`
2. Пользователь выбирает тип `vad:TypeProcess`
3. Загружаются предикаты из технологического дерева:
   - `getPredicatesForNewConcept(techObjectUri, config)` — SPARQL-запрос к techtree
   - Если techtree недоступен, используются `fallbackPredicates`
4. Строится форма ввода: `buildNewConceptForm(config, predicates, autoPredicates)`
5. Пользователь заполняет поля:
   - `rdfs:label` — название процесса (обязательное)
   - `dcterms:description` — описание
   - `vad:hasParentObj` — родительский объект (выбор из существующих в ptree)
6. При вводе `rdfs:label` автоматически генерируется ID: `generateIdFromLabel(label)`
7. Выполняются **проверки** (см. ниже)
8. Формируются триплеты: `collectFormTriples(config, id)`
9. Генерируется SPARQL INSERT запрос
10. Запрос выводится в панель "Result in SPARQL"

#### Проверки при создании

| № | Проверка | Функция | Описание |
|---|----------|---------|----------|
| 1 | Уникальность ID в ptree | `checkIdExists(fullUri)` | Проверяет, что среди `currentQuads` нет квада с `subject.value === uri` или `object.value === uri`. Если ID уже существует — создание блокируется |
| 2 | Допустимость символов в ID | `generateIdFromLabel(label)` | Regex `[^a-zA-Zа-яА-ЯёЁ0-9_.\-]` удаляет недопустимые символы. Пробелы заменяются на `_` |
| 3 | Непустое значение rdfs:label | Проверка формы | Название процесса обязательно для заполнения |
| 4 | Выбор родительского объекта | `getObjectsForParentSelector(typeUri, graphUri)` | Родитель должен быть выбран из существующих объектов в ptree |

#### Допустимые символы в ID

- Латинские буквы: `a-z`, `A-Z`
- Кириллические буквы: `а-я`, `А-Я`, `ё`, `Ё`
- Цифры: `0-9`
- Специальные символы: `_` (подчёркивание), `.` (точка), `-` (дефис)
- **Недопустимы:** пробел, `! @ # $ % ^ & * ( ) [ ] { } < > ; : ' " \ | / ? + = ~` и прочие спецсимволы

#### Основные вызываемые функции

| Функция | Модуль | Аргументы | Возвращает |
|---------|--------|-----------|------------|
| `openNewConceptModal()` | `3_sd_create_new_concept_logic.js` | — | `void` (открывает модальное окно) |
| `getPredicatesForNewConcept(techObjectUri, config)` | `3_sd_create_new_concept_logic.js` | URI технологического объекта, конфигурация типа | `Array<{uri, prefixed}>` — список предикатов |
| `buildNewConceptForm(config, predicates, autoPredicates)` | `3_sd_create_new_concept_logic.js` | конфигурация, предикаты, автогенерируемые предикаты | `void` (строит DOM-форму) |
| `generateIdFromLabel(label)` | `3_sd_create_new_concept_logic.js` | `string` — текст метки | `string` — сгенерированный ID |
| `checkIdExists(uri)` | `3_sd_create_new_concept_logic.js` | `string` — полный URI | `boolean` — true если ID уже существует |
| `collectFormTriples(config, id)` | `3_sd_create_new_concept_logic.js` | конфигурация, ID | `Array<{subject, predicate, object}>` — триплеты |
| `createNewConceptSparql()` | `3_sd_create_new_concept_logic.js` | — | `void` (генерирует SPARQL INSERT в панель) |
| `sanitizeConceptId(id)` | `3_sd_create_new_concept_logic.js` | `string` — ID с возможным префиксом | `string` — очищенный ID |
| `funSPARQLvalues(sparqlQuery, variableName)` | `9_vadlib/vadlib_sparql.js` | SPARQL-запрос, имя переменной | `Array<{uri, label}>` — результаты |

#### Конфигурация типа TypeProcess

```javascript
{
    techObject: 'http://example.org/vad#ConceptProcessPredicate',
    targetGraph: 'vad:ptree',
    displayName: 'Концепт процесса (vad:TypeProcess)',
    typeValue: 'vad:TypeProcess',
    autoPredicates: ['rdf:type'],
    readOnlyPredicates: ['vad:hasTrig'],
    parentSelectorType: 'vad:TypeProcess',
    parentSelectorGraph: 'vad:ptree'
}
```

#### Генерируемый SPARQL

```sparql
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX dcterms: <http://purl.org/dc/terms/>
PREFIX vad: <http://example.org/vad#>

INSERT DATA {
    GRAPH vad:ptree {
        vad:p_new rdf:type vad:TypeProcess .
        vad:p_new rdfs:label "Новый процесс" .
        vad:p_new dcterms:description "Описание нового процесса" .
        vad:p_new vad:hasParentObj vad:ptree .
    }
}
```

---

### 1.2 Удаление концепта процесса

**Модуль:** `3_sd/3_sd_del_concept_individ/3_sd_del_concept_individ_logic.js`

**Тип операции:** `DEL_OPERATION_TYPES.CONCEPT_PROCESS`

#### Алгоритм

1. Пользователь нажимает "Del Concept\Individ"
2. Выбирает тип операции: "Концепт процесса"
3. Загружается список концептов процессов из ptree (SPARQL-запрос `GET_PROCESS_CONCEPTS`)
4. Пользователь выбирает концепт для удаления
5. Выполняются **предварительные проверки** (см. ниже)
6. Результаты проверок отображаются пользователю
7. Генерируется SPARQL DELETE запрос
8. Запрос выводится в панель "Result in SPARQL"

#### Предварительные проверки перед удалением

| № | Проверка | SPARQL-запрос | Описание |
|---|----------|---------------|----------|
| 1 | Наличие индивидов | `CHECK_PROCESS_INDIVIDUALS` | Проверяет, есть ли индивиды (экземпляры) данного концепта в схемах процессов. Если есть — выводится предупреждение: сначала необходимо удалить индивидов |
| 2 | Наличие схемы процесса | `CHECK_PROCESS_SCHEMA` | Проверяет, привязана ли к концепту схема (`vad:hasTrig`). Если привязана — выводится предупреждение: сначала необходимо удалить схему |
| 3 | Наличие дочерних концептов | `CHECK_PROCESS_CHILDREN` | Проверяет, существуют ли процессы, у которых `vad:hasParentObj` указывает на удаляемый концепт. Если есть — выводится предупреждение: сначала необходимо переназначить или удалить дочерние концепты |

#### Порядок удаления зависимых объектов

При наличии зависимостей удаление выполняется в строгом порядке:
1. Удалить индивидов из всех схем процессов
2. Удалить схему процесса (TriG)
3. Переназначить/удалить дочерние концепты
4. Удалить сам концепт из ptree

---

## 2. Создание и удаление концепта исполнителя

### 2.1 Создание концепта исполнителя

**Модуль:** `3_sd/3_sd_create_new_concept/3_sd_create_new_concept_logic.js`

#### Алгоритм

1. Пользователь нажимает "New Concept" → вызывается `openNewConceptModal()`
2. Пользователь выбирает тип `vad:TypeExecutor`
3. Загружаются предикаты для исполнителя из techtree
4. Строится форма ввода с полями:
   - `rdfs:label` — название исполнителя (обязательное)
   - `dcterms:description` — описание
   - `vad:hasParentObj` — родительский объект (организационная единица в rtree)
5. При вводе `rdfs:label` автоматически генерируется ID: `generateIdFromLabel(label)`
6. Выполняются проверки (аналогичные проверкам для концепта процесса, но в контексте rtree)
7. Генерируется SPARQL INSERT запрос для графа `vad:rtree`

#### Проверки при создании

| № | Проверка | Функция | Описание |
|---|----------|---------|----------|
| 1 | Уникальность ID в rtree | `checkIdExists(fullUri)` | Проверяет отсутствие объекта с таким же URI в `currentQuads` |
| 2 | Допустимость символов в ID | `generateIdFromLabel(label)` | Те же ограничения, что и для концепта процесса |
| 3 | Непустое значение rdfs:label | Проверка формы | Название исполнителя обязательно |
| 4 | Выбор родительского объекта | `getObjectsForParentSelector(typeUri, graphUri)` | Родитель выбирается из существующих объектов в rtree |

#### Конфигурация типа TypeExecutor

```javascript
{
    techObject: 'http://example.org/vad#ConceptExecutorPredicate',
    targetGraph: 'vad:rtree',
    displayName: 'Концепт исполнителя (vad:TypeExecutor)',
    typeValue: 'vad:TypeExecutor',
    autoPredicates: ['rdf:type'],
    readOnlyPredicates: [],
    parentSelectorType: 'vad:TypeExecutor',
    parentSelectorGraph: 'vad:rtree'
}
```

#### Генерируемый SPARQL

```sparql
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX dcterms: <http://purl.org/dc/terms/>
PREFIX vad: <http://example.org/vad#>

INSERT DATA {
    GRAPH vad:rtree {
        vad:NewExecutor rdf:type vad:TypeExecutor .
        vad:NewExecutor rdfs:label "Новый исполнитель" .
        vad:NewExecutor vad:hasParentObj vad:Org-structure .
    }
}
```

---

### 2.2 Удаление концепта исполнителя

**Модуль:** `3_sd/3_sd_del_concept_individ/3_sd_del_concept_individ_logic.js`

**Тип операции:** `DEL_OPERATION_TYPES.CONCEPT_EXECUTOR`

#### Алгоритм

1. Пользователь выбирает тип операции: "Концепт исполнителя"
2. Загружается список исполнителей из rtree (SPARQL-запрос `GET_EXECUTOR_CONCEPTS`)
3. Пользователь выбирает исполнителя для удаления
4. Выполняются **предварительные проверки**
5. Генерируется SPARQL DELETE запрос

#### Предварительные проверки перед удалением

| № | Проверка | SPARQL-запрос | Описание |
|---|----------|---------------|----------|
| 1 | Использование в схемах процессов | `CHECK_EXECUTOR_USAGE` | Проверяет, включён ли исполнитель (`vad:includes`) в группы исполнителей (`vad:ExecutorGroup`) в каких-либо схемах процессов. Если используется — выводится список TriG, где исполнитель задействован |

#### Порядок удаления зависимых объектов

1. Удалить ссылки на исполнителя из групп исполнителей во всех схемах
2. Удалить сам концепт исполнителя из rtree

---

## 3. Создание и удаление схемы процесса

### 3.1 Создание схемы процесса (TriG)

**Модуль:** `3_sd/3_sd_create_new_trig/3_sd_create_new_trig_logic.js`

#### Алгоритм

1. Пользователь нажимает кнопку создания нового TriG
2. Выбирает концепт процесса из ptree (для которого создаётся схема)
3. Функция `createNewTrig()` выполняет:
   - Автогенерация ID схемы: `t_{processId}` (например, `t_p1` для процесса `p1`)
   - Автогенерация метки: `"Схема t_{processId} процесса {processId}"`
4. Выполняются **проверки**
5. Генерируется SPARQL INSERT запрос, который:
   - Создаёт метаданные TriG (тип, метка)
   - Добавляет связь `vad:hasTrig` в ptree
   - Создаёт пустой именованный граф

#### Проверки при создании

| № | Проверка | Описание |
|---|----------|----------|
| 1 | Концепт процесса существует в ptree | Процесс, для которого создаётся схема, должен существовать |
| 2 | У концепта ещё нет схемы | Проверка отсутствия предиката `vad:hasTrig` у выбранного концепта. Каждый концепт может иметь не более одной схемы |
| 3 | Уникальность ID схемы | URI нового TriG (`vad:t_{processId}`) не должен существовать в данных |

#### Основные вызываемые функции

| Функция | Модуль | Аргументы | Возвращает |
|---------|--------|-----------|------------|
| `createNewTrig()` | `3_sd_create_new_trig_logic.js` | — | `void` (генерирует SPARQL INSERT в панель) |
| `funSPARQLvalues(sparqlQuery, variableName)` | `9_vadlib/vadlib_sparql.js` | SPARQL-запрос, имя переменной | `Array<{uri, label}>` — список процессов |

#### Генерируемый SPARQL

```sparql
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX vad: <http://example.org/vad#>

INSERT DATA {
    vad:t_p1 rdf:type vad:VADProcessDia .
    vad:t_p1 rdfs:label "Схема t_p1 процесса p1" .

    GRAPH vad:ptree {
        vad:p1 vad:hasTrig vad:t_p1 .
    }

    GRAPH vad:t_p1 {
    }
}
```

---

### 3.2 Удаление схемы процесса (TriG)

**Модуль:** `3_sd/3_sd_del_concept_individ/3_sd_del_concept_individ_logic.js`

**Тип операции:** `DEL_OPERATION_TYPES.TRIG_SCHEMA`

#### Алгоритм

1. Пользователь выбирает тип операции: "Схема процесса (TriG)"
2. Загружается список доступных TriG
3. Пользователь выбирает TriG для удаления
4. Выполняются **предварительные проверки**
5. Генерируется SPARQL DELETE запрос, который:
   - Удаляет все триплеты внутри именованного графа
   - Удаляет метаданные TriG (тип, метка)
   - Удаляет связь `vad:hasTrig` из ptree

#### Предварительные проверки перед удалением

| № | Проверка | Описание |
|---|----------|----------|
| 1 | Наличие индивидов в схеме | Проверяет, есть ли процессы с `vad:isSubprocessTrig` в данном TriG. Если есть — предупреждение: все индивиды и связанные с ними данные (группы исполнителей, связи) будут удалены |
| 2 | Наличие дочерних схем | Проверяет, существуют ли TriG с `vad:hasParentObj`, указывающим на удаляемый TriG. Если есть — предупреждение: дочерние схемы станут "осиротевшими" |

#### Порядок удаления

1. Удалить все индивиды и их связи внутри TriG
2. Удалить все группы исполнителей внутри TriG
3. Удалить связь `vad:hasTrig` из ptree
4. Удалить метаданные TriG
5. Удалить именованный граф

---

## 4. Создание и удаление индивида процесса

### 4.1 Создание индивида процесса

Индивид процесса — это экземпляр концепта из ptree, размещённый в конкретной схеме процесса (VADProcessDia). Один концепт может быть представлен индивидами в нескольких схемах.

#### Алгоритм

1. Пользователь работает в контексте выбранной схемы процесса (TriG)
2. Выбирает концепт процесса из ptree для добавления в схему
3. Формируются триплеты индивида:
   - `vad:isSubprocessTrig` — привязка к текущему TriG
   - `vad:hasExecutor` — ссылка на группу исполнителей (опционально)
   - `vad:hasNext` — следующий процесс в цепочке (опционально)
4. Автоматически создаётся группа исполнителей `vad:ExecutorGroup_{processId}`
5. Генерируется SPARQL INSERT запрос

#### Проверки при создании

| № | Проверка | Описание |
|---|----------|----------|
| 1 | Концепт существует в ptree | Процесс-концепт должен быть зарегистрирован в ptree |
| 2 | Индивид ещё не добавлен в эту схему | Проверка отсутствия триплета `{processUri} vad:isSubprocessTrig {trigUri}` в данном TriG. Каждый концепт может быть представлен в одной схеме только одним индивидом |
| 3 | Схема процесса (TriG) существует | Целевой TriG должен существовать и иметь тип `vad:VADProcessDia` |

#### Генерируемый SPARQL

```sparql
PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
PREFIX vad: <http://example.org/vad#>

INSERT DATA {
    GRAPH vad:t_p1 {
        vad:p1.1 vad:isSubprocessTrig vad:t_p1 .
        vad:p1.1 vad:hasExecutor vad:ExecutorGroup_p1.1 .

        vad:ExecutorGroup_p1.1 rdf:type vad:ExecutorGroup .
        vad:ExecutorGroup_p1.1 rdfs:label "Группа исполнителей процесса p1.1" .
    }
}
```

---

### 4.2 Удаление индивида процесса

**Модуль:** `3_sd/3_sd_del_concept_individ/3_sd_del_concept_individ_logic.js`

**Тип операции:** `DEL_OPERATION_TYPES.INDIVID_PROCESS`

#### Алгоритм

1. Пользователь выбирает тип операции: "Индивид процесса"
2. Выбирает TriG (схему процесса)
3. Загружается список индивидов в данном TriG
4. Пользователь выбирает индивида для удаления
5. Выполняются **предварительные проверки**
6. Генерируется SPARQL DELETE запрос

#### Предварительные проверки перед удалением

| № | Проверка | Описание |
|---|----------|----------|
| 1 | Наличие входящих связей `vad:hasNext` | Проверяет, есть ли другие процессы, у которых `vad:hasNext` указывает на удаляемый индивид. Если есть — предупреждение: связи станут "висячими" |
| 2 | Наличие группы исполнителей | Проверяет, есть ли `vad:ExecutorGroup_{processId}`. Если есть — группа будет удалена вместе с индивидом |

#### Порядок удаления

1. Удалить связи `vad:hasNext`, ссылающиеся на удаляемый индивид
2. Удалить группу исполнителей (`vad:ExecutorGroup_{processId}`) и все её связи
3. Удалить все триплеты индивида в данном TriG (`vad:isSubprocessTrig`, `vad:hasExecutor`, `vad:hasNext` и др.)

---

## 5. Сводная таблица проблем (коллизий) и способов их предотвращения

| № | Проблема | Сущность | Последствия | Предотвращение / Устранение |
|---|----------|----------|-------------|----------------------------|
| 1 | **Дублирование ID** | Все | Коллизия URI — два объекта с одним идентификатором, невозможность различить сущности | Проверка `checkIdExists(uri)` перед созданием. Генерация уникального ID из метки через `generateIdFromLabel()` |
| 2 | **Недопустимые символы в ID** | Все | Ошибки парсинга RDF/TriG, невалидный URI, некорректная работа SPARQL-запросов | Фильтрация символов regex `[^a-zA-Zа-яА-ЯёЁ0-9_.\-]`, замена пробелов на `_` |
| 3 | **Удаление концепта с дочерними концептами** | Концепт процесса | Дочерние концепты теряют родителя (`vad:hasParentObj` указывает на несуществующий объект), нарушение иерархии в ptree | Проверка `CHECK_PROCESS_CHILDREN` перед удалением. Требование: переназначить `vad:hasParentObj` дочерних концептов или удалить их до удаления родительского |
| 4 | **Удаление концепта с привязанной схемой** | Концепт процесса | Схема процесса (`VADProcessDia`) становится "осиротевшей" — привязана к несуществующему концепту | Проверка `CHECK_PROCESS_SCHEMA` перед удалением. Требование: удалить схему до удаления концепта |
| 5 | **Удаление концепта с индивидами в схемах** | Концепт процесса | Индивиды ссылаются на несуществующий концепт, нарушение целостности данных в схемах | Проверка `CHECK_PROCESS_INDIVIDUALS` перед удалением. Требование: удалить индивидов из всех схем до удаления концепта |
| 6 | **Удаление исполнителя, используемого в схемах** | Концепт исполнителя | Группы исполнителей (`ExecutorGroup`) содержат ссылку `vad:includes` на несуществующего исполнителя | Проверка `CHECK_EXECUTOR_USAGE` перед удалением. Требование: удалить ссылки на исполнителя из всех групп |
| 7 | **Удаление схемы с дочерними схемами** | Схема процесса (TriG) | Дочерние TriG-схемы теряют родителя (`vad:hasParentObj` указывает на несуществующий граф) | Проверка наличия дочерних TriG перед удалением. Требование: переназначить или удалить дочерние схемы |
| 8 | **Удаление индивида со входящими связями** | Индивид процесса | Связи `vad:hasNext` от других процессов указывают на несуществующий индивид, нарушение цепочки процессов | Проверка входящих `vad:hasNext` перед удалением. Автоматическое или ручное удаление "висячих" связей |
| 9 | **Создание схемы для концепта, у которого уже есть схема** | Схема процесса (TriG) | Дублирование связи `vad:hasTrig` — у концепта две детализирующие схемы | Проверка отсутствия `vad:hasTrig` у выбранного концепта. Один концепт — одна схема |
| 10 | **Повторное добавление индивида в ту же схему** | Индивид процесса | Дублирование триплета `vad:isSubprocessTrig`, конфликт данных | Проверка отсутствия `vad:isSubprocessTrig` для данного процесса в данном TriG |
| 11 | **Циклическая ссылка в иерархии концептов** | Концепт процесса | Бесконечный цикл при обходе дерева ptree (A → B → A) | Проверка при назначении `vad:hasParentObj`: объект не может быть своим собственным потомком. Рекомендуется проверять цепочку родителей при каждом изменении |
| 12 | **Несогласованность ptree и TriG данных** | Все | Концепт удалён из ptree, но индивиды остались в TriG; или наоборот — индивид ссылается на несуществующий в ptree концепт | Каскадные проверки при всех операциях удаления. Использование функции `validateVAD()` (модуль `2_triplestore/2_triplestore_validation.js`) для проверки целостности |
| 13 | **ID с пустым значением** | Все | Невалидный URI вида `vad:` (без локального имени), ошибки парсинга | Проверка `if (!id)` перед построением URI. Функция `sanitizeConceptId(id)` удаляет лишние элементы |
| 14 | **Конфликт автогенерации ID TriG** | Схема процесса (TriG) | ID схемы `t_{processId}` может совпасть с существующим URI, если процесс назван `t_...` | Проверка уникальности сгенерированного URI TriG в `currentQuads` перед созданием |

---

## 6. Общая схема зависимостей между сущностями

```
vad:ptree (ProcessTree)
 └── vad:p1 (TypeProcess — концепт)
      ├── rdfs:label "p1 Процесс 1"
      ├── dcterms:description "Описание"
      ├── vad:hasParentObj vad:ptree
      ├── vad:hasTrig vad:t_p1 ─────────────────┐
      │                                           │
      └── vad:p1.1 (TypeProcess — дочерний)       │
           └── vad:hasParentObj vad:p1             │
                                                   ▼
                                          vad:t_p1 (VADProcessDia — схема)
                                           ├── rdf:type vad:VADProcessDia
                                           ├── rdfs:label "Схема t_p1 ..."
                                           └── содержит индивидов:
                                                ├── vad:p1.1 (индивид)
                                                │    ├── vad:isSubprocessTrig vad:t_p1
                                                │    ├── vad:hasExecutor vad:ExecutorGroup_p1.1
                                                │    └── vad:hasNext vad:p1.2
                                                └── vad:p1.2 (индивид)
                                                     └── vad:isSubprocessTrig vad:t_p1

vad:rtree (ExecutorTree)
 └── vad:Executor1 (TypeExecutor — концепт)
      ├── rdfs:label "Исполнитель 1"
      └── vad:hasParentObj vad:Org-structure
           │
           └── используется в TriG через:
                vad:ExecutorGroup_p1.1 vad:includes vad:Executor1
```

---

## 7. Функция валидации целостности данных

**Модуль:** `2_triplestore/2_triplestore_validation.js`

**Функция:** `validateVAD(quads, prefixes)`

Рекомендуется вызывать после любой CRUD-операции для проверки:
- Все предикаты соответствуют `VAD_ALLOWED_PREDICATES`
- Все типы соответствуют `VAD_ALLOWED_TYPES`
- Нет "висячих" ссылок на несуществующие объекты

| Параметр | Тип | Описание |
|----------|-----|----------|
| `quads` | `Array` | Массив RDF квадов |
| `prefixes` | `Object` | Словарь префиксов |

**Возвращает:** `{valid: boolean, errors: Array<{triple, position, value, message}>}`
