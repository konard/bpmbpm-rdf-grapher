# Форматирование при сериализации N3.js

Ссылка на issue: https://github.com/bpmbpm/rdf-grapher/issues/264 (пункт 4)

## Проблема

Пользователь заметил различия между исходным текстом TriG-файла и его отображением после нажатия кнопки "Показать":

### Исходный формат (Trig_VADv6.ttl):

```turtle
## vad:p1.1.1 в vad:t_p2
    vad:ExecutorGroup_p1.1.1 rdf:type vad:ExecutorGroup ;
        rdfs:label "Группа исполнителей процесса p1.1.1" ;
        vad:includes vad:Executor1, vad:Executor2 .

## pх.х в vad:t_p2
    vad:ExecutorGroup_pх.х rdf:type vad:ExecutorGroup ;
        rdfs:label "Группа исполнителей процесса pх.х" ;
        vad:includes vad:Executor1, vad:Executor2 .
}
```

### После нажатия "Показать":

```turtle
<http://example.org/vad#ExecutorGroup_p1.1.1> a vad:ExecutorGroup;
    rdfs:label "Группа исполнителей процесса p1.1.1";
    vad:includes vad:Executor1, vad:Executor2.

<http://example.org/vad#ExecutorGroup_pх.х> a vad:ExecutorGroup;
    rdfs:label "Группа исполнителей процесса pх.х";
    vad:includes vad:Executor1, vad:Executor2
}
```

### Замеченные различия:

1. **Полный URI вместо prefix** — `<http://example.org/vad#ExecutorGroup_p1.1.1>` вместо `vad:ExecutorGroup_p1.1.1`
2. **`a` вместо `rdf:type`** — стандартное сокращение в Turtle
3. **Пробел перед точкой** — исчезает пробел между объектом и `.`
4. **Последний триплет без точки** — у последнего триплета перед `}` исчезает `.`
5. **Удаление комментариев** — комментарии (`##`) не сохраняются
6. **Удаление пустых строк** — пустые строки между группами триплетов исчезают

---

## Объяснение

Эти различия вызваны поведением библиотеки **N3.js** при парсинге и сериализации:

### 1. Полный URI вместо prefix

**Причина:** N3.Writer по умолчанию сериализует URI с использованием prefixes, но для некоторых URI (особенно содержащих специальные символы, такие как точки в `p1.1.1`) writer может выбрать полный URI.

**Особенность:** URI с точками в локальном имени (`vad:ExecutorGroup_p1.1.1`) могут некорректно сериализоваться как prefixed name, так как точка является специальным символом в Turtle.

**Решение:** Это ограничение библиотеки N3.js. Для URI с точками в локальном имени N3.Writer предпочитает полный формат `<...>`.

### 2. `a` вместо `rdf:type`

**Причина:** Согласно спецификации Turtle, `a` является стандартным синонимом `rdf:type`. N3.Writer использует `a` для компактности.

**Спецификация:** [Turtle 1.1 - Section 2.4](https://www.w3.org/TR/turtle/#sec-iri)

**Решение:** Это стандартное поведение. При необходимости можно написать кастомную функцию сериализации, заменяющую `a` на `rdf:type`.

### 3. Пробел перед точкой

**Причина:** N3.Writer не добавляет пробел между последним объектом и точкой. Это корректный синтаксис Turtle.

**Пример:**
```turtle
# Исходный (с пробелом)
vad:includes vad:Executor1, vad:Executor2 .

# N3.Writer (без пробела)
vad:includes vad:Executor1, vad:Executor2.
```

**Решение:** Оба варианта синтаксически корректны. Пробел перед точкой опционален в спецификации Turtle.

### 4. Последний триплет без точки

**Причина:** Это может быть особенностью N3.Writer при сериализации последнего триплета в группе с `;`. В корректном Turtle последний триплет должен заканчиваться `.`.

**Проверка:** Если это действительно происходит, это может быть багом N3.js. Однако парсер N3.Parser корректно обрабатывает оба варианта.

### 5. Удаление комментариев

**Причина:** N3.Parser **не сохраняет** комментарии при парсинге. Комментарии (`#` и `##`) игнорируются и не попадают в массив квадов.

**Ограничение:** Библиотека N3.js не поддерживает round-trip (сохранение комментариев при парсинге/сериализации).

**Решение:** Если комментарии важны, они должны храниться отдельно от RDF-данных, либо использовать rdfs:comment для хранения комментариев как данных.

### 6. Удаление пустых строк

**Причина:** N3.Writer форматирует вывод по своим правилам, не сохраняя исходное форматирование.

**Решение:** N3.Writer автоматически группирует триплеты по субъекту. Пустые строки добавляются между разными субъектами, но не всегда соответствуют исходному форматированию.

---

## Возможные улучшения

### 1. Принудительное использование prefixes

N3.Writer можно настроить для более агрессивного использования prefixes:

```javascript
const writer = new N3.Writer({
    prefixes: currentPrefixes,
    format: 'application/trig'
});
```

Однако для URI с точками в локальном имени это может не помочь.

### 2. Кастомная сериализация

Для полного контроля над форматом можно реализовать кастомную функцию сериализации:

```javascript
function serializeWithFormat(quads, prefixes, options = {}) {
    const { useRdfType = false, addSpaceBeforeDot = true } = options;

    // Группировка по графам и субъектам
    // Ручное форматирование с нужными опциями
    // ...
}
```

### 3. Формат "Сохранить как"

**Текущее поведение:** При сохранении через "Сохранить как" используется N3.Writer, который применяет свои правила форматирования.

**Рекомендация из issue #264:**
> Можно ли хотя бы выгрузку сделать в более удобном формате?

**Ответ:** Для более "красивого" формата сохранения необходимо реализовать кастомную функцию сериализации с желаемыми опциями форматирования:
- Использование prefixes для всех URI
- `rdf:type` вместо `a`
- Пробел перед `.`
- Пустые строки между субъектами

Это потребует значительной доработки, так как N3.js не поддерживает такие опции "из коробки".

---

## Заключение

Различия в форматировании вызваны особенностями библиотеки N3.js и являются **корректными с точки зрения синтаксиса RDF**. Данные семантически идентичны, только форматирование отличается.

**Приоритет изменений:**
- **Некритично:** Большинство различий (пробелы, `a` vs `rdf:type`, форматирование) не влияют на работу приложения
- **Критично при необходимости round-trip:** Если важно сохранять исходное форматирование и комментарии, требуется значительная переработка механизма сериализации

---

*Документ создан: 2026-02-03*
*Автор: AI Assistant*
*Ссылка на issue: https://github.com/bpmbpm/rdf-grapher/issues/264 (пункт 4)*
